<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WMS å›¾å±‚æ¼”ç¤º - OpenLayers</title>
    
    <!-- OpenLayers CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css">
    
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #409EFF;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }
        
        .controls {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .control-group label {
            font-weight: bold;
            min-width: 80px;
        }
        
        button {
            background: #409EFF;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background: #337ab7;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .basemap-btn {
            background: #6c757d;
            margin-right: 5px;
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .basemap-btn:hover {
            background: #5a6268;
        }
        
        .basemap-btn.active {
            background: #28a745;
        }
        
        .basemap-btn.active:hover {
            background: #218838;
        }
        
        input[type="range"] {
            flex: 1;
            max-width: 200px;
        }
        
        #map {
            height: 600px;
            width: 100%;
        }
        
        .info-panel {
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }
        
        .info-panel h3 {
            margin-top: 0;
            color: #333;
        }
        
        .info-item {
            margin-bottom: 8px;
            padding: 5px 0;
        }
        
        .info-label {
            font-weight: bold;
            color: #666;
            display: inline-block;
            width: 120px;
        }
        
        .wms-url {
            word-break: break-all;
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin-top: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        /* OpenLayers popup æ ·å¼ */
        .ol-popup {
            position: absolute;
            background-color: white;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #cccccc;
            bottom: 12px;
            left: -50px;
            min-width: 280px;
        }

        .ol-popup:after, .ol-popup:before {
            top: 100%;
            border: solid transparent;
            content: " ";
            height: 0;
            width: 0;
            position: absolute;
            pointer-events: none;
        }

        .ol-popup:after {
            border-top-color: white;
            border-width: 10px;
            left: 48px;
            margin-left: -10px;
        }

        .ol-popup:before {
            border-top-color: #cccccc;
            border-width: 11px;
            left: 48px;
            margin-left: -11px;
        }

        .ol-popup-closer {
            text-decoration: none;
            position: absolute;
            top: 2px;
            right: 8px;
        }

        .ol-popup-closer:after {
            content: "âœ–";
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ—ºï¸ WMS å›¾å±‚æ¼”ç¤º</h1>
            <p>ä½¿ç”¨ OpenLayers åŠ è½½ GeoServer WMS æœåŠ¡</p>
            <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 12px;">
                <strong>âš ï¸ é‡è¦æç¤ºï¼š</strong> ä¸ºé¿å…CORSè·¨åŸŸé—®é¢˜ï¼Œè¯·é€šè¿‡HTTPæœåŠ¡å™¨è®¿é—®æ­¤é¡µé¢ï¼Œè€Œä¸æ˜¯ç›´æ¥åŒå‡»æ‰“å¼€æ–‡ä»¶ã€‚<br>
                <strong>è§£å†³æ–¹æ¡ˆï¼š</strong> ä½¿ç”¨ <code>python -m http.server 8000</code> æˆ–å…¶ä»–æœ¬åœ°æœåŠ¡å™¨åœ¨é¡¹ç›®æ ¹ç›®å½•å¯åŠ¨HTTPæœåŠ¡
            </div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label>é€æ˜åº¦:</label>
                <input type="range" id="opacitySlider" min="0" max="100" value="100">
                <span id="opacityValue">100%</span>
            </div>
            <div class="control-group">
                <label>åº•å›¾:</label>
                <button id="osmButton" class="basemap-btn active">OpenStreetMap</button>
                <button id="gaodeButton" class="basemap-btn">é«˜å¾·åœ°å›¾</button>
                <button id="gaodeSatelliteButton" class="basemap-btn">é«˜å¾·å«æ˜Ÿåœ°å›¾</button>
                <button id="osmButton2" class="basemap-btn">OpenStreetMap 2</button>
            </div>
            <div class="control-group">
                <button id="toggleLayer">éšè—å›¾å±‚</button>
                <button id="fitBounds">ç¼©æ”¾åˆ°å›¾å±‚</button>
                <button id="refreshLayer">åˆ·æ–°å›¾å±‚</button>
                <button id="getFeatureInfo">å¯ç”¨è¦ç´ æŸ¥è¯¢</button>
                <button id="debugMode">è°ƒè¯•æ¨¡å¼</button>
            </div>
        </div>
        
        <div id="statusMessage"></div>
        
        <div id="map"></div>

        <!-- OpenLayers å¼¹çª— -->
        <div id="popup" class="ol-popup">
            <a href="#" id="popup-closer" class="ol-popup-closer"></a>
            <div id="popup-content"></div>
        </div>
        
        <div class="info-panel">
            <h3>ğŸ“‹ æœåŠ¡ä¿¡æ¯</h3>
            <div class="info-item">
                <span class="info-label">æœåŠ¡ç±»å‹:</span>
                <span>WMS (Web Map Service)</span>
            </div>
            <div class="info-item">
                <span class="info-label">æœåŠ¡ç‰ˆæœ¬:</span>
                <span id="serviceVersion">1.1.0</span>
            </div>
            <div class="info-item">
                <span class="info-label">æœåŠ¡åœ°å€:</span>
                <span id="serviceUrl">http://localhost:8083/geoserver/shpservice/wms</span>
            </div>
            <div class="info-item">
                <span class="info-label">åæ ‡ç³»:</span>
                <span id="coordinateSystem">EPSG:2379</span>
            </div>
            <div class="info-item">
                <span class="info-label">å›¾å±‚è¾¹ç•Œ:</span>
                <span id="layerBounds">547391.66, 3104446.54, 553301.37, 3118005.75</span>
            </div>
            <div class="info-item">
                <span class="info-label">å½“å‰ç¼©æ”¾:</span>
                <span id="zoomLevel">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">åœ°å›¾ä¸­å¿ƒ:</span>
                <span id="mapCenter">-</span>
            </div>
            
            <div class="wms-url">
                <strong>GetCapabilities URL:</strong><br>
                <span id="capabilitiesUrl">http://localhost:8083/geoserver/shpservice/wms?service=WMS&version=1.1.0&request=GetCapabilities</span>
            </div>

            <div id="debugInfo" class="debug-info" style="display: none;">
                <strong>è°ƒè¯•ä¿¡æ¯:</strong><br>
                <div id="debugLog"></div>
            </div>
        </div>
    </div>

    <!-- OpenLayers JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/proj4@2.15.0/dist/proj4.js"></script>

    <script>
        // å®šä¹‰ EPSG:2379 æŠ•å½± - Xian 1980 / 3-degree Gauss-Kruger CM 102E
        proj4.defs('EPSG:2379', '+proj=tmerc +lat_0=0 +lon_0=102 +k=1 +x_0=500000 +y_0=0 +ellps=IAU76 +towgs84=24,-123,-94,0,0,0,0 +units=m +no_defs +type=crs');
        ol.proj.proj4.register(proj4);
        
        // è·å–æŠ•å½±å®šä¹‰å¹¶è®¾ç½®èŒƒå›´
        const proj2379 = ol.proj.get('EPSG:2379');
        if (proj2379) {
            // è®¾ç½®EPSG:2379çš„æœ‰æ•ˆèŒƒå›´ï¼ˆåŸºäºä¸­å›½100Â°30'Eåˆ°103Â°30'EåŒºåŸŸï¼‰
            proj2379.setExtent([100000, 2800000, 900000, 5400000]);
        }

        // è°ƒè¯•æ¨¡å¼æ ‡å¿—
        let debugMode = false;
        let debugLog = [];

        // æ·»åŠ è°ƒè¯•æ—¥å¿—å‡½æ•°
        function addDebugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            debugLog.push(logMessage);
            console.log(logMessage);
            
            if (debugMode) {
                const debugElement = document.getElementById('debugLog');
                if (debugElement) {
                    debugElement.innerHTML = debugLog.slice(-10).join('<br>'); // åªæ˜¾ç¤ºæœ€æ–°10æ¡
                }
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type = 'info') {
            const statusElement = document.getElementById('statusMessage');
            statusElement.innerHTML = `<div class="${type}">${message}</div>`;
            
            // 3ç§’åæ¸…é™¤æ¶ˆæ¯
            setTimeout(() => {
                statusElement.innerHTML = '';
            }, 3000);
        }

        addDebugLog('ğŸš€ å¼€å§‹åˆå§‹åŒ– OpenLayers åœ°å›¾');

        // WMS å›¾å±‚é…ç½®
        const wmsUrl = 'http://localhost:8083/geoserver/shpservice/wms';
        const layerName = 'shpservice:1ffacf547ad3412294922d8758a89c2c_store';
        
        // ä»GeoServeré¢„è§ˆé“¾æ¥è·å–çš„å›¾å±‚è¾¹ç•Œæ¡† (EPSG:2379åæ ‡ç³»)
        const layerBounds = [547391.6557926689, 3104446.539692845, 553301.3710274147, 3118005.745208093];
        
        addDebugLog(`ğŸŒ WMS URL: ${wmsUrl}`);
        addDebugLog(`ğŸ“Œ å›¾å±‚åç§°: ${layerName}`);
        addDebugLog(`ğŸ“ å›¾å±‚è¾¹ç•Œ: ${layerBounds.join(', ')}`);

        // åˆ›å»ºåº•å›¾å›¾å±‚
        const osmLayer = new ol.layer.Tile({
            source: new ol.source.OSM(),
            visible: true
        });

        // é«˜å¾·åœ°å›¾ - ä½¿ç”¨æ™®é€šåœ°å›¾
        const gaodeLayer = new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'https://webrd0{1-4}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}',
                attributions: 'Â© é«˜å¾·åœ°å›¾'
            }),
            visible: false
        });

        // é«˜å¾·å«æ˜Ÿåœ°å›¾
        const gaodeSatelliteLayer = new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'https://webst01.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}',
                attributions: 'Â© é«˜å¾·å«æ˜Ÿ'
            }),
            visible: false
        });

        // OpenStreetMap (ç¬¬äºŒä¸ªå®ä¾‹ï¼Œå¦‚æœéœ€è¦)
        const osmLayer2 = new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'https://{a-c}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                attributions: 'Â© OpenStreetMap contributors'
            }),
            visible: false
        });

        addDebugLog('âœ… åº•å›¾é…ç½®å®Œæˆ - ä½¿ç”¨ OpenStreetMap ä½œä¸ºé»˜è®¤åº•å›¾');

        // åˆ›å»º WMS å›¾å±‚ - ä½¿ç”¨GeoServeré¢„è§ˆé“¾æ¥çš„æ­£ç¡®å‚æ•°
        const wmsLayer = new ol.layer.Tile({
            source: new ol.source.TileWMS({
                url: wmsUrl,
                params: {
                    'LAYERS': layerName,
                    'FORMAT': 'image/png',  // æ”¹ä¸ºimage/pngè€Œä¸æ˜¯application/openlayers
                    'TRANSPARENT': true,
                    'VERSION': '1.1.0',    // æ”¹ä¸º1.1.0
                    'SRS': 'EPSG:2379',    // æ”¹å›EPSG:2379
                    'STYLES': '',
                    'TILED': true
                },
                projection: 'EPSG:2379',   // æ˜ç¡®æŒ‡å®šWMSæºæ•°æ®çš„æŠ•å½±
                serverType: 'geoserver'
            }),
            opacity: 1.0
        });
        
        addDebugLog('ğŸ”§ WMS å›¾å±‚é…ç½®å®Œæˆ - ä½¿ç”¨ EPSG:2379 åæ ‡ç³»å’Œ WMS 1.1.0');

        // åˆ›å»ºå¼¹çª— overlay
        const container = document.getElementById('popup');
        const content = document.getElementById('popup-content');
        const closer = document.getElementById('popup-closer');

        const popup = new ol.Overlay({
            element: container,
            autoPan: {
                animation: {
                    duration: 250,
                },
            },
        });

        // å…³é—­å¼¹çª—äº‹ä»¶
        closer.onclick = function () {
            popup.setPosition(undefined);
            closer.blur();
            return false;
        };

        // åˆå§‹åŒ–åœ°å›¾ - è®¾ç½®åˆé€‚çš„åˆå§‹è§†å›¾
        // å°†å›¾å±‚è¾¹ç•Œä»EPSG:2379è½¬æ¢åˆ°Webå¢¨å¡æ‰˜æŠ•å½±è¿›è¡Œæ˜¾ç¤º
        const layerCenter = [
            (layerBounds[0] + layerBounds[2]) / 2,  // ä¸­å¿ƒX
            (layerBounds[1] + layerBounds[3]) / 2   // ä¸­å¿ƒY
        ];
        
        // å°†EPSG:2379çš„ä¸­å¿ƒç‚¹è½¬æ¢ä¸ºç»çº¬åº¦ï¼Œå†è½¬ä¸ºWebå¢¨å¡æ‰˜
        let centerInWebMercator;
        try {
            // å…ˆè½¬æ¢ä¸ºç»çº¬åº¦
            const centerInLonLat = ol.proj.transform(layerCenter, 'EPSG:2379', 'EPSG:4326');
            // å†è½¬æ¢ä¸ºWebå¢¨å¡æ‰˜
            centerInWebMercator = ol.proj.transform(centerInLonLat, 'EPSG:4326', 'EPSG:3857');
            addDebugLog(`ğŸ“ å›¾å±‚ä¸­å¿ƒç‚¹è½¬æ¢: EPSG:2379 ${layerCenter} -> EPSG:4326 ${centerInLonLat} -> EPSG:3857 ${centerInWebMercator}`);
        } catch (error) {
            addDebugLog(`âš ï¸ åæ ‡è½¬æ¢å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä¸­å¿ƒç‚¹: ${error.message}`);
            centerInWebMercator = ol.proj.transform([102, 32], 'EPSG:4326', 'EPSG:3857'); // 102Â°E, 32Â°N å¤§è‡´ä¸­å¿ƒ
        }
        
        const map = new ol.Map({
            target: 'map',
            layers: [osmLayer, gaodeLayer, gaodeSatelliteLayer, osmLayer2, wmsLayer],
            overlays: [popup],
            view: new ol.View({
                center: centerInWebMercator,
                zoom: 10,  // æé«˜ç¼©æ”¾çº§åˆ«ä»¥ä¾¿çœ‹åˆ°å›¾å±‚ç»†èŠ‚
                projection: 'EPSG:3857'
            })
        });

        addDebugLog('âœ… åœ°å›¾åˆå§‹åŒ–å®Œæˆ');

        // å¢å¼ºçš„ WMS è¿æ¥æµ‹è¯•
        function testWMSConnection() {
            const testUrl = `${wmsUrl}?service=WMS&version=1.1.0&request=GetCapabilities`;
            addDebugLog(`ğŸ” æµ‹è¯• WMS è¿æ¥: ${testUrl}`);
            
            // æ·»åŠ è¶…æ—¶æ§åˆ¶
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10ç§’è¶…æ—¶
            
            fetch(testUrl, { 
                signal: controller.signal,
                mode: 'cors'
            })
                .then(response => {
                    clearTimeout(timeoutId);
                    addDebugLog(`ğŸ“¡ WMS å“åº”çŠ¶æ€: ${response.status}`);
                    if (response.ok) {
                        addDebugLog('âœ… WMS æœåŠ¡è¿æ¥æˆåŠŸ');
                        showStatus('WMS æœåŠ¡è¿æ¥æˆåŠŸï¼', 'success');
                        return response.text();
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                })
                .then(data => {
                    addDebugLog(`ğŸ“„ GetCapabilities å“åº”é•¿åº¦: ${data.length} å­—ç¬¦`);
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„ XML å“åº”
                    if (data.includes('WMS_Capabilities') || data.includes('ServiceException')) {
                        addDebugLog('âœ… æ”¶åˆ°æœ‰æ•ˆçš„ WMS Capabilities æ–‡æ¡£');
                    } else {
                        addDebugLog('âš ï¸ å“åº”æ ¼å¼å¯èƒ½ä¸æ­£ç¡®');
                    }
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        addDebugLog('âŒ WMS è¿æ¥è¶…æ—¶ï¼ˆ10ç§’ï¼‰');
                        showStatus('WMS è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ', 'error');
                    } else {
                        addDebugLog(`âŒ WMS è¿æ¥å¤±è´¥: ${error.message}`);
                        showStatus(`WMS è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                    }
                });
        }

        // æµ‹è¯•è¿æ¥
        testWMSConnection();

        // æ·»åŠ åº•å›¾åˆ‡æ¢åŠŸèƒ½
        function switchBaseLayer(layerName) {
            // éšè—æ‰€æœ‰åº•å›¾
            osmLayer.setVisible(false);
            gaodeLayer.setVisible(false);
            gaodeSatelliteLayer.setVisible(false);
            osmLayer2.setVisible(false);
            
            // æ˜¾ç¤ºé€‰æ‹©çš„åº•å›¾
            switch(layerName) {
                case 'osm':
                    osmLayer.setVisible(true);
                    addDebugLog('ğŸ—ºï¸ åˆ‡æ¢åˆ° OpenStreetMap');
                    break;
                case 'gaode':
                    gaodeLayer.setVisible(true);
                    addDebugLog('ğŸ—ºï¸ åˆ‡æ¢åˆ°é«˜å¾·åœ°å›¾');
                    break;
                case 'gaodeSatellite':
                    gaodeSatelliteLayer.setVisible(true);
                    addDebugLog('ğŸ—ºï¸ åˆ‡æ¢åˆ°é«˜å¾·å«æ˜Ÿåœ°å›¾');
                    break;
                case 'osm2':
                    osmLayer2.setVisible(true);
                    addDebugLog('ğŸ—ºï¸ åˆ‡æ¢åˆ° OpenStreetMap 2');
                    break;
                default:
                    osmLayer.setVisible(true);
                    addDebugLog('ğŸ—ºï¸ é»˜è®¤ä½¿ç”¨ OpenStreetMap');
            }
        }

        // æ§åˆ¶å…ƒç´ 
        const opacitySlider = document.getElementById('opacitySlider');
        const opacityValue = document.getElementById('opacityValue');
        const toggleButton = document.getElementById('toggleLayer');
        const fitBoundsButton = document.getElementById('fitBounds');
        const refreshButton = document.getElementById('refreshLayer');
        const featureInfoButton = document.getElementById('getFeatureInfo');
        const debugButton = document.getElementById('debugMode');
        
        // åº•å›¾åˆ‡æ¢æŒ‰é’®
        const osmButton = document.getElementById('osmButton');
        const gaodeButton = document.getElementById('gaodeButton');
        const gaodeSatelliteButton = document.getElementById('gaodeSatelliteButton');
        const osmButton2 = document.getElementById('osmButton2');
        
        // çŠ¶æ€å˜é‡
        let layerVisible = true;
        let featureInfoEnabled = false;
        
        // åº•å›¾åˆ‡æ¢äº‹ä»¶
        osmButton.addEventListener('click', function() {
            switchBaseLayer('osm');
            updateActiveButton('osm');
        });
        
        gaodeButton.addEventListener('click', function() {
            switchBaseLayer('gaode');
            updateActiveButton('gaode');
        });
        
        gaodeSatelliteButton.addEventListener('click', function() {
            switchBaseLayer('gaodeSatellite');
            updateActiveButton('gaodeSatellite');
        });
        
        osmButton2.addEventListener('click', function() {
            switchBaseLayer('osm2');
            updateActiveButton('osm2');
        });
        
        // æ›´æ–°æ´»è·ƒæŒ‰é’®çŠ¶æ€
        function updateActiveButton(activeLayer) {
            // ç§»é™¤æ‰€æœ‰æ´»è·ƒçŠ¶æ€
            osmButton.classList.remove('active');
            gaodeButton.classList.remove('active');
            gaodeSatelliteButton.classList.remove('active');
            osmButton2.classList.remove('active');
            
            // è®¾ç½®å½“å‰æ´»è·ƒçŠ¶æ€
            switch(activeLayer) {
                case 'osm':
                    osmButton.classList.add('active');
                    break;
                case 'gaode':
                    gaodeButton.classList.add('active');
                    break;
                case 'gaodeSatellite':
                    gaodeSatelliteButton.classList.add('active');
                    break;
                case 'osm2':
                    osmButton2.classList.add('active');
                    break;
            }
        }
        
        // é€æ˜åº¦æ§åˆ¶
        opacitySlider.addEventListener('input', function() {
            const opacity = this.value / 100;
            wmsLayer.setOpacity(opacity);
            opacityValue.textContent = this.value + '%';
            addDebugLog(`ğŸšï¸ é€æ˜åº¦è®¾ç½®ä¸º: ${this.value}%`);
        });
        
        // å›¾å±‚æ˜¾ç¤º/éšè—
        toggleButton.addEventListener('click', function() {
            if (layerVisible) {
                wmsLayer.setVisible(false);
                this.textContent = 'æ˜¾ç¤ºå›¾å±‚';
                layerVisible = false;
                addDebugLog('ğŸ‘ï¸ å›¾å±‚å·²éšè—');
            } else {
                wmsLayer.setVisible(true);
                this.textContent = 'éšè—å›¾å±‚';
                layerVisible = true;
                addDebugLog('ğŸ‘ï¸ å›¾å±‚å·²æ˜¾ç¤º');
            }
        });
        
        // ç¼©æ”¾åˆ°å›¾å±‚èŒƒå›´
        fitBoundsButton.addEventListener('click', function() {
            // å°†EPSG:2379çš„å›¾å±‚è¾¹ç•Œè½¬æ¢ä¸ºWebå¢¨å¡æ‰˜æŠ•å½±
            try {
                // ä½¿ç”¨OpenLayersçš„transformExtentå‡½æ•°è¿›è¡Œè¾¹ç•Œæ¡†è½¬æ¢
                const transformedExtent = ol.proj.transformExtent(
                    layerBounds,        // åŸå§‹è¾¹ç•Œ [minX, minY, maxX, maxY]
                    'EPSG:2379',        // æºåæ ‡ç³»
                    'EPSG:3857'         // ç›®æ ‡åæ ‡ç³»
                );
                
                map.getView().fit(transformedExtent, { 
                    padding: [50, 50, 50, 50],
                    maxZoom: 16,
                    duration: 1000  // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                });
                
                addDebugLog(`ğŸ” ç¼©æ”¾åˆ°å›¾å±‚èŒƒå›´: EPSG:2379 ${layerBounds} -> EPSG:3857 ${transformedExtent}`);
            } catch (error) {
                addDebugLog(`âŒ è¾¹ç•Œæ¡†è½¬æ¢å¤±è´¥: ${error.message}`);
                // ä½¿ç”¨å¤‡ç”¨çš„ä¸­å›½åŒºåŸŸèŒƒå›´
                const fallbackExtent = ol.proj.transformExtent(
                    [100, 30, 105, 35], // å¤§è‡´çš„ç»çº¬åº¦èŒƒå›´
                    'EPSG:4326',
                    'EPSG:3857'
                );
                map.getView().fit(fallbackExtent, { 
                    padding: [20, 20, 20, 20] 
                });
                addDebugLog('ğŸ” ä½¿ç”¨å¤‡ç”¨èŒƒå›´è¿›è¡Œç¼©æ”¾');
            }
        });
        
        // åˆ·æ–°å›¾å±‚
        refreshButton.addEventListener('click', function() {
            addDebugLog('ğŸ”„ å¼€å§‹åˆ·æ–°å›¾å±‚...');
            
            // è·å–å½“å‰é€æ˜åº¦
            const currentOpacity = wmsLayer.getOpacity();
            
            // åˆ›å»ºæ–°çš„ WMS æº - ä½¿ç”¨æ­£ç¡®çš„å‚æ•°
            const newSource = new ol.source.TileWMS({
                url: wmsUrl,
                params: {
                    'LAYERS': layerName,
                    'FORMAT': 'image/png',
                    'TRANSPARENT': true,
                    'VERSION': '1.1.0',    // ä½¿ç”¨æ­£ç¡®çš„ç‰ˆæœ¬
                    'SRS': 'EPSG:2379',    // ä½¿ç”¨æ­£ç¡®çš„åæ ‡ç³»
                    'STYLES': '',
                    'TILED': true,
                    // æ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜
                    '_': Date.now()
                },
                projection: 'EPSG:2379',   // æ˜ç¡®æŒ‡å®šWMSæºæ•°æ®çš„æŠ•å½±
                serverType: 'geoserver'
            });
            
            wmsLayer.setSource(newSource);
            wmsLayer.setOpacity(currentOpacity);
            
            addDebugLog('âœ… å›¾å±‚åˆ·æ–°å®Œæˆ');
            showStatus('å›¾å±‚å·²åˆ·æ–°', 'success');
        });
        
        // è°ƒè¯•æ¨¡å¼åˆ‡æ¢
        debugButton.addEventListener('click', function() {
            debugMode = !debugMode;
            const debugInfo = document.getElementById('debugInfo');
            
            if (debugMode) {
                this.textContent = 'å…³é—­è°ƒè¯•';
                this.style.background = '#28a745';
                debugInfo.style.display = 'block';
                document.getElementById('debugLog').innerHTML = debugLog.slice(-20).join('<br>');
                addDebugLog('ğŸ› è°ƒè¯•æ¨¡å¼å·²å¼€å¯');
            } else {
                this.textContent = 'è°ƒè¯•æ¨¡å¼';
                this.style.background = '#409EFF';
                debugInfo.style.display = 'none';
                addDebugLog('ğŸ› è°ƒè¯•æ¨¡å¼å·²å…³é—­');
            }
        });
        
        // è¦ç´ ä¿¡æ¯æŸ¥è¯¢
        featureInfoButton.addEventListener('click', function() {
            featureInfoEnabled = !featureInfoEnabled;
            if (featureInfoEnabled) {
                this.textContent = 'ç¦ç”¨è¦ç´ æŸ¥è¯¢';
                this.style.background = '#28a745';
                map.getViewport().style.cursor = 'crosshair';
                addDebugLog('ğŸ” è¦ç´ æŸ¥è¯¢å·²å¯ç”¨');
            } else {
                this.textContent = 'å¯ç”¨è¦ç´ æŸ¥è¯¢';
                this.style.background = '#409EFF';
                map.getViewport().style.cursor = '';
                popup.setPosition(undefined);
                addDebugLog('ğŸ” è¦ç´ æŸ¥è¯¢å·²ç¦ç”¨');
            }
        });
        
        // åœ°å›¾ç‚¹å‡»äº‹ä»¶ - GetFeatureInfo
        map.on('singleclick', function(evt) {
            if (!featureInfoEnabled || !layerVisible) return;
            
            const coordinate = evt.coordinate; // Webå¢¨å¡æ‰˜åæ ‡
            const lonlat = ol.proj.transform(coordinate, 'EPSG:3857', 'EPSG:4326');
            
            addDebugLog(`ğŸ–±ï¸ ç‚¹å‡»ä½ç½®: ç»çº¬åº¦ ${lonlat[1].toFixed(4)}, ${lonlat[0].toFixed(4)}`);
            
            const viewResolution = map.getView().getResolution();
            const source = wmsLayer.getSource();
            
            // ä¸ºGetFeatureInfoæ„å»ºæ­£ç¡®çš„å‚æ•°
            const featureInfoUrl = source.getFeatureInfoUrl(
                coordinate,
                viewResolution,
                'EPSG:3857',  // åœ°å›¾è§†å›¾çš„æŠ•å½±
                {
                    'INFO_FORMAT': 'application/json',
                    'FEATURE_COUNT': 5,
                    'QUERY_LAYERS': layerName  // ç¡®ä¿æŸ¥è¯¢å›¾å±‚å‚æ•°æ­£ç¡®
                }
            );
            
            if (featureInfoUrl) {
                addDebugLog(`ğŸŒ GetFeatureInfo URL: ${featureInfoUrl}`);
                
                fetch(featureInfoUrl)
                    .then(response => {
                        addDebugLog(`ğŸ“¡ å“åº”çŠ¶æ€: ${response.status}`);
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        addDebugLog(`ğŸ“„ è¦ç´ ä¿¡æ¯å“åº”: ${JSON.stringify(data)}`);
                        
                        let popupContent = '';
                        if (data.features && data.features.length > 0) {
                            popupContent = '<div><strong>è¦ç´ ä¿¡æ¯:</strong><br>';
                            data.features.forEach((feature, index) => {
                                popupContent += `<br><strong>è¦ç´  ${index + 1}:</strong><br>`;
                                Object.entries(feature.properties).forEach(([key, value]) => {
                                    popupContent += `${key}: ${value}<br>`;
                                });
                            });
                            popupContent += '</div>';
                            
                            addDebugLog(`âœ… æ‰¾åˆ° ${data.features.length} ä¸ªè¦ç´ `);
                        } else {
                            popupContent = 'æ­¤ä½ç½®æ²¡æœ‰è¦ç´ ä¿¡æ¯';
                            addDebugLog('âš ï¸ æ²¡æœ‰æ‰¾åˆ°è¦ç´ ä¿¡æ¯');
                        }
                        
                        content.innerHTML = popupContent;
                        popup.setPosition(coordinate);
                    })
                    .catch(error => {
                        addDebugLog(`âŒ GetFeatureInfo å¤±è´¥: ${error.message}`);
                        content.innerHTML = `è·å–è¦ç´ ä¿¡æ¯å¤±è´¥: ${error.message}`;
                        popup.setPosition(coordinate);
                    });
            }
        });
        
        // æ›´æ–°åœ°å›¾ä¿¡æ¯
        function updateMapInfo() {
            const view = map.getView();
            const zoom = view.getZoom();
            const center = ol.proj.transform(view.getCenter(), 'EPSG:3857', 'EPSG:4326');
            
            document.getElementById('zoomLevel').textContent = zoom.toFixed(2);
            document.getElementById('mapCenter').textContent = 
                `${center[1].toFixed(4)}, ${center[0].toFixed(4)}`;
        }
        
        // ç›‘å¬åœ°å›¾äº‹ä»¶
        map.on('moveend', function() {
            updateMapInfo();
        });
        
        map.getView().on('change:resolution', function() {
            const zoom = map.getView().getZoom();
            addDebugLog(`ğŸ” ç¼©æ”¾çº§åˆ«: ${zoom.toFixed(2)}`);
            updateMapInfo();
        });
        
        // ç›‘å¬ WMS å›¾å±‚äº‹ä»¶ - ç®€åŒ–ç‰ˆæœ¬
        const wmsSource = wmsLayer.getSource();
        
        wmsSource.on('tileloaderror', function(event) {
            addDebugLog('âŒ WMS ç“¦ç‰‡åŠ è½½é”™è¯¯');
            showStatus('âš ï¸ WMS å›¾å±‚åŠ è½½å¤±è´¥ã€‚æç¤ºï¼šè¯·ç¡®ä¿é€šè¿‡HTTPæœåŠ¡å™¨è®¿é—®é¡µé¢è€Œä¸æ˜¯ç›´æ¥æ‰“å¼€æ–‡ä»¶', 'error');
        });

        wmsSource.on('tileloadend', function(event) {
            addDebugLog('âœ… WMS ç“¦ç‰‡åŠ è½½æˆåŠŸ');
            if (!window.wmsFirstLoad) {
                showStatus('WMS å›¾å±‚åŠ è½½æˆåŠŸï¼', 'success');
                window.wmsFirstLoad = true;
            }
        });

        // ç›‘å¬åº•å›¾åŠ è½½äº‹ä»¶
        osmLayer.getSource().on('tileloaderror', function(event) {
            addDebugLog('âŒ OpenStreetMap åº•å›¾åŠ è½½é”™è¯¯');
        });

        osmLayer.getSource().on('tileloadend', function() {
            if (!window.osmFirstLoad) {
                addDebugLog('âœ… OpenStreetMap åº•å›¾åŠ è½½æˆåŠŸ');
                window.osmFirstLoad = true;
            }
        });
        
        // åˆå§‹åŒ–ä¿¡æ¯æ˜¾ç¤º
        updateMapInfo();
        
        addDebugLog('ğŸ‰ é¡µé¢åˆå§‹åŒ–å®Œæˆ');
        
        // åœ¨é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥æœåŠ¡çŠ¶æ€
        setTimeout(() => {
            const capabilitiesUrl = `${wmsUrl}?service=WMS&version=1.1.0&request=GetCapabilities`;
            addDebugLog(`ğŸ” æ£€æŸ¥æœåŠ¡èƒ½åŠ›æ–‡æ¡£: ${capabilitiesUrl}`);
            document.getElementById('capabilitiesUrl').textContent = capabilitiesUrl;
        }, 1000);
    </script>
</body>
</html>