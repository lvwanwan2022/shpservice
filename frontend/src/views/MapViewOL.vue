<template>
  <div class="map-view">
    <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü -->
    <div class="map-content">
      <!-- Â∑¶‰æßÂõæÂ±ÇÈù¢Êùø - Ê°åÈù¢Á´ØÊòæÁ§∫ -->
      <div class="layer-panel desktop-only" :class="{ 'collapsed': layerPanelCollapsed }">
        <div class="panel-content" v-show="!layerPanelCollapsed">
          <div class="panel-header">
            <h3>ÂõæÂ±ÇÁÆ°ÁêÜ</h3>
            <div class="header-right">
              <span class="layer-count">{{ (layersList || []).length }} ‰∏™ÂõæÂ±Ç</span>
              <el-button type="primary" size="small" @click="showAddLayerDialog">
                <i class="el-icon-plus"></i> Ê∑ªÂä†ÂõæÂ±Ç
              </el-button>
              <!-- Èù¢ÊùøÂàáÊç¢ÊåâÈíÆ -->
              <el-button 
                link 
                size="small" 
                @click="toggleLayerPanel"
                class="panel-toggle-btn"
                :title="layerPanelCollapsed ? 'Â±ïÂºÄÈù¢Êùø' : 'Êî∂Ëµ∑Èù¢Êùø'"
              >
                <span class="toggle-icon">{{ layerPanelCollapsed ? '„Äã' : '„Ää' }}</span>
              </el-button>
            </div>
          </div>
          
          <!-- Âú∫ÊôØÈÄâÊã© -->
          <div class="scene-selector">
            <el-select 
              v-model="selectedSceneId" 
              placeholder="ÈÄâÊã©Âú∫ÊôØ" 
              @change="onSceneChange"
              style="width: 100%"
              size="small"
            >
              <el-option
                v-for="scene in sceneList"
                :key="scene.id"
                :label="scene.name"
                :value="scene.id"
              />
            </el-select>
          </div>
          
          <div class="panel-body">
            <!-- Êñ∞ÁöÑÂõæÂ±ÇÂç°ÁâáÂàóË°® -->
            <div class="layer-cards" v-if="layersList && layersList.length > 0">
              <div 
                v-for="(layer, index) in sortedLayersList" 
                :key="layer.id" 
                class="layer-card"
                :class="{ 
                  'active': currentActiveLayer && currentActiveLayer.scene_layer_id === layer.scene_layer_id,
                  'invisible': !layer.visibility,
                  'dragging': draggingLayerId === layer.id
                }"
                draggable="true"
                @click="selectLayer(layer)"
                @dragstart="handleDragStart($event, layer, index)"
                @dragend="handleDragEnd"
                @dragover="handleDragOver($event, index)"
                @drop="handleDrop($event, index)"
              >
                <div class="layer-card-header">
                  <div class="layer-title">
                    <!-- ÂèØËßÅÊÄßÊéßÂà∂checkbox -->
                    <el-checkbox 
                      v-model="layer.visibility" 
                      @change="toggleLayerVisibility(layer)"
                      @click.stop
                    ></el-checkbox>
                    <!-- ÂΩìÂâçÊ¥ªÂä®ÂõæÂ±ÇÊ†áËØÜ -->
                    <i v-if="currentActiveLayer && currentActiveLayer.scene_layer_id === layer.scene_layer_id" 
                       class="el-icon-location active-indicator" 
                       title="ÂΩìÂâçÊ¥ªÂä®ÂõæÂ±Ç"></i>
                    <span class="layer-name">{{ layer.layer_name }}</span>
                  </div>
                  <div class="layer-drag-handle">
                    <i class="el-icon-rank"></i>
                  </div>
                  <div class="layer-actions">
                    <!-- Áº©ÊîæÂà∞ÂõæÂ±ÇËåÉÂõ¥ -->
                    <el-button 
                      link 
                      @click.stop="zoomToLayer(layer)"
                      class="zoom-btn"
                      title="Áº©ÊîæÂà∞ÂõæÂ±ÇËåÉÂõ¥"
                    >
                      <span>
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                          <path d="M15.5 14h-.79l-.28-.27A6.5 6.5 0 1 0 13 15.5l.27.28v.79l5 4.99L19.49 20l-4.99-5zm-6 0A4.5 4.5 0 1 1 14 9.5 4.5 4.5 0 0 1 9.5 14z"/>
                          <path d="M12 10h-2v2H9v-2H7V9h2V7h1v2h2v1z"/>
                        </svg>
                      </span>
                    </el-button>
                    
                    <!-- Ê†∑ÂºèËÆæÁΩÆ -->
                    <el-button 
                      link 
                      @click.stop="showStyleDialog(layer)"
                      class="style-btn"
                      title="Ê†∑ÂºèËÆæÁΩÆ"
                    >
                      <span>
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                          <path d="M12,2A2,2 0 0,1 14,4C14,4.74 13.6,5.39 13,5.73V7H14A7,7 0 0,1 21,14H22A1,1 0 0,1 23,15V18A1,1 0 0,1 22,19H21V20A2,2 0 0,1 19,22H5A2,2 0 0,1 3,20V19H2A1,1 0 0,1 1,18V15A1,1 0 0,1 2,14H3A7,7 0 0,1 10,7H11V5.73C10.4,5.39 10,4.74 10,4A2,2 0 0,1 12,2M7.5,13A2.5,2.5 0 0,0 5,15.5A2.5,2.5 0 0,0 7.5,18A2.5,2.5 0 0,0 10,15.5A2.5,2.5 0 0,0 7.5,13M16.5,13A2.5,2.5 0 0,0 14,15.5A2.5,2.5 0 0,0 16.5,18A2.5,2.5 0 0,0 19,15.5A2.5,2.5 0 0,0 16.5,13Z"/>
                        </svg>
                      </span>
                    </el-button>
                    
                    <!-- Âà†Èô§ÂõæÂ±Ç -->
                    <el-button 
                      link 
                      @click.stop="removeLayer(layer)" 
                      class="remove-btn"
                      title="Âà†Èô§ÂõæÂ±Ç"
                    >
                      <span>
                        <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                          <path d="M9,3V4H4V6H5V19A2,2 0 0,0 7,21H17A2,2 0 0,0 19,19V6H20V4H15V3H9M7,6H17V19H7V6M9,8V17H11V8H9M13,8V17H15V8H13Z"/>
                        </svg>
                      </span>
                    </el-button>
                  </div>
                </div>
                <div class="layer-card-info">
                  <span class="tag">{{ layer.file_type }}</span>
                  <span class="tag">{{ layer.discipline }}</span>
                  <span class="tag">{{ layer.dimension }}</span>
                  <!-- ÊòæÁ§∫ÊúçÂä°Á±ªÂûã -->
                  <span v-if="layer.service_type" class="tag" :class="getServiceTypeClass(layer.service_type)">
                    {{ getServiceTypeText(layer) }}
                  </span>
                  <!-- ÊòæÁ§∫ÂõæÂ±ÇÁä∂ÊÄÅ -->
                  <span class="tag" :class="getLayerStatusClass(layer)">
                    {{ getLayerStatusText(layer) }}
                  </span>
                </div>
                
                <!-- üî• ÈÄèÊòéÂ∫¶ÊéßÂà∂ -->
                <div 
                  class="layer-opacity-control" 
                  @click.stop
                  @mousedown.stop
                  @dragstart.stop="$event.preventDefault()"
                  @drag.stop="$event.preventDefault()"
                >
                  <div class="opacity-row">
                    <i class="el-icon-view opacity-icon"></i>
                    <span class="opacity-text">‰∏çÈÄèÊòéÂ∫¶</span>
                    <el-slider
                      v-model="layer.opacity"
                      :min="0"
                      :max="1"
                      :step="0.1"
                      :show-tooltip="false"
                      size="small"
                      @input="onLayerOpacityChange(layer)"
                      @click.stop
                      @mousedown.stop
                      @dragstart.stop="$event.preventDefault()"
                      class="opacity-slider"
                    />
                    <span class="opacity-value">{{ Math.round((layer.opacity || 1) * 100) }}%</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Á©∫Áä∂ÊÄÅ -->
            <div class="empty-layers" v-else>
              <i class="el-icon-map-location"></i>
              <p>ÂΩìÂâçÂú∫ÊôØÊöÇÊó†ÂõæÂ±Ç</p>
              <el-button type="primary" @click="showAddLayerDialog">Ê∑ªÂä†ÂõæÂ±Ç</el-button>
            </div>
          </div>
        </div>
        
        <!-- Êî∂Ëµ∑Áä∂ÊÄÅ‰∏ãÁöÑÂÜÖÂÆπ -->
        <div class="collapsed-content" v-show="layerPanelCollapsed">
          <!-- Â±ïÂºÄÊåâÈíÆ -->
          <div class="collapsed-toggle" @click="toggleLayerPanel">
            <el-button 
              link 
              size="small"
              class="expand-btn"
              title="Â±ïÂºÄÈù¢Êùø"
            >
              <span class="toggle-icon">„Äã</span>
            </el-button>
          </div>
          
          <!-- Êî∂Ëµ∑Áä∂ÊÄÅ‰∏ãÁöÑÂú∫ÊôØÈÄâÊã© -->
          <div class="collapsed-scene-selector" v-if="sceneList && sceneList.length > 0">
            <!-- Âú∫ÊôØÂå∫ÂüüÊ†áÈ¢ò -->
            <div class="collapsed-section-title">Âú∫ÊôØ</div>
            <div 
              v-for="scene in sceneList" 
              :key="scene.id" 
              class="collapsed-scene-item"
              :class="{ 'active': selectedSceneId === scene.id }"
              @click="onSceneChange(scene.id)"
              :title="`Âú∫ÊôØ: ${scene.name}
üëÜ ÁÇπÂáªÂàáÊç¢Âà∞Ê≠§Âú∫ÊôØ`"
            >
              <div class="scene-short-name">{{ scene.name.substring(0, 2) }}</div>
              <div v-if="selectedSceneId === scene.id" class="scene-active-dot"></div>
            </div>
          </div>
          
          <!-- ÂàÜÈöîÁ∫ø -->
          <div class="collapsed-separator" v-if="sceneList && sceneList.length > 0 && layersList && layersList.length > 0"></div>
          
          <!-- Êî∂Ëµ∑Áä∂ÊÄÅ‰∏ãÁöÑÂõæÂ±ÇÂàóË°® -->
          <div class="collapsed-layers" v-if="layersList && layersList.length > 0">
            <!-- ÂõæÂ±ÇÂå∫ÂüüÊ†áÈ¢ò -->
            <div class="collapsed-section-title">ÂõæÂ±Ç</div>
              <div 
                v-for="(layer) in sortedLayersList" 
                :key="layer.id" 
                class="collapsed-layer-item"
                :class="{ 
                  'active': currentActiveLayer && currentActiveLayer.scene_layer_id === layer.scene_layer_id,
                  'invisible': !layer.visibility
                }"
                @click="selectLayer(layer)"
                @dblclick="handleCollapsedLayerDblClick(layer, $event)"
                :title="`${layer.layer_name}
üîç ÂèåÂáªÁº©ÊîæÂà∞ÂõæÂ±ÇËåÉÂõ¥
üëÜ ÂçïÂáªÈÄâÊã©ÂõæÂ±Ç`"
              >
              <!-- ÂèØËßÅÊÄßÊåáÁ§∫Âô® -->
              <div class="visibility-indicator" :class="{ 'visible': layer.visibility }"></div>
              <!-- ÂõæÂ±ÇÂêçÁß∞Ââç‰∏§‰∏™Â≠ó -->
              <div class="layer-short-name">{{ layer.layer_name.substring(0, 2) }}</div>
              <!-- ÂΩìÂâçÊ¥ªÂä®ÂõæÂ±ÇÊ†áËØÜ -->
              <div v-if="currentActiveLayer && currentActiveLayer.scene_layer_id === layer.scene_layer_id" 
                   class="active-dot"></div>
            </div>
          </div>
          
          <!-- ÂõæÂ±ÇÁ©∫Áä∂ÊÄÅ -->
          <div class="collapsed-empty" v-else-if="selectedSceneId">
            <i class="el-icon-map-location"></i>
            <div class="empty-text">Êó†ÂõæÂ±Ç</div>
          </div>
          
          <!-- Âú∫ÊôØÁ©∫Áä∂ÊÄÅ -->
          <div class="collapsed-empty" v-else-if="sceneList && sceneList.length === 0">
            <i class="el-icon-folder"></i>
            <div class="empty-text">Êó†Âú∫ÊôØ</div>
          </div>
        </div>
      </div>

      <!-- Âè≥‰æßÂú∞ÂõæÂÆπÂô® -->
      <div class="map-container-wrapper" :class="{ 'with-panel': !layerPanelCollapsed }">
        <MapViewerOL 
          :scene-id="selectedSceneId" 
          :readonly="false"
          ref="mapViewerRef"
          @layer-added="onLayerAdded"
          @layer-selected="onLayerSelected"
        />
        
        <!-- üî• ÊâãÊú∫Á´ØÂ∫ïÈÉ®ÊµÆÂä®ÊåâÈíÆ -->
        <div class="mobile-layer-fab" @click="toggleMobileDrawer">
          <div class="fab-content">
            <i class="el-icon-menu"></i>
            <span class="fab-text">ÂõæÂ±Ç</span>
            <div class="fab-badge" v-if="layersList && layersList.length > 0">
              {{ layersList.length }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- üî• ÊâãÊú∫Á´ØÊäΩÂ±âÂºèÂõæÂ±ÇÈù¢Êùø -->
    <div class="mobile-drawer-overlay" :class="{ 'show': mobileDrawerVisible }" @click="closeMobileDrawer">
      <div class="mobile-drawer" :class="{ 'show': mobileDrawerVisible }" @click.stop>
        <!-- ÊäΩÂ±âÂ§¥ÈÉ® -->
        <div class="mobile-drawer-header">
          <div 
            class="drawer-handle" 
            :class="{ 'dragging': isDragging }"
            @click="handleDrawerHandleClick"
            @mousedown="handleDrawerDragStart"
            @touchstart="handleDrawerDragStart"
          ></div>
          <div class="drawer-title">
            <h3>ÂõæÂ±ÇÁÆ°ÁêÜ</h3>
            <div class="drawer-actions">
              <el-button type="primary" size="small" @click="showAddLayerDialog">
                <i class="el-icon-plus"></i>
                <span>Ê∑ªÂä†ÂõæÂ±Ç</span>
              </el-button>
            </div>
          </div>
        </div>
        
        <!-- ÊäΩÂ±âÂÜÖÂÆπ -->
        <div class="mobile-drawer-content">
          <!-- Âú∫ÊôØÈÄâÊã©Ê†áÁ≠æÈ°µ -->
          <div class="mobile-tabs">
            <div 
              class="mobile-tab" 
              :class="{ 'active': mobileActiveTab === 'scene' }"
              @click="mobileActiveTab = 'scene'"
            >
              <i class="el-icon-folder"></i>
              <span>Âú∫ÊôØ</span>
            </div>
            <div 
              class="mobile-tab" 
              :class="{ 'active': mobileActiveTab === 'layers' }"
              @click="mobileActiveTab = 'layers'"
            >
              <i class="el-icon-menu"></i>
              <span>ÂõæÂ±Ç</span>
              <div class="tab-badge" v-if="layersList && layersList.length > 0">
                {{ layersList.length }}
              </div>
            </div>
          </div>
          
          <!-- Âú∫ÊôØÈÄâÊã©ÂÜÖÂÆπ -->
          <div class="mobile-tab-content" v-show="mobileActiveTab === 'scene'">
            <div class="mobile-scene-list">
              <div 
                v-for="scene in sceneList" 
                :key="scene.id"
                class="mobile-scene-item"
                :class="{ 'active': selectedSceneId === scene.id }"
                @click="selectMobileScene(scene.id)"
              >
                <div class="scene-info">
                  <h4>{{ scene.name }}</h4>
                  <p>{{ scene.description || 'ÊöÇÊó†ÊèèËø∞' }}</p>
                </div>
                <div class="scene-meta">
                  <el-tag v-if="scene.is_public" type="success" size="small">ÂÖ¨ÂºÄ</el-tag>
                  <el-tag v-else type="warning" size="small">ÁßÅÊúâ</el-tag>
                </div>
              </div>
              
              <!-- Âú∫ÊôØÁ©∫Áä∂ÊÄÅ -->
              <div v-if="!sceneList || sceneList.length === 0" class="mobile-empty">
                <i class="el-icon-folder"></i>
                <p>ÊöÇÊó†Âú∫ÊôØ</p>
              </div>
            </div>
          </div>
          
          <!-- ÂõæÂ±ÇÂàóË°®ÂÜÖÂÆπ -->
          <div class="mobile-tab-content" v-show="mobileActiveTab === 'layers'">
            <div class="mobile-layer-list">
              <div 
                v-for="layer in sortedLayersList" 
                :key="layer.id"
                class="mobile-layer-item"
                :class="{ 
                  'active': currentActiveLayer && currentActiveLayer.scene_layer_id === layer.scene_layer_id,
                  'invisible': !layer.visibility
                }"
                @click="selectLayer(layer)"
              >
                <div class="layer-main-info">
                  <div class="layer-header">
                    <el-checkbox 
                      v-model="layer.visibility" 
                      @change="toggleLayerVisibility(layer)"
                      @click.stop
                    />
                    <span class="layer-name">{{ layer.layer_name }}</span>
                    <i v-if="currentActiveLayer && currentActiveLayer.scene_layer_id === layer.scene_layer_id" 
                       class="el-icon-location active-indicator"></i>
                  </div>
                  
                  <div class="layer-tags">
                    <span class="tag">{{ layer.file_type }}</span>
                    <span class="tag">{{ layer.discipline }}</span>
                    <span v-if="layer.service_type" class="tag" :class="getServiceTypeClass(layer.service_type)">
                      {{ getServiceTypeText(layer) }}
                    </span>
                  </div>
                  
                  <!-- ÁßªÂä®Á´ØÈÄèÊòéÂ∫¶ÊéßÂà∂ -->
                  <div class="mobile-opacity-control" @click.stop>
                    <span class="opacity-label">ÈÄèÊòéÂ∫¶</span>
                    <el-slider
                      v-model="layer.opacity"
                      :min="0"
                      :max="1"
                      :step="0.1"
                      :show-tooltip="false"
                      size="small"
                      @input="onLayerOpacityChange(layer)"
                      class="mobile-opacity-slider"
                    />
                    <span class="opacity-value">{{ Math.round((layer.opacity || 1) * 100) }}%</span>
                  </div>
                </div>
                
                <div class="layer-actions">
                  <el-button size="small" @click.stop="zoomToLayer(layer)" title="Áº©ÊîæÂà∞ÂõæÂ±Ç" class="action-btn zoom-btn">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                      <path d="M15.5 14h-.79l-.28-.27A6.5 6.5 0 1 0 13 15.5l.27.28v.79l5 4.99L19.49 20l-4.99-5zm-6 0A4.5 4.5 0 1 1 14 9.5 4.5 4.5 0 0 1 9.5 14z"/>
                      <path d="M12 10h-2v2H9v-2H7V9h2V7h1v2h2v1z"/>
                    </svg>
                  </el-button>
                  <el-button size="small" @click.stop="showStyleDialog(layer)" title="Ê†∑ÂºèËÆæÁΩÆ" class="action-btn style-btn">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                      <path d="M12,2A2,2 0 0,1 14,4C14,4.74 13.6,5.39 13,5.73V7H14A7,7 0 0,1 21,14H22A1,1 0 0,1 23,15V18A1,1 0 0,1 22,19H21V20A2,2 0 0,1 19,22H5A2,2 0 0,1 3,20V19H2A1,1 0 0,1 1,18V15A1,1 0 0,1 2,14H3A7,7 0 0,1 10,7H11V5.73C10.4,5.39 10,4.74 10,4A2,2 0 0,1 12,2M7.5,13A2.5,2.5 0 0,0 5,15.5A2.5,2.5 0 0,0 7.5,18A2.5,2.5 0 0,0 10,15.5A2.5,2.5 0 0,0 7.5,13M16.5,13A2.5,2.5 0 0,0 14,15.5A2.5,2.5 0 0,0 16.5,18A2.5,2.5 0 0,0 19,15.5A2.5,2.5 0 0,0 16.5,13Z"/>
                    </svg>
                  </el-button>
                  <el-button size="small" @click.stop="removeLayer(layer)" title="Âà†Èô§ÂõæÂ±Ç" class="action-btn delete-btn">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                      <path d="M9,3V4H4V6H5V19A2,2 0 0,0 7,21H17A2,2 0 0,0 19,19V6H20V4H15V3H9M7,6H17V19H7V6M9,8V17H11V8H9M13,8V17H15V8H13Z"/>
                    </svg>
                  </el-button>
                </div>
              </div>
              
              <!-- ÂõæÂ±ÇÁ©∫Áä∂ÊÄÅ -->
              <div v-if="!layersList || layersList.length === 0" class="mobile-empty">
                <i class="el-icon-map-location"></i>
                <p>ÂΩìÂâçÂú∫ÊôØÊöÇÊó†ÂõæÂ±Ç</p>
                <el-button type="primary" @click="showAddLayerDialog">Ê∑ªÂä†ÂõæÂ±Ç</el-button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ÂõæÂ±Ç‰ø°ÊÅØÂØπËØùÊ°Ü -->
    <el-dialog title="ÂõæÂ±Ç‰ø°ÊÅØ" v-model="layerInfoDialogVisible" width="500px">
      <div v-if="currentLayerInfo">
        <el-descriptions :column="1" border>
          <el-descriptions-item label="ÂõæÂ±ÇÂêçÁß∞">
            {{ currentLayerInfo.layer_name }}
          </el-descriptions-item>
          <el-descriptions-item label="Êñá‰ª∂Á±ªÂûã">
            {{ currentLayerInfo.file_type }}
          </el-descriptions-item>
          <el-descriptions-item label="‰∏ì‰∏ö">
            {{ currentLayerInfo.discipline }}
          </el-descriptions-item>
          <el-descriptions-item label="Áª¥Â∫¶">
            {{ currentLayerInfo.dimension }}
          </el-descriptions-item>
          <el-descriptions-item label="ÂèØËßÅÊÄß">
            {{ currentLayerInfo.visibility ? 'ÂèØËßÅ' : 'ÈöêËóè' }}
          </el-descriptions-item>
          <el-descriptions-item label="GeoServerÂõæÂ±Ç">
            {{ currentLayerInfo.geoserver_layer }}
          </el-descriptions-item>
          <el-descriptions-item label="WMSÊúçÂä°">
            <el-link :href="currentLayerInfo.wms_url" target="_blank" type="primary">
              {{ currentLayerInfo.wms_url }}
            </el-link>
          </el-descriptions-item>
          <el-descriptions-item label="WFSÊúçÂä°" v-if="currentLayerInfo.wfs_url">
            <el-link :href="currentLayerInfo.wfs_url" target="_blank" type="primary">
              {{ currentLayerInfo.wfs_url }}
            </el-link>
          </el-descriptions-item>
        </el-descriptions>
      </div>
    </el-dialog>

    <!-- Âú∫ÊôØÁÆ°ÁêÜÂØπËØùÊ°Ü -->
    <el-dialog 
      :title="editingScene ? 'ÁºñËæëÂú∫ÊôØ' : 'ÂàõÂª∫Âú∫ÊôØ'" 
      v-model="sceneDialogVisible" 
      width="500px"
    >
      <el-form :model="sceneForm" label-width="80px">
        <el-form-item label="Âú∫ÊôØÂêçÁß∞" required>
          <el-input v-model="sceneForm.name" placeholder="ËØ∑ËæìÂÖ•Âú∫ÊôØÂêçÁß∞" />
        </el-form-item>
        <el-form-item label="Âú∫ÊôØÊèèËø∞">
          <el-input 
            v-model="sceneForm.description" 
            type="textarea"
            :rows="3"
            placeholder="ËØ∑ËæìÂÖ•Âú∫ÊôØÊèèËø∞ÔºàÂèØÈÄâÔºâ" 
          />
        </el-form-item>
        <el-form-item label="ËÆøÈóÆÊùÉÈôê">
          <el-switch 
            v-model="sceneForm.is_public" 
            active-text="ÂÖ¨ÂºÄ"
            inactive-text="ÁßÅÊúâ"
            :active-value="true"
            :inactive-value="false"
          />
          <div style="font-size: 12px; color: #909399; margin-top: 5px;">
            ÂÖ¨ÂºÄÂú∫ÊôØÊâÄÊúâÁî®Êà∑ÂèØËßÅÔºåÁßÅÊúâÂú∫ÊôØ‰ªÖÂàõÂª∫ËÄÖÂèØËßÅ
          </div>
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="sceneDialogVisible = false">ÂèñÊ∂à</el-button>
        <el-button type="primary" @click="saveScene">
          {{ editingScene ? 'Êõ¥Êñ∞' : 'ÂàõÂª∫' }}
        </el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script>
/* eslint-disable */
import { ref, reactive, onMounted, onUnmounted, watch, computed, nextTick } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { ElMessage, ElMessageBox } from 'element-plus'
import gisApi from '@/api/gis'
import MapViewerOL from '@/components/MapViewerOL.vue'
import { transformExtent } from 'ol/proj'

export default {
  name: 'MapViewOL',
  components: { MapViewerOL },
  setup() {
    const route = useRoute()
    const router = useRouter()
    
    const mapViewerRef = ref(null)
    const layerPanelCollapsed = ref(false)
    
    // Âú∫ÊôØÂØπËØùÊ°Ü
    const sceneDialogVisible = ref(false)
    const editingScene = ref(null)
    const sceneForm = reactive({
      name: '',
      description: '',
      is_public: true
    })
    
    // ÂìçÂ∫îÂºèÊï∞ÊçÆ
    const sceneList = ref([])
    const selectedSceneId = ref(null)
    const layersList = ref([])  // Á°Æ‰øùÂàùÂßãÂåñ‰∏∫Á©∫Êï∞ÁªÑ
    const loading = ref(false)
    const layerInfoDialogVisible = ref(false)
    const currentLayerInfo = ref(null)
    
    // ÊãñÊãΩÁõ∏ÂÖ≥Áä∂ÊÄÅ
    const draggingLayerId = ref(null)
    const dragStartIndex = ref(-1)
    const currentActiveLayer = ref(null)
    
    // üî• ÊâãÊú∫Á´ØÊäΩÂ±âÁõ∏ÂÖ≥Áä∂ÊÄÅ
    const mobileDrawerVisible = ref(false)
    const mobileActiveTab = ref('layers') // 'scene' or 'layers'
    
    // üî• ÊãñÊãΩÊâãÊüÑÁõ∏ÂÖ≥Áä∂ÊÄÅ
    const isDragging = ref(false)
    const dragStartY = ref(0)
    const drawerStartY = ref(0)
    
    // Ëé∑ÂèñÂú∫ÊôØÂàóË°®
    const fetchSceneList = async () => {
      try {
        const response = await gisApi.getScenes()
        sceneList.value = response.data.scenes
       //console.log('sceneListlen:', sceneList.value.length)
        // Â¶ÇÊûúURL‰∏≠Êúâscene_idÂèÇÊï∞ÔºåËÆæÁΩÆ‰∏∫ÂΩìÂâçÈÄâ‰∏≠ÁöÑÂú∫ÊôØ
        const sceneIdFromQuery = route.query.scene_id
        //console.log('sceneIdFromQuery:', sceneIdFromQuery)
        if (sceneIdFromQuery) {
          selectedSceneId.value = sceneIdFromQuery
        } else if (sceneList.value.length > 0) {
          // Â¶ÇÊûúÊ≤°ÊúâÊåáÂÆöÂú∫ÊôØÔºåÈÄâÊã©Á¨¨‰∏Ä‰∏™Âú∫ÊôØ
          selectedSceneId.value = sceneList.value[0].id
        }
      } catch (error) {
        console.error('Ëé∑ÂèñÂú∫ÊôØÂàóË°®Â§±Ë¥•', error)
        ElMessage.error('Ëé∑ÂèñÂú∫ÊôØÂàóË°®Â§±Ë¥•')
      }
    }
    
    // ÈÄâÊã©Âú∫ÊôØ
     const selectScene = async (sceneId) => {
      if (selectedSceneId.value === sceneId) return
      
      selectedSceneId.value = sceneId
      
      try {
        const response = await gisApi.getScene(sceneId)
        layersList.value = response.data.layers || []
        //console.log('lv-response22:', layersList)
      } catch (error) {
        console.error('Âä†ËΩΩÂú∫ÊôØËØ¶ÊÉÖÂ§±Ë¥•:', error)
        ElMessage.error('Âä†ËΩΩÂú∫ÊôØËØ¶ÊÉÖÂ§±Ë¥•')
      }
    } 
    
    // ÊòæÁ§∫ÂàõÂª∫Âú∫ÊôØÂØπËØùÊ°Ü
    const showCreateSceneDialog = () => {
      editingScene.value = null
      sceneForm.name = ''
      sceneForm.description = ''
      sceneForm.is_public = true
      sceneDialogVisible.value = true
    }
    
    // ÁºñËæëÂú∫ÊôØ
    const editScene = (scene) => {
      editingScene.value = scene
      sceneForm.name = scene.name
      sceneForm.description = scene.description || ''
      sceneForm.is_public = scene.is_public
      sceneDialogVisible.value = true
    }
    
    // ‰øùÂ≠òÂú∫ÊôØ
    const saveScene = async () => {
      if (!sceneForm.name) {
        ElMessage.warning('ËØ∑ËæìÂÖ•Âú∫ÊôØÂêçÁß∞')
        return
      }
      
      try {
        if (editingScene.value) {
          await gisApi.updateScene(editingScene.value.id, sceneForm)
          ElMessage.success('Âú∫ÊôØÊõ¥Êñ∞ÊàêÂäü')
        } else {
          const response = await gisApi.createScene(sceneForm)
          ElMessage.success('Âú∫ÊôØÂàõÂª∫ÊàêÂäü')
          // Â¶ÇÊûúÈúÄË¶ÅÔºåÂèØ‰ª•Ëá™Âä®ÈÄâÊã©Êñ∞ÂàõÂª∫ÁöÑÂú∫ÊôØ
          // selectedSceneId.value = response.data.id
        }
        
        sceneDialogVisible.value = false
        await fetchSceneList()
      } catch (error) {
        console.error('‰øùÂ≠òÂú∫ÊôØÂ§±Ë¥•:', error)
        ElMessage.error('‰øùÂ≠òÂú∫ÊôØÂ§±Ë¥•')
      }
    }
    
    // Ëé∑ÂèñÂú∫ÊôØÂõæÂ±Ç
    const fetchSceneLayers = async (sceneId) => {
      if (!sceneId) {
        layersList.value = []
        currentActiveLayer.value = null
        return
      }
      
      try {
        loading.value = true
        const response = await gisApi.getScene(sceneId)
        layersList.value = response.data.layers
        
        // üî• ÂàùÂßãÂåñÂõæÂ±Ç‰∏çÈÄèÊòéÂ∫¶ÔºàÂ¶ÇÊûúÊ≤°ÊúâËÆæÁΩÆÊàñ‰∏∫0ÂàôÈªòËÆ§‰∏∫1Ôºâ
        layersList.value.forEach(layer => {
          if (layer.opacity === undefined || layer.opacity === null || layer.opacity === 0) {
            layer.opacity = 1.0  // ÈªòËÆ§100%‰∏çÈÄèÊòéÂ∫¶
          }
          // Á°Æ‰øùÊï∞ÂÄºÂú®ÊúâÊïàËåÉÂõ¥ÂÜÖ
          layer.opacity = Math.max(0, Math.min(1, parseFloat(layer.opacity) || 1.0))
        })
        
        // Ê∏ÖÈô§ÈÄâ‰∏≠Áä∂ÊÄÅ
        currentActiveLayer.value = null
      } catch (error) {
        console.error('Ëé∑ÂèñÂú∫ÊôØÂõæÂ±ÇÂ§±Ë¥•', error)
        ElMessage.error('Ëé∑ÂèñÂú∫ÊôØÂõæÂ±ÇÂ§±Ë¥•')
        layersList.value = []
      } finally {
        loading.value = false
      }
    }
    
    // Âú∫ÊôØÂèòÂåñÂ§ÑÁêÜ
    const onSceneChange = (sceneId) => {
      selectedSceneId.value = sceneId
      
      // Êõ¥Êñ∞URLÂèÇÊï∞
      router.replace({
        name: 'MapOL',
        query: { scene_id: sceneId }
      })
      
      fetchSceneLayers(sceneId)
    }
    
    // Âà∑Êñ∞Âú∫ÊôØ
    const refreshScene = () => {
      if (selectedSceneId.value) {
        fetchSceneLayers(selectedSceneId.value)
      }
    }
    
    // ÂàáÊç¢ÂõæÂ±ÇÈù¢ÊùøÊòæÁ§∫
    const toggleLayerPanel = () => {
      layerPanelCollapsed.value = !layerPanelCollapsed.value
      console.log('üîÑ Èù¢ÊùøÁä∂ÊÄÅÂàáÊç¢:', layerPanelCollapsed.value ? 'Êî∂Ëµ∑' : 'Â±ïÂºÄ')
      
      // Âº∫Âà∂DOMÊõ¥Êñ∞Âπ∂Ê£ÄÊü•Ê†∑Âºè
      nextTick(() => {
        console.log('‚úÖ DOMÂ∑≤Êõ¥Êñ∞ÔºåÂΩìÂâçÈù¢ÊùøÁä∂ÊÄÅ:', layerPanelCollapsed.value)
        
        // Ë∞ÉËØïÔºöÊ£ÄÊü•DOMÂÖÉÁ¥†ÂíåÊ†∑Âºè
        const panelElement = document.querySelector('.layer-panel')
        if (panelElement) {
          const computedStyle = window.getComputedStyle(panelElement)
          console.log('üìê Èù¢ÊùøÂΩìÂâçÂÆΩÂ∫¶:', computedStyle.width)
          console.log('üéØ Èù¢ÊùøÁ±ªÂêç:', panelElement.className)
          console.log('üîÑ Èù¢ÊùøcollapsedÁä∂ÊÄÅ:', panelElement.classList.contains('collapsed'))
        }
      })
    }
    

    
    // Ë∑≥ËΩ¨Âà∞Âú∫ÊôØÁÆ°ÁêÜ
    const goToSceneManage = () => {
      router.push({ name: 'Scene' })
    }
    
    // ÂàáÊç¢ÂõæÂ±ÇÂèØËßÅÊÄß
    const toggleLayerVisibility = async (layer) => {
      try {
        // ÂÖàÊõ¥Êñ∞Êï∞ÊçÆÂ∫ì‰∏≠ÁöÑÂèØËßÅÊÄßÁä∂ÊÄÅ
        await gisApi.updateSceneLayer(selectedSceneId.value, layer.id, {
          visible: layer.visibility
        })
        
        // ÈÄöÁü•MapViewerOLÁªÑ‰ª∂Êõ¥Êñ∞Âú∞ÂõæÊòæÁ§∫
        if (mapViewerRef.value && mapViewerRef.value.toggleLayerVisibility) {
          mapViewerRef.value.toggleLayerVisibility(layer)
        } else {
          // Â¶ÇÊûúÁõ¥Êé•Ë∞ÉÁî®ÊñπÊ≥ï‰∏çÂèØÁî®ÔºåÂàôÂèëÈÄÅËá™ÂÆö‰πâ‰∫ã‰ª∂
          const event = new CustomEvent('layerVisibilityChanged', {
            detail: {
              layerId: layer.id,
              layer: layer,
              visibility: layer.visibility
            }
          })
          window.dispatchEvent(event)
        }
        
      } catch (error) {
        console.error('Êõ¥Êñ∞ÂõæÂ±ÇÂèØËßÅÊÄßÂ§±Ë¥•', error)
        ElMessage.error('Êõ¥Êñ∞ÂõæÂ±ÇÂèØËßÅÊÄßÂ§±Ë¥•')
        // ÂõûÊªöÁä∂ÊÄÅ
        layer.visibility = !layer.visibility
      }
    }

    // üî• ÂõæÂ±ÇÈÄèÊòéÂ∫¶ÂèòÂåñÂ§ÑÁêÜ
    const onLayerOpacityChange = (layer) => {
      // ÈôêÂà∂ÈÄèÊòéÂ∫¶ËåÉÂõ¥
      if (layer.opacity < 0) layer.opacity = 0
      if (layer.opacity > 1) layer.opacity = 1
      
      // 1. Á´ãÂç≥Êõ¥Êñ∞Âú∞Âõæ‰∏≠ÁöÑÂõæÂ±ÇÈÄèÊòéÂ∫¶
      if (mapViewerRef.value && mapViewerRef.value.updateLayerOpacity) {
        mapViewerRef.value.updateLayerOpacity(layer, layer.opacity)
      }
      
      // 2. Èò≤ÊäñÊõ¥Êñ∞Êï∞ÊçÆÂ∫ì
      updateLayerOpacityInDatabase(layer)
    }
    
    // Èò≤ÊäñÂÆöÊó∂Âô®Êò†Â∞Ñ
    const opacityUpdateTimers = ref(new Map())
    
    // üî• Êõ¥Êñ∞Êï∞ÊçÆÂ∫ì‰∏≠ÁöÑÂõæÂ±ÇÈÄèÊòéÂ∫¶ÔºàÈò≤ÊäñÔºâ
    const updateLayerOpacityInDatabase = async (layer) => {
      if (!selectedSceneId.value || !layer.scene_layer_id) {
        console.warn('Áº∫Â∞ëÂú∫ÊôØIDÊàñÂõæÂ±ÇIDÔºåË∑≥ËøáÊï∞ÊçÆÂ∫ìÊõ¥Êñ∞')
        return
      }
      
      // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
      if (opacityUpdateTimers.value.has(layer.id)) {
        clearTimeout(opacityUpdateTimers.value.get(layer.id))
      }
      
      // ËÆæÁΩÆÊñ∞ÁöÑÈò≤ÊäñÂÆöÊó∂Âô®Ôºà500msÂêéÊâßË°åÔºâ
      const timer = setTimeout(async () => {
        try {
          const updateData = {
            opacity: layer.opacity
          }
          
          //console.log('‰øùÂ≠òÈÄèÊòéÂ∫¶Âà∞Êï∞ÊçÆÂ∫ì:', {
          //   scene_id: selectedSceneId.value,
          //   layer_id: layer.id,
          //   opacity: layer.opacity
          // })
          
          // Ë∞ÉÁî®ÂêéÁ´ØAPIÊõ¥Êñ∞ÈÄèÊòéÂ∫¶
          await gisApi.updateSceneLayer(selectedSceneId.value, layer.id, updateData)
          //console.log('‚úÖ ÈÄèÊòéÂ∫¶Â∑≤‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì')
          
          // Ê∏ÖÈô§ÂÆöÊó∂Âô®
          opacityUpdateTimers.value.delete(layer.id)
        } catch (error) {
          console.error('‰øùÂ≠òÈÄèÊòéÂ∫¶Â§±Ë¥•:', error)
          ElMessage.error('ÈÄèÊòéÂ∫¶ËÆæÁΩÆ‰øùÂ≠òÂ§±Ë¥•')
        }
      }, 500)
      
      opacityUpdateTimers.value.set(layer.id, timer)
    }
    
    // ‰∏äÁßªÂõæÂ±Ç
    const moveLayerUp = async (index) => {
      if (index === 0) return
      
      // ‰∫§Êç¢Êï∞ÁªÑ‰∏≠ÁöÑ‰ΩçÁΩÆ
      const temp = layersList.value[index]
      layersList.value[index] = layersList.value[index - 1]
      layersList.value[index - 1] = temp
      
      // Êõ¥Êñ∞ÊúçÂä°Âô®Á´ØÁöÑÈ°∫Â∫è
      await updateLayerOrder()
    }
    
    // ‰∏ãÁßªÂõæÂ±Ç
    const moveLayerDown = async (index) => {
      if (index === layersList.value.length - 1) return
      
      // ‰∫§Êç¢Êï∞ÁªÑ‰∏≠ÁöÑ‰ΩçÁΩÆ
      const temp = layersList.value[index]
      layersList.value[index] = layersList.value[index + 1]
      layersList.value[index + 1] = temp
      
      // Êõ¥Êñ∞ÊúçÂä°Âô®Á´ØÁöÑÈ°∫Â∫è
      await updateLayerOrder()
    }
    
    // Êõ¥Êñ∞ÂõæÂ±ÇÈ°∫Â∫è
    const updateLayerOrder = async () => {
      // ÂàõÂª∫È°∫Â∫èÊò†Â∞Ñ
      const orderMap = {}
      layersList.value.forEach((layer, index) => {
        orderMap[layer.id] = layersList.value.length - index
      })
      
      try {
        await gisApi.reorderSceneLayers(selectedSceneId.value, orderMap)
      } catch (error) {
        console.error('Êõ¥Êñ∞ÂõæÂ±ÇÈ°∫Â∫èÂ§±Ë¥•', error)
        ElMessage.error('Êõ¥Êñ∞ÂõæÂ±ÇÈ°∫Â∫èÂ§±Ë¥•')
        // ÈáçÊñ∞Ëé∑ÂèñÂõæÂ±ÇÂàóË°®
        fetchSceneLayers(selectedSceneId.value)
      }
    }
    
    // Â§ÑÁêÜÂõæÂ±ÇÊìç‰Ωú
    const handleLayerAction = ({ action, layer }) => {
      switch (action) {
        case 'style':
          // Ë∞ÉÁî®MapViewerOLÁªÑ‰ª∂ÁöÑÊ†∑ÂºèËÆæÁΩÆÊñπÊ≥ï
          if (mapViewerRef.value) {
            mapViewerRef.value.showStyleDialog(layer)
          }
          break
        case 'zoom':
          zoomToLayer(layer)
          break
        case 'info':
          showLayerInfo(layer)
          break
        case 'remove':
          removeLayer(layer)
          break
      }
    }
    
    // Áº©ÊîæÂà∞ÂõæÂ±Ç - ÈíàÂØπOpenLayers‰ºòÂåñÔºåÊîØÊåÅÂä®ÊÄÅÂùêÊ†áÁ≥ª
    const zoomToLayer = async (layer) => {
      try {
        //console.log('lvzoomToLayer:', layer)
        // Êõ¥ÂÆâÂÖ®ÁöÑÂú∞ÂõæÂèØÁî®ÊÄßÊ£ÄÊü•
        if (!mapViewerRef.value) {
          ElMessage.error('Âú∞ÂõæÁªÑ‰ª∂ÂºïÁî®‰∏çÂ≠òÂú®')
          return
        }
        
        if (!mapViewerRef.value.map) {
          ElMessage.error('Âú∞ÂõæÂÆû‰æãÊú™ÂàùÂßãÂåñ')
          return
        }
        
        // Á°Æ‰øùÂú∞ÂõæÂÆû‰æãÊòØÊúâÊïàÁöÑ
        const map = mapViewerRef.value.map
        if (!map || typeof map.getView !== 'function') {
          ElMessage.error('Âú∞ÂõæÂÆû‰æãÊó†Êïà')
          return
        }
        
        let bbox = null
        let originalCRS = 'EPSG:4326' // Áî®‰∫éÊòæÁ§∫ÁöÑÂéüÂßãÂùêÊ†áÁ≥ª
        
        // 1. ‰ºòÂÖà‰ΩøÁî®Êñ∞ÁöÑÂõæÂ±ÇËæπÁïåAPIÔºàbboxÂ∑≤ÁªèÊòØËΩ¨Êç¢ÂêéÁöÑEPSG:4326ÂùêÊ†áÔºâ
        try {
          //20250617Êõ¥ÊîπÁªôÂêéÁ´Ø‰º†scene_layer_idÔºåËÄå‰∏çÊòØlayer.id
          const response = await gisApi.getSceneLayerBounds(layer.scene_layer_id)
          if (response?.success && response.data?.bbox) {
            bbox = response.data.bbox
            // coordinate_systemÂ≠óÊÆµ‰ªÖÁî®‰∫éÊòæÁ§∫ÂéüÂßãÂùêÊ†áÁ≥ªÔºåbboxÂ∑≤ÁªèÊòØEPSG:4326ÂùêÊ†á
            originalCRS = response.data.coordinate_system || 'EPSG:4326'
            //console.log('‰ªéÂõæÂ±ÇËæπÁïåAPIËé∑ÂèñÂà∞ËæπÁïå:', bbox, '(Â∑≤ËΩ¨Êç¢‰∏∫EPSG:4326), ÂéüÂßãÂùêÊ†áÁ≥ª:', originalCRS)
          }
        } catch (apiError) {
          console.warn('ÂõæÂ±ÇËæπÁïåAPIË∞ÉÁî®Â§±Ë¥•ÔºåÂ∞ùËØïÂÖ∂‰ªñÊñπÂºè:', apiError)
        }
        
        // 2. Â¶ÇÊûúËæπÁïåAPIË∞ÉÁî®Â§±Ë¥•ÔºåÂ∞ùËØï‰ªéÂõæÂ±ÇÂ±ûÊÄßËé∑Âèñ
        if (!bbox && layer.bbox) {
          if (typeof layer.bbox === 'string') {
            try {
              bbox = JSON.parse(layer.bbox)
            } catch (e) {
              console.error('Ëß£ÊûêÂõæÂ±ÇËæπÁïåÊ°ÜÂ§±Ë¥•:', e)
            }
          } else {
            bbox = layer.bbox
          }
        }
        
        // 3. Â¶ÇÊûú‰ªçÁÑ∂Ê≤°ÊúâËæπÁïåÔºåÂ∞ùËØï‰ªéÊñá‰ª∂‰ø°ÊÅØËé∑Âèñ
        if (!bbox && layer.file_id) {
          try {
            const response = await gisApi.getFileBounds(layer.file_id)
            if (response?.bbox) {
              bbox = response.bbox
              if (typeof bbox === 'string') {
                bbox = JSON.parse(bbox)
              }
            }
          } catch (fileError) {
            console.warn('Ëé∑ÂèñÊñá‰ª∂ËæπÁïåÂ§±Ë¥•:', fileError)
          }
        }
        
        if (!bbox) {
          ElMessage.warning('Êó†Ê≥ïËé∑ÂèñÂõæÂ±ÇËæπÁïå‰ø°ÊÅØ')
          return
        }
        //console.log('bbox:', bbox)
        // 4. È™åËØÅËæπÁïåÊ°ÜÊï∞ÊçÆÂπ∂ËΩ¨Êç¢Ê†ºÂºè
        let minx, miny, maxx, maxy
        
        if (bbox.minx !== undefined) {
          // ÂØπË±°Ê†ºÂºè {minx, miny, maxx, maxy}
          minx = parseFloat(bbox.minx)
          miny = parseFloat(bbox.miny)
          maxx = parseFloat(bbox.maxx)
          maxy = parseFloat(bbox.maxy)
        }  else {
          ElMessage.warning('ËæπÁïåÊ°ÜÊï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°Æ')
          return
        }
        
        if (isNaN(minx) || isNaN(miny) || isNaN(maxx) || isNaN(maxy)) {
          ElMessage.warning('ËæπÁïåÊ°ÜÊï∞ÊçÆÊ†ºÂºèÈîôËØØ')
          return
        }
        
        // 5. ÊûÑÂª∫ËåÉÂõ¥Âπ∂ËøõË°åÂùêÊ†áËΩ¨Êç¢
        const originalExtent = [minx, miny, maxx, maxy]
        //console.log(`ËæπÁïåÊ°ÜÂùêÊ†á (ÂêéÁ´ØÂ∑≤ËΩ¨Êç¢‰∏∫EPSG:4326):`, originalExtent, `ÂéüÂßãÂùêÊ†áÁ≥ª: ${originalCRS}`)
        
        let transformedExtent
        try {
          // Áî±‰∫éÂêéÁ´ØËøîÂõûÁöÑbboxÂ∑≤ÁªèÊòØEPSG:4326ÂùêÊ†áÔºåÁõ¥Êé•‰ªéEPSG:4326ËΩ¨Êç¢Âà∞EPSG:3857
          if (mapViewerRef.value.transformCoordinates) {
            transformedExtent = mapViewerRef.value.transformCoordinates(originalExtent, 'EPSG:4326', 'EPSG:3857')
          } else {
            // Â§áÁî®ÊñπÊ°àÔºöÁõ¥Êé•‰ΩøÁî®OpenLayersÁöÑtransformExtent
            transformedExtent = ol.proj.transformExtent(originalExtent, 'EPSG:4326', 'EPSG:3857')
          }
          //console.log(`ËΩ¨Êç¢ÂêéËæπÁïå (EPSG:3857):`, transformedExtent)
        } catch (transformError) {
          console.error('ÂùêÊ†áËΩ¨Êç¢Â§±Ë¥•:', transformError)
          ElMessage.error(`ÂùêÊ†áËΩ¨Êç¢Â§±Ë¥•: ${transformError.message}`)
          return
        }
        
        // 6. Áº©ÊîæÂà∞ËΩ¨Êç¢ÂêéÁöÑËåÉÂõ¥
        const view = map.getView()
        view.fit(transformedExtent, {
          padding: [20, 20, 20, 20], // ËæπË∑ù
          maxZoom: 16, // ÊúÄÂ§ßÁº©ÊîæÁ∫ßÂà´ÈôêÂà∂
          duration: 1000 // Âä®ÁîªÊåÅÁª≠Êó∂Èó¥
        })
        
        // 7. Áº©ÊîæÂÆåÊàêÂêéÔºåËÆæÁΩÆÂΩìÂâçÊ¥ªÂä®ÂõæÂ±Ç
        currentActiveLayer.value = layer
        
        // üî• ÊâãÊú∫Á´ØÔºöÁº©ÊîæÂêéËá™Âä®ÈöêËóèÂõæÂ±ÇÁÆ°ÁêÜÈù¢Êùø
        if (mobileDrawerVisible.value) {
          closeMobileDrawer()
        }
        
        ElMessage.success(`Â∑≤Áº©ÊîæÂà∞ÂõæÂ±Ç"${layer.layer_name}"ËåÉÂõ¥ (${originalCRS})`)
        
      } catch (error) {
        console.error('Áº©ÊîæÂà∞ÂõæÂ±ÇÂ§±Ë¥•:', error)
        ElMessage.error(`Áº©ÊîæÂà∞ÂõæÂ±ÇÂ§±Ë¥•: ${error.message}`)
      }
    }
    
    // Â§ÑÁêÜÊî∂Ëµ∑Áä∂ÊÄÅ‰∏ãÁöÑÂõæÂ±ÇÂèåÂáª‰∫ã‰ª∂
    const handleCollapsedLayerDblClick = async (layer, event) => {
      // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°ÂíåÈªòËÆ§Ë°å‰∏∫
      event.preventDefault()
      event.stopPropagation()
      
      // Ê∑ªÂä†Âä®ÁîªÊïàÊûú
      const target = event.currentTarget
      target.classList.add('zoom-animation')
      
      // ÁßªÈô§Âä®ÁîªÁ±ªÔºàÂú®Âä®ÁîªÁªìÊùüÂêéÔºâ
      setTimeout(() => {
        target.classList.remove('zoom-animation')
      }, 200)
      
      // Ë∞ÉÁî®Áº©ÊîæÂáΩÊï∞
      await zoomToLayer(layer)
    }
    
    // ÊòæÁ§∫ÂõæÂ±Ç‰ø°ÊÅØ
    const showLayerInfo = (layer) => {
      currentLayerInfo.value = layer
      layerInfoDialogVisible.value = true
    }
    
    // ÁßªÈô§ÂõæÂ±Ç
    const removeLayer = (layer) => {
      ElMessageBox.confirm(`Á°ÆËÆ§‰ªéÂú∫ÊôØ‰∏≠ÁßªÈô§ÂõæÂ±Ç"${layer.layer_name}"Ôºü`, 'ÊèêÁ§∫', {
        confirmButtonText: 'Á°ÆÂÆö',
        cancelButtonText: 'ÂèñÊ∂à',
        type: 'warning'
      }).then(async () => {
        try {
          await gisApi.removeLayerFromScene(selectedSceneId.value, layer.id)
          ElMessage.success('ÂõæÂ±ÇÁßªÈô§ÊàêÂäü')
          // Âà∑Êñ∞ÂõæÂ±ÇÂàóË°®
          fetchSceneLayers(selectedSceneId.value)
        } catch (error) {
          console.error('ÁßªÈô§ÂõæÂ±ÇÂ§±Ë¥•', error)
          ElMessage.error('ÁßªÈô§ÂõæÂ±ÇÂ§±Ë¥•')
        }
      }).catch(() => {})
    }

    // ÊòæÁ§∫Ê∑ªÂä†ÂõæÂ±ÇÂØπËØùÊ°Ü
    const showAddLayerDialog = async () => {
      // üî• ÊâãÊú∫Á´ØÔºöÊòæÁ§∫Ê∑ªÂä†ÂõæÂ±ÇÂØπËØùÊ°ÜÂâçÂÖàÈöêËóèÂõæÂ±ÇÁÆ°ÁêÜÈù¢Êùø
      if (mobileDrawerVisible.value) {
        closeMobileDrawer()
        // Á≠âÂæÖ‰∏ã‰∏Ä‰∏™tickÔºåÁ°Æ‰øùÈù¢ÊùøÂÆåÂÖ®ÈöêËóèÂêéÂÜçÊòæÁ§∫ÂØπËØùÊ°Ü
        await nextTick()
      }
      
      if (!mapViewerRef.value) {
        console.error('mapViewerRef.value is null or undefined')
        ElMessage.error('Âú∞ÂõæÁªÑ‰ª∂Êú™ÂáÜÂ§áÂ∞±Áª™ÔºåËØ∑Á®çÂêéÂÜçËØï')
        return
      }
      
      if (typeof mapViewerRef.value.showAddLayerDialog !== 'function') {
        console.error('showAddLayerDialog method not found on mapViewerRef')
        ElMessage.error('Ê∑ªÂä†ÂõæÂ±ÇÂäüËÉΩÊöÇ‰∏çÂèØÁî®')
        return
      }
      
      try {
        mapViewerRef.value.showAddLayerDialog()
      } catch (error) {
        console.error('Error calling showAddLayerDialog:', error)
        ElMessage.error('ÊòæÁ§∫Ê∑ªÂä†ÂõæÂ±ÇÂØπËØùÊ°ÜÂ§±Ë¥•')
      }
    }

    // ÊòæÁ§∫Ê†∑ÂºèËÆæÁΩÆÂØπËØùÊ°Ü
    const showStyleDialog = (layer) => {
      // ÊòæÁ§∫Ê†∑ÂºèÂØπËØùÊ°ÜÂâçÔºåÂÖàÂ∞ÜËØ•ÂõæÂ±ÇËÆæÁΩÆ‰∏∫ÂΩìÂâçÂõæÂ±Ç
      selectLayer(layer)
      
      if (mapViewerRef.value) {
        mapViewerRef.value.showStyleDialog(layer)
      }
      // üî• ÊâãÊú∫Á´ØÔºöÁº©ÊîæÂêéËá™Âä®ÈöêËóèÂõæÂ±ÇÁÆ°ÁêÜÈù¢Êùø
      if (mobileDrawerVisible.value) {
          closeMobileDrawer()
        }
    }

    // Ëé∑ÂèñÊúçÂä°Á±ªÂûãÊ†∑ÂºèÁ±ª
    const getServiceTypeClass = (serviceType) => {
      switch (serviceType) {
        case 'martin':
          return 'service-martin'
        case 'geoserver':
          return 'service-geoserver'
        default:
          return ''
      }
    }

    // Ëé∑ÂèñÊúçÂä°Á±ªÂûãÊñáÊú¨
    const getServiceTypeText = (layer) => {
      switch (layer.service_type) {
        case 'martin':
          // Â¶ÇÊûúÊúâÂ≠êÁ±ªÂûã‰ø°ÊÅØÔºåÊòæÁ§∫ËØ¶ÁªÜÁ±ªÂûã
          if (layer.martin_service_subtype) {
            const subtype = layer.martin_service_subtype.toUpperCase()
            return `Martin(${subtype})`
          }
          return 'Martin'
        case 'geoserver':
          return 'GeoServer'
        default:
          return 'Êú™Áü•'
      }
    }

    // Ëé∑ÂèñÂõæÂ±ÇÁä∂ÊÄÅÊ†∑ÂºèÁ±ª
    const getLayerStatusClass = (layer) => {
      if (layer.service_type === 'martin') {
        return 'status-published' // MartinÊúçÂä°ÈÄöÂ∏∏ÈÉΩÊòØÂ∑≤ÂèëÂ∏ÉÁöÑ
      }
      if (!layer.geoserver_layer || !layer.wms_url) {
        return 'status-unpublished'
      }
      return 'status-published'
    }

    // Ëé∑ÂèñÂõæÂ±ÇÁä∂ÊÄÅÊñáÊú¨
    const getLayerStatusText = (layer) => {
      if (layer.service_type === 'martin') {
        return 'Â∑≤ÂèëÂ∏É'
      }
      if (!layer.geoserver_layer || !layer.wms_url) {
        return 'Êú™ÂèëÂ∏É'
      }
      return 'Â∑≤ÂèëÂ∏É'
    }

    // Â§ÑÁêÜÂõæÂ±ÇÊ∑ªÂä†‰∫ã‰ª∂
    const onLayerAdded = () => {
      // Âà∑Êñ∞ÂΩìÂâçÂú∫ÊôØÁöÑÂõæÂ±ÇÂàóË°®
      if (selectedSceneId.value) {
        fetchSceneLayers(selectedSceneId.value)
      }
    }
    
    // ÁõëÂê¨ÈÄâ‰∏≠Âú∫ÊôØÂèòÂåñ
    watch(selectedSceneId, (newSceneId) => {
      if (newSceneId) {
        fetchSceneLayers(newSceneId)
      }
    })
    
    // ÁªÑ‰ª∂ÊåÇËΩΩÊó∂Ëé∑ÂèñÊï∞ÊçÆ
    onMounted(() => {
      fetchSceneList()
    })
    
    // ÁªÑ‰ª∂Âç∏ËΩΩÊó∂Ê∏ÖÁêÜËµÑÊ∫ê
    onUnmounted(() => {
      // Ê∏ÖÁêÜËµÑÊ∫êÈÄªËæë
    })
    
    // ÈÄâÊã©ÂõæÂ±Ç
    const selectLayer = (layer) => {
      //console.log('ÈÄâÊã©ÂõæÂ±Ç:', layer.layer_name)
      currentActiveLayer.value = layer
      
      // ÈÄöÁü•MapViewerOLÁªÑ‰ª∂Â∞ÜËØ•ÂõæÂ±ÇÁΩÆÈ°∂
      // if (mapViewerRef.value) {
      //   mapViewerRef.value.bringLayerToTop(layer)
      // }
      
      ElMessage.success(`Â∑≤ÈÄâ‰∏≠ÂõæÂ±Ç: ${layer.layer_name}`)
    }
    
    // Â§ÑÁêÜÂõæÂ±ÇÈÄâÊã©‰∫ã‰ª∂
    const onLayerSelected = (layer) => {
      //console.log('Êî∂Âà∞ÂõæÂ±ÇÈÄâÊã©‰∫ã‰ª∂:', layer)
      // Áõ¥Êé•ËÆæÁΩÆÂΩìÂâçÊ¥ªÂä®ÂõæÂ±ÇÔºåÈÅøÂÖçÂæ™ÁéØË∞ÉÁî®
      currentActiveLayer.value = layer
    }
    
    // Ëé∑ÂèñÂõæÂ±ÇÁ±ªÂûãÈ¢úËâ≤
    const getLayerTypeColor = (serviceType) => {
      switch (serviceType) {
        case 'martin':
          return 'success'
        case 'geoserver':
          return 'primary'
        default:
          return 'info'
      }
    }
    
    // Ê£ÄÊü•ÂΩìÂâçÂõæÂ±ÇÊòØÂê¶ÂèØ‰∫§‰∫í
    const isCurrentLayerInteractive = computed(() => {
      if (!currentActiveLayer.value || !mapViewerRef.value) {
        return false
      }
      
      // Ë∞ÉÁî®MapViewerOLÁöÑÊñπÊ≥ïËé∑ÂèñÂΩìÂâçÂõæÂ±Ç‰ø°ÊÅØ
      try {
        const layerInfo = mapViewerRef.value.getCurrentLayerInfo()
        return layerInfo.canInteract
      } catch (error) {
        console.warn('Ëé∑ÂèñÂõæÂ±Ç‰∫§‰∫íÁä∂ÊÄÅÂ§±Ë¥•:', error)
        return false
      }
    })
    
    // ÈáçÁΩÆÊâÄÊúâÂõæÂ±Ç
    const resetAllLayers = () => {
      if (mapViewerRef.value && mapViewerRef.value.resetAllLayersToDefault) {
        mapViewerRef.value.resetAllLayersToDefault()
        currentActiveLayer.value = null
      }
    }
    
    // Âà†Èô§Âú∫ÊôØ
    const deleteScene = async (sceneId) => {
      try {
        await ElMessageBox.confirm('Á°ÆËÆ§Âà†Èô§ËØ•Âú∫ÊôØÂêóÔºü', 'ÊèêÁ§∫', {
          confirmButtonText: 'Á°ÆÂÆö',
          cancelButtonText: 'ÂèñÊ∂à',
          type: 'warning'
        })
        
        await gisApi.deleteScene(sceneId)
        ElMessage.success('Âú∫ÊôØÂà†Èô§ÊàêÂäü')
        await fetchSceneList()
        
        // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÈÄâ‰∏≠ÁöÑÂú∫ÊôØÔºåÊ∏ÖÈô§ÈÄâÊã©
        if (selectedSceneId.value === sceneId) {
          selectedSceneId.value = null
          layersList.value = []
        }
      } catch (error) {
        if (error !== 'cancel') {
          console.error('Âà†Èô§Âú∫ÊôØÂ§±Ë¥•:', error)
          ElMessage.error('Âà†Èô§Âú∫ÊôØÂ§±Ë¥•')
        }
      }
    }
    
    // ËÆ°ÁÆóÂ±ûÊÄß - ÂΩìÂâçÂú∫ÊôØ
    /* const currentScene = computed(() => {
      return sceneList.value.find(scene => scene.id === selectedSceneId.value)
    }) */
    
    // ÂõæÂ±ÇÊåâÈ°∫Â∫èÊéíÂ∫èÔºàlayer_orderÂ§ßÁöÑÂú®‰∏äÈù¢Ôºâ
    const sortedLayersList = computed(() => {
      if (!layersList.value || !Array.isArray(layersList.value)) {
        return []
      }
      
      return [...layersList.value].sort((a, b) => {
        const orderA = a.layer_order || 0
        const orderB = b.layer_order || 0
        return orderB - orderA // ÈôçÂ∫èÊéíÂàóÔºåÂ§ßÁöÑÂú®ÂâçÈù¢
      })
    })

    // ÂõæÂ±ÇÊï∞ÈáèËÆ°ÁÆóÂ±ûÊÄß
    const layerCount = computed(() => {
      return layersList.value ? layersList.value.length : 0
    })
    
    // Ëé∑ÂèñÂõæÂ±ÇÊï∞ÈáèÊñáÊú¨
    const getLayerCountText = () => {
      const count = layerCount.value
      return count === 0 ? 'ÊöÇÊó†ÂõæÂ±Ç' : `${count} ‰∏™ÂõæÂ±Ç`
    }

    // ÊãñÊãΩÂºÄÂßã
    const handleDragStart = (event, layer, index) => {
      draggingLayerId.value = String(layer.id)  // üî• Á°Æ‰øù‰∏∫Â≠óÁ¨¶‰∏≤
      dragStartIndex.value = index
      event.dataTransfer.effectAllowed = 'move'
      event.dataTransfer.setData('text/plain', String(layer.id))  // üî• Á°Æ‰øù‰∏∫Â≠óÁ¨¶‰∏≤
      
      // üî• ÂàõÂª∫‰ºòÂåñÁöÑÊãñÊãΩÂõæÂÉè
      createOptimizedDragImage(event, layer)
    }

    // üî• ÂàõÂª∫‰ºòÂåñÁöÑÊãñÊãΩÂõæÂÉè
    const createOptimizedDragImage = (event, layer) => {
      // ÂàõÂª∫‰∏Ä‰∏™Â∞èÂ∑ßÁ≤æÁæéÁöÑÊãñÊãΩÂõæÂÉè
      const dragImage = document.createElement('div')
      
      // ÈôêÂà∂ÂõæÂ±ÇÂêçÁß∞ÈïøÂ∫¶
      const displayName = layer.layer_name.length > 20 ? 
        layer.layer_name.substring(0, 20) + '...' : 
        layer.layer_name
      
      dragImage.innerHTML = `
        <div style="display: flex; align-items: center; gap: 6px;">
          <i class="el-icon-rank" style="font-size: 14px;"></i>
          <span style="font-size: 12px; font-weight: 500;">${displayName}</span>
        </div>
      `
      
      // ËÆæÁΩÆÁÆÄÊ¥ÅÁöÑÊ†∑Âºè
      dragImage.style.cssText = `
        position: absolute;
        top: -1000px;
        left: -1000px;
        background: linear-gradient(135deg, #409EFF, #36A3F7);
        color: white;
        padding: 6px 10px;
        border-radius: 16px;
        font-size: 12px;
        box-shadow: 0 4px 15px rgba(64, 158, 255, 0.3);
        opacity: 0.95;
        max-width: 180px;
        white-space: nowrap;
        z-index: 9999;
        pointer-events: none;
        transform: rotate(1deg) scale(0.9);
        border: 2px solid rgba(255,255,255,0.3);
      `
      
      // Ê∑ªÂä†Âà∞body
      document.body.appendChild(dragImage)
      
      // ËÆæÁΩÆÊãñÊãΩÂõæÂÉèÔºåË∞ÉÊï¥ÂÅèÁßª‰ΩçÁΩÆ
      event.dataTransfer.setDragImage(dragImage, 15, 8)
      
      // Á´ãÂç≥Ê∏ÖÁêÜ
      setTimeout(() => {
        if (dragImage.parentNode) {
          document.body.removeChild(dragImage)
        }
      }, 0)
    }

    // ÊãñÊãΩÁªìÊùü
    const handleDragEnd = () => {
      draggingLayerId.value = null
      dragStartIndex.value = -1
      //console.log('ÊãñÊãΩÊìç‰ΩúÁªìÊùü')
    }

    // ÊãñÊãΩÊÇ¨ÂÅú
    const handleDragOver = (event, index) => {
      event.preventDefault()
      event.dataTransfer.dropEffect = 'move'
    }

    // ÊãñÊãΩÊîæÁΩÆ
    const handleDrop = async (event, dropIndex) => {
      event.preventDefault()
      
      const draggedLayerId = parseInt(event.dataTransfer.getData('text/plain'))
      const startIndex = dragStartIndex.value
      
      if (startIndex === dropIndex || startIndex === -1) {
        return
      }

      try {
        // ËÆ°ÁÆóÊñ∞ÁöÑÂõæÂ±ÇÈ°∫Â∫è
        const newLayersOrder = calculateNewLayersOrder(startIndex, dropIndex)
        
        // ÊâπÈáèÊõ¥Êñ∞ÂõæÂ±ÇÈ°∫Â∫è
        await updateLayersOrder(newLayersOrder)
        
        ElMessage.success('ÂõæÂ±ÇÈ°∫Â∫èÊõ¥Êñ∞ÊàêÂäü')
        
        // üî• Á´ãÂç≥Âà∑Êñ∞UIÂíåÂú∞ÂõæÂõæÂ±ÇÈ°∫Â∫è
        await refreshLayersAfterReorder()
        
      } catch (error) {
        console.error('Êõ¥Êñ∞ÂõæÂ±ÇÈ°∫Â∫èÂ§±Ë¥•:', error)
        ElMessage.error('Êõ¥Êñ∞ÂõæÂ±ÇÈ°∫Â∫èÂ§±Ë¥•')
      }
    }

    // ËÆ°ÁÆóÊñ∞ÁöÑÂõæÂ±ÇÈ°∫Â∫è
    const calculateNewLayersOrder = (fromIndex, toIndex) => {
      const sortedLayers = [...sortedLayersList.value]
      const movedLayer = sortedLayers[fromIndex]
      
      // ÁßªÈô§Ë¢´ÊãñÊãΩÁöÑÂõæÂ±Ç
      sortedLayers.splice(fromIndex, 1)
      // ÊèíÂÖ•Âà∞Êñ∞‰ΩçÁΩÆ
      sortedLayers.splice(toIndex, 0, movedLayer)
      
      // ÈáçÊñ∞ÂàÜÈÖçlayer_orderÔºà‰ªéÂ§ßÂà∞Â∞èÔºåÂõ†‰∏∫ÊòæÁ§∫Êó∂ÊòØ‰ªéÂ§ßÂà∞Â∞èÊéíÂ∫èÔºâ
      const newOrders = {}
      const maxOrder = sortedLayers.length
      
      sortedLayers.forEach((layer, index) => {
        const newOrder = maxOrder - index // Á¨¨‰∏Ä‰∏™Ôºàindex=0ÔºâËé∑ÂæóÊúÄÂ§ßorder
        // üî• ‰øùÊåÅlayer_id‰∏∫Â≠óÁ¨¶‰∏≤ÔºåÈÅøÂÖçÂ§ßÊï¥Êï∞Á≤æÂ∫¶‰∏¢Â§±
        const layerId = String(layer.id)
        newOrders[layerId] = newOrder
      })
      
      //console.log('ËÆ°ÁÆóÁöÑÊñ∞ÂõæÂ±ÇÈ°∫Â∫è:', newOrders)
      return newOrders
    }

    // ÊâπÈáèÊõ¥Êñ∞ÂõæÂ±ÇÈ°∫Â∫è
    const updateLayersOrder = async (newOrders) => {
      //console.log('ÂáÜÂ§áÂèëÈÄÅÁöÑÊï∞ÊçÆ:', {
      //   sceneId: selectedSceneId.value,
      //   layerOrders: newOrders
      // })
      // ‰ΩøÁî®Áé∞ÊúâÁöÑÊâπÈáèÊõ¥Êñ∞Êé•Âè£
      await gisApi.reorderSceneLayers(selectedSceneId.value, newOrders)
    }

    // üî• ÊãñÊãΩÈáçÊñ∞ÊéíÂ∫èÂêéÁöÑÂà∑Êñ∞ÂáΩÊï∞
    const refreshLayersAfterReorder = async () => {
      try {
        //console.log('ÂºÄÂßãÂà∑Êñ∞ÂõæÂ±ÇÈ°∫Â∫è...')
        
        // 1. ÈáçÊñ∞Ëé∑ÂèñÂú∫ÊôØÊï∞ÊçÆÔºåÊõ¥Êñ∞UI‰∏≠ÁöÑÂõæÂ±ÇÂç°ÁâáÈ°∫Â∫è
        //console.log('ÈáçÊñ∞Ëé∑ÂèñÂú∫ÊôØÂõæÂ±ÇÊï∞ÊçÆ...')
        await fetchSceneLayers(selectedSceneId.value)
        
        // 2. Á≠âÂæÖ‰∏ã‰∏Ä‰∏™tickÁ°Æ‰øùUIÂ∑≤Êõ¥Êñ∞
        await nextTick()
        
        // 3. ÈÄöÁü•Âú∞ÂõæÁªÑ‰ª∂Âà∑Êñ∞ÂõæÂ±ÇÊòæÁ§∫È°∫Â∫è
        if (mapViewerRef.value) {
          //console.log('ÈÄöÁü•Âú∞ÂõæÁªÑ‰ª∂Âà∑Êñ∞ÂõæÂ±Ç...')
          
          // Â∞ùËØïË∞ÉÁî®‰∏çÂêåÁöÑÂà∑Êñ∞ÊñπÊ≥ï
          if (mapViewerRef.value.refreshAllLayers) {
            await mapViewerRef.value.refreshAllLayers()
            //console.log('‚úÖ Âú∞ÂõæÂõæÂ±ÇÂ∑≤Âà∑Êñ∞(refreshAllLayers)')
          }
          
          if (mapViewerRef.value.refreshLayerOrder) {
            await mapViewerRef.value.refreshLayerOrder()
            //console.log('‚úÖ Âú∞ÂõæÂõæÂ±ÇÈ°∫Â∫èÂ∑≤ÈáçÊñ∞ÊéíÂàó(refreshLayerOrder)')
          }
          
          // Â¶ÇÊûúÊ≤°Êúâ‰∏ìÈó®ÁöÑÂà∑Êñ∞ÊñπÊ≥ïÔºåÂ∞ùËØïÈáçÊñ∞Âä†ËΩΩÂú∫ÊôØ
          if (mapViewerRef.value.loadScene) {
            await mapViewerRef.value.loadScene(selectedSceneId.value)
            //console.log('‚úÖ Âú∞ÂõæÂú∫ÊôØÂ∑≤ÈáçÊñ∞Âä†ËΩΩ(loadScene)')
          }
        } else {
          console.warn('mapViewerRef‰∏çÂèØÁî®ÔºåÊó†Ê≥ïÂà∑Êñ∞Âú∞Âõæ')
        }
        
        //console.log('‚úÖ ÂõæÂ±ÇÈ°∫Â∫èÂà∑Êñ∞ÂÆåÊàê')
        
      } catch (error) {
        console.error('‚ùå Âà∑Êñ∞ÂõæÂ±ÇÈ°∫Â∫èÂ§±Ë¥•:', error)
        // Â¶ÇÊûúÂà∑Êñ∞Â§±Ë¥•ÔºåËá≥Â∞ëË¶ÅÈáçÊñ∞Ëé∑ÂèñÊï∞ÊçÆ
        try {
          await fetchSceneLayers(selectedSceneId.value)
          //console.log('Â§áÁî®ÊñπÊ°àÔºöÈáçÊñ∞Ëé∑ÂèñÂõæÂ±ÇÊï∞ÊçÆÊàêÂäü')
        } catch (fallbackError) {
          console.error('Â§áÁî®ÊñπÊ°à‰πüÂ§±Ë¥•‰∫Ü:', fallbackError)
        }
      }
    }
    
    // üî• ÊâãÊú∫Á´ØÊäΩÂ±âÊéßÂà∂ÊñπÊ≥ï
    const toggleMobileDrawer = () => {
      mobileDrawerVisible.value = !mobileDrawerVisible.value
      // ÈªòËÆ§ÊòæÁ§∫ÂõæÂ±ÇÊ†áÁ≠æÈ°µ
      if (mobileDrawerVisible.value) {
        mobileActiveTab.value = 'layers'
      }
    }
    
    const closeMobileDrawer = () => {
      mobileDrawerVisible.value = false
      // ÈáçÁΩÆÊãñÊãΩÁä∂ÊÄÅ
      isDragging.value = false
      dragStartY.value = 0
      drawerStartY.value = 0
    }
    
    const selectMobileScene = (sceneId) => {
      // ÈÄâÊã©Âú∫ÊôØÂêéËá™Âä®ÂàáÊç¢Âà∞ÂõæÂ±ÇÊ†áÁ≠æÈ°µ
      onSceneChange(sceneId)
      mobileActiveTab.value = 'layers'
    }
    
    // üî• ÊãñÊãΩÊâãÊüÑ‰∫ã‰ª∂Â§ÑÁêÜ
    const handleDrawerHandleClick = () => {
      // ÁÇπÂáªÊãñÊãΩÊâãÊüÑÁõ¥Êé•ÂÖ≥Èó≠ÊäΩÂ±â
      closeMobileDrawer()
    }
    
    const handleDrawerDragStart = (event) => {
      isDragging.value = true
      
      // ÊîØÊåÅËß¶Êë∏ÂíåÈº†Ê†á‰∫ã‰ª∂
      const clientY = event.touches ? event.touches[0].clientY : event.clientY
      dragStartY.value = clientY
      
      // Ëé∑ÂèñÊäΩÂ±âÂΩìÂâç‰ΩçÁΩÆ
      const drawer = event.target.closest('.mobile-drawer')
      if (drawer) {
        const rect = drawer.getBoundingClientRect()
        drawerStartY.value = rect.top
      }
      
      // ÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫Âíå‰∫ã‰ª∂ÂÜíÊ≥°
      event.preventDefault()
      event.stopPropagation()
      
      // Ê∑ªÂä†ÂÖ®Â±Ä‰∫ã‰ª∂ÁõëÂê¨Âô®
      if (event.touches) {
        document.addEventListener('touchmove', handleDrawerDragMove, { passive: false })
        document.addEventListener('touchend', handleDrawerDragEnd, { once: true })
      } else {
        document.addEventListener('mousemove', handleDrawerDragMove)
        document.addEventListener('mouseup', handleDrawerDragEnd, { once: true })
      }
    }
    
    const handleDrawerDragMove = (event) => {
      if (!isDragging.value) return
      
      // ÊîØÊåÅËß¶Êë∏ÂíåÈº†Ê†á‰∫ã‰ª∂
      const clientY = event.touches ? event.touches[0].clientY : event.clientY
      const deltaY = clientY - dragStartY.value
      
      // Âè™ÊúâÂêë‰∏ãÊãñÊãΩÊâçÊúâÊïàÊûú
      if (deltaY > 10) {
        // ËÆ°ÁÆóÈÄèÊòéÂ∫¶ÔºåË∂äÂæÄ‰∏ãÊãñË∂äÈÄèÊòé
        const opacity = Math.max(0.3, 1 - (deltaY / 200))
        
        // Ëé∑ÂèñÊäΩÂ±âÂÖÉÁ¥†Âπ∂Â∫îÁî®Ê†∑Âºè
        const drawer = document.querySelector('.mobile-drawer')
        if (drawer) {
          drawer.style.transform = `translateY(${deltaY}px)`
          drawer.style.opacity = opacity.toString()
        }
        
        // Â¶ÇÊûúÊãñÊãΩË∑ùÁ¶ªË∂ÖËøáÈòàÂÄºÔºåÂáÜÂ§áÂÖ≥Èó≠
        if (deltaY > 100) {
          const overlay = document.querySelector('.mobile-drawer-overlay')
          if (overlay) {
            overlay.style.opacity = (1 - (deltaY - 100) / 100).toString()
          }
        }
      }
      
      // ÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫
      event.preventDefault()
    }
    
    const handleDrawerDragEnd = (event) => {
      if (!isDragging.value) return
      
      // ÊîØÊåÅËß¶Êë∏ÂíåÈº†Ê†á‰∫ã‰ª∂
      const clientY = event.touches ? 
        (event.changedTouches ? event.changedTouches[0].clientY : dragStartY.value) : 
        event.clientY
      const deltaY = clientY - dragStartY.value
      
      // ÁßªÈô§ÂÖ®Â±Ä‰∫ã‰ª∂ÁõëÂê¨Âô®
      document.removeEventListener('touchmove', handleDrawerDragMove)
      document.removeEventListener('mousemove', handleDrawerDragMove)
      
      // ÈáçÁΩÆÊ†∑Âºè
      const drawer = document.querySelector('.mobile-drawer')
      if (drawer) {
        drawer.style.transform = ''
        drawer.style.opacity = ''
      }
      
      const overlay = document.querySelector('.mobile-drawer-overlay')
      if (overlay) {
        overlay.style.opacity = ''
      }
      
      // Â¶ÇÊûúÂêë‰∏ãÊãñÊãΩË∑ùÁ¶ªË∂≥Â§üÔºåÂÖ≥Èó≠ÊäΩÂ±â
      if (deltaY > 80) {
        closeMobileDrawer()
      }
      
      // ÈáçÁΩÆÊãñÊãΩÁä∂ÊÄÅ
      isDragging.value = false
      dragStartY.value = 0
      drawerStartY.value = 0
    }
    
    return {
      sceneList,
      selectedSceneId,
      layersList,
      sortedLayersList,
      loading,
      layerInfoDialogVisible,
      currentLayerInfo,
      mapViewerRef,
      layerPanelCollapsed,
      currentActiveLayer,
      fetchSceneList,
      onSceneChange,
      refreshScene,
      toggleLayerPanel,
      goToSceneManage,
      toggleLayerVisibility,
      onLayerOpacityChange,
      moveLayerUp,
      moveLayerDown,
      handleLayerAction,
      zoomToLayer,
      handleCollapsedLayerDblClick,
      showLayerInfo,
      removeLayer,
      showAddLayerDialog,
      showStyleDialog,
      onLayerAdded,
      getServiceTypeClass,
      getServiceTypeText,
      getLayerStatusClass,
      getLayerStatusText,
      selectLayer,
      onLayerSelected,
      getLayerTypeColor,
      isCurrentLayerInteractive,
      resetAllLayers,
      sceneDialogVisible,
      editingScene,
      sceneForm,
      showCreateSceneDialog,
      editScene,
      saveScene,
      deleteScene,
      getLayerCountText,
      
      // ÊãñÊãΩÁõ∏ÂÖ≥
      draggingLayerId,
      handleDragStart,
      handleDragEnd,
      handleDragOver,
      handleDrop,
      
      // üî• ÊâãÊú∫Á´ØÊäΩÂ±âÁõ∏ÂÖ≥
      mobileDrawerVisible,
      mobileActiveTab,
      toggleMobileDrawer,
      closeMobileDrawer,
      selectMobileScene,
      
      // üî• ÊãñÊãΩÊâãÊüÑÁõ∏ÂÖ≥
      isDragging,
      handleDrawerHandleClick,
      handleDrawerDragStart
    }
  }
}
</script>

<style scoped>
.map-view {
  height: 100%; /* üî• ‰ΩøÁî®100%ÈÄÇÂ∫îÁà∂ÂÆπÂô®(el-main)ÁöÑÈ´òÂ∫¶Ôºöcalc(100vh - 60px) */
  width: 100%; /* üî• Á°Æ‰øùÂÆΩÂ∫¶‰πüÊòØ100% */
  overflow: hidden;
  display: flex;
  flex-direction: column;
  margin: 0 !important; /* üî• Âº∫Âà∂ÁßªÈô§Â§ñËæπË∑ùÔºåÊ∂àÈô§‰∏éel-mainÁöÑÁôΩËæπ */
  padding: 0 !important; /* üî• Âº∫Âà∂ÁßªÈô§ÂÜÖËæπË∑ù */
  border: none !important; /* üî• ÁßªÈô§ËæπÊ°Ü */
  background: transparent !important; /* üî• ÈÄèÊòéËÉåÊôØ */
  box-sizing: border-box !important; /* üî• Á°Æ‰øùÁõíÊ®°ÂûãÊ≠£Á°Æ */
}

.map-content {
  flex: 1;
  display: flex;
  flex-direction: row;
  height: 100%;
  width: 100%; /* üî• Á°Æ‰øùÂÆΩÂ∫¶100% */
  overflow: hidden;
  margin: 0; /* üî• ÁßªÈô§Â§ñËæπË∑ù */
  padding: 0; /* üî• ÁßªÈô§ÂÜÖËæπË∑ù */
  border: none; /* üî• ÁßªÈô§ËæπÊ°Ü */
  background: transparent; /* üî• ÈÄèÊòéËÉåÊôØ */
}

.layer-panel {
  width: 350px;
  background: #f8f9fa;
  border-right: 1px solid #dee2e6;
  display: flex;
  flex-direction: column;
  transition: width 0.3s ease;
  flex-shrink: 0; /* Èò≤Ê≠¢Èù¢ÊùøË¢´ÂéãÁº© */
  height: 100%;
  overflow: hidden;
  position: relative;
  box-sizing: border-box;
  margin: 0; /* üî• ÁßªÈô§Â§ñËæπË∑ù */
  padding: 0; /* üî• ÁßªÈô§ÂÜÖËæπË∑ù */
}

.layer-panel.collapsed {
  width: 48px !important;
  min-width: 48px !important;
  max-width: 48px !important;
  flex-basis: 48px !important;
}

.map-container-wrapper {
  flex: 1;
  position: relative;
  overflow: hidden;
  background: transparent; /* üî• ÁßªÈô§ÁôΩËâ≤ËÉåÊôØÔºå‰ΩøÁî®ÈÄèÊòéËÉåÊôØ */
  min-height: 0; /* Èò≤Ê≠¢flexÂÆπÂô®È´òÂ∫¶ËÆ°ÁÆóÈóÆÈ¢ò */
  contain: layout style; /* CSS containment ‰ºòÂåñ */
  height: 100%;
  width: 100%; /* üî• Á°Æ‰øùÂÆΩÂ∫¶‰πüÊòØ100% */
  margin: 0; /* üî• ÁßªÈô§Â§ñËæπË∑ù */
  padding: 0; /* üî• ÁßªÈô§ÂÜÖËæπË∑ù */
  border: none; /* üî• ÁßªÈô§ËæπÊ°Ü */
  outline: none; /* üî• ÁßªÈô§ËΩÆÂªì */
}

.map-container-wrapper.with-panel {
  /* ÂΩìÈù¢ÊùøÂ±ïÂºÄÊó∂‰∏çÈúÄË¶ÅÈ¢ùÂ§ñÁöÑmargin */
}

.panel-header {
  padding: 15px;
  background: #fff;
  border-bottom: 1px solid #dee2e6;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.panel-header h3 {
  margin: 0;
  font-size: 16px;
  color: #333;
}

.collapse-btn {
  padding: 4px;
  font-size: 16px;
}

.scene-content, .layer-content {
  flex: 1;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.scene-actions, .layer-actions {
  padding: 15px;
  border-bottom: 1px solid #dee2e6;
}

.scene-list, .layer-list {
  flex: 1;
  overflow-y: auto;
  padding: 0;
}

.scene-item, .layer-item {
  padding: 15px;
  border-bottom: 1px solid #eee;
  cursor: pointer;
  transition: background-color 0.2s;
}

.scene-item:hover, .layer-item:hover {
  background-color: #f0f0f0;
}

.scene-item.active, .layer-item.active {
  background-color: #e3f2fd;
  border-left: 3px solid #409EFF;
}

.scene-info {
  margin-bottom: 10px;
}

.scene-name {
  font-weight: bold;
  color: #333;
  margin-bottom: 5px;
}

.scene-desc {
  font-size: 12px;
  color: #666;
  margin-bottom: 8px;
  line-height: 1.4;
}

.scene-meta {
  display: flex;
  justify-content: space-between;
  font-size: 11px;
  color: #999;
}

.scene-actions {
  display: flex;
  gap: 5px;
}

.layer-header {
  display: flex;
  align-items: center;
  gap: 10px;
}

.layer-visibility {
  flex-shrink: 0;
}

.layer-info {
  flex: 1;
  min-width: 0;
}

.layer-name {
  font-weight: bold;
  color: #333;
  margin-bottom: 5px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.layer-meta {
  display: flex;
  gap: 8px;
  font-size: 11px;
}

.service-type {
  padding: 2px 6px;
  border-radius: 3px;
  color: white;
  font-weight: bold;
}

.service-type.martin {
  background-color: #28a745;
}

.service-type.geoserver {
  background-color: #007bff;
}

.file-type {
  color: #666;
  text-transform: uppercase;
  font-weight: bold;
}

.layer-controls {
  flex-shrink: 0;
}

.no-scene {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  background: #f8f9fa;
}

.no-scene-content {
  text-align: center;
  color: #666;
}

.no-scene-content i {
  font-size: 64px;
  margin-bottom: 20px;
  color: #ccc;
}

.no-scene-content h3 {
  margin: 0 0 10px 0;
  color: #333;
}

.no-scene-content p {
  margin: 0;
  color: #666;
}

.danger {
  color: #f56c6c;
}

.empty-layers {
  padding: 40px 20px;
  text-align: center;
  color: #909399;
}

.empty-layers i {
  font-size: 48px;
  margin-bottom: 15px;
  color: #c0c4cc;
}

.empty-layers p {
  margin: 15px 0;
  font-size: 14px;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 10px;
}

.panel-toggle-btn {
  padding: 4px 8px !important;
  background: transparent;
  border: 1px solid #dcdfe6;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.panel-toggle-btn:hover {
  background: #ecf5ff;
  border-color: #409eff;
}

.toggle-icon {
  font-size: 14px;
  color: #606266;
  font-weight: bold;
}

.panel-toggle-btn:hover .toggle-icon {
  color: #409eff;
}

.collapsed-toggle {
  height: 40px;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  border-bottom: 1px solid #e4e7ed;
  background: #f5f7fa;
  transition: all 0.3s ease;
  flex-shrink: 0;
}

.collapsed-toggle:hover {
  background: #e6f1fc;
}

.expand-btn {
  padding: 8px 12px !important;
  background: transparent;
  border: 1px solid #dcdfe6;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.expand-btn:hover {
  background: #ecf5ff;
  border-color: #409eff;
}

.expand-btn .toggle-icon {
  font-size: 16px;
  color: #606266;
  font-weight: bold;
}

.expand-btn:hover .toggle-icon {
  color: #409eff;
}

/* Êî∂Ëµ∑Áä∂ÊÄÅ‰∏ãÁöÑÂÜÖÂÆπÊ†∑Âºè */
.collapsed-content {
  height: 100%;
  display: flex;
  flex-direction: column;
  background: #f8f9fa;
}

/* Êî∂Ëµ∑Áä∂ÊÄÅ‰∏ãÁöÑÂú∫ÊôØÈÄâÊã©Ê†∑Âºè */
.collapsed-scene-selector {
  padding: 8px 0 5px 0;
  border-bottom: 1px solid #e4e7ed;
}

.collapsed-section-title {
  font-size: 8px;
  color: #909399;
  text-align: center;
  margin-bottom: 4px;
  font-weight: 500;
  letter-spacing: 0.5px;
}

.collapsed-scene-item {
  position: relative;
  height: 32px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
  margin: 1px 2px;
  background: rgba(255, 255, 255, 0.6);
  border-radius: 2px;
  user-select: none;
}

.collapsed-scene-item:hover {
  background: rgba(103, 194, 58, 0.1);
  cursor: pointer;
}

.collapsed-scene-item:active {
  transform: scale(0.95);
  background: rgba(103, 194, 58, 0.2);
}

.collapsed-scene-item.active {
  background: rgba(103, 194, 58, 0.15);
  border-left: 3px solid #67c23a;
}

.scene-short-name {
  font-size: 11px;
  font-weight: 600;
  color: #67c23a;
  text-align: center;
  line-height: 1.1;
  max-width: 36px;
  word-break: break-all;
  padding: 0 2px;
}

.collapsed-scene-item.active .scene-short-name {
  color: #5ca632;
}

.scene-active-dot {
  position: absolute;
  bottom: 3px;
  left: 50%;
  transform: translateX(-50%);
  width: 3px;
  height: 3px;
  border-radius: 50%;
  background: #67c23a;
}

/* ÂàÜÈöîÁ∫øÊ†∑Âºè */
.collapsed-separator {
  height: 1px;
  background: linear-gradient(90deg, transparent, #e4e7ed 20%, #e4e7ed 80%, transparent);
  margin: 5px 4px;
}

.collapsed-layers {
  flex: 1;
  overflow-y: auto;
  padding: 5px 0;
}

.collapsed-layer-item {
  position: relative;
  height: 36px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
  margin-bottom: 1px;
  background: rgba(255, 255, 255, 0.8);
  border-radius: 2px;
  margin: 1px 2px;
  user-select: none; /* Èò≤Ê≠¢ÂèåÂáªÊó∂ÈÄâ‰∏≠ÊñáÊú¨ */
}

.collapsed-layer-item:hover {
  background: rgba(64, 158, 255, 0.1);
  cursor: pointer;
}

/* ÂèåÂáªÊó∂ÁöÑÂèçÈ¶àÊïàÊûú */
.collapsed-layer-item:active {
  transform: scale(0.95);
  background: rgba(64, 158, 255, 0.2);
}

/* ÂèåÂáªÂä®ÁîªÊïàÊûú */
@keyframes dblclick-zoom {
  0% { transform: scale(1); }
  50% { transform: scale(0.9); }
  100% { transform: scale(1); }
}

.collapsed-layer-item.zoom-animation {
  animation: dblclick-zoom 0.2s ease-in-out;
}

.collapsed-layer-item.active {
  background: rgba(64, 158, 255, 0.15);
  border-left: 3px solid #409eff;
}

.collapsed-layer-item.invisible {
  opacity: 0.5;
}

.visibility-indicator {
  position: absolute;
  top: 3px;
  right: 3px;
  width: 5px;
  height: 5px;
  border-radius: 50%;
  background: #dcdfe6;
  transition: all 0.2s ease;
}

.visibility-indicator.visible {
  background: #67c23a;
}

.layer-short-name {
  font-size: 10px;
  font-weight: 500;
  color: #303133;
  text-align: center;
  line-height: 1.1;
  max-width: 36px;
  word-break: break-all;
  padding: 0 2px;
}

.collapsed-layer-item.invisible .layer-short-name {
  color: #909399;
}

.active-dot {
  position: absolute;
  bottom: 3px;
  left: 50%;
  transform: translateX(-50%);
  width: 3px;
  height: 3px;
  border-radius: 50%;
  background: #409eff;
}

.collapsed-empty {
  padding: 20px 0;
  text-align: center;
  color: #c0c4cc;
}

.collapsed-empty i {
  font-size: 20px;
  margin-bottom: 4px;
}

.collapsed-empty .empty-text {
  font-size: 9px;
  color: #c0c4cc;
  text-align: center;
}

/* Êî∂Ëµ∑Áä∂ÊÄÅ‰∏ãÁöÑÊªöÂä®Êù°Ê†∑Âºè */
.collapsed-layers::-webkit-scrollbar {
  width: 3px;
}

.collapsed-layers::-webkit-scrollbar-track {
  background: transparent;
}

.collapsed-layers::-webkit-scrollbar-thumb {
  background: rgba(0, 0, 0, 0.2);
  border-radius: 2px;
}

.collapsed-layers::-webkit-scrollbar-thumb:hover {
  background: rgba(0, 0, 0, 0.3);
}



/* ÂõæÂ±ÇÂç°ÁâáÊ†∑Âºè - Á¥ßÂáëÂûã */
.layer-cards {
  padding: 0;
  overflow-y: auto;
  max-height: 100%;
  /* CSSÂèòÈáèÂÆö‰πâ - Á¥ßÂáëÊ®°Âºè */
  --layer-card-spacing: 4px;
  --layer-card-padding: 6px 10px;
  --layer-card-border-radius: 6px;
  --layer-info-spacing: 2px;
  --tag-padding: 0px 4px;
}

.layer-card {
  background: white;
  border: 1px solid #e4e7ed;
  border-radius: var(--layer-card-border-radius);
  margin-bottom: var(--layer-card-spacing);
  cursor: pointer;
  transition: all 0.25s ease;
  position: relative;
}

.layer-card:hover {
  box-shadow: 0 1px 8px rgba(0, 0, 0, 0.08);
  border-color: #c6e2ff;
}

.layer-card.active {
  border-color: #409eff;
  box-shadow: 0 1px 8px rgba(64, 158, 255, 0.15);
}

.layer-card.invisible {
  opacity: 0.6;
}

.layer-card.dragging {
  opacity: 0.7;
  transform: scale(0.98) rotate(1deg);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
  z-index: 1000;
  transition: all 0.2s ease;
}

.layer-card[draggable="true"] {
  cursor: grab;
}

.layer-card[draggable="true"]:active {
  cursor: grabbing;
}

.layer-card-header {
  padding: var(--layer-card-padding);
  display: flex;
  align-items: center;
  justify-content: space-between;
  min-height: 32px;
}

.layer-title {
  display: flex;
  align-items: center;
  gap: 6px;
  flex: 1;
  min-width: 0;
}

.layer-name {
  font-weight: 500;
  color: #303133;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-size: 12px;
  line-height: 1.3;
}

.active-indicator {
  color: #409eff;
  font-size: 14px;
  margin-right: 3px;
}

.layer-drag-handle {
  color: #c0c4cc;
  cursor: grab;
  margin-right: 6px;
  font-size: 14px;
}

.layer-drag-handle:hover {
  color: #909399;
}

.layer-actions {
  display: flex;
  gap: 2px;
  opacity: 1; /* üî• ‰øÆÂ§çÔºöÈªòËÆ§ÊòæÁ§∫Ôºå‰∏çÈúÄË¶ÅhoverÊâçÊòæÁ§∫ */
  transition: opacity 0.2s;
}

/* üî• ‰øùÁïôhoverÊïàÊûúÁî®‰∫éÂº∫Ë∞ÉÔºå‰ΩÜ‰∏çÂΩ±ÂìçÂü∫Á°ÄÊòæÁ§∫ */
.layer-card:hover .layer-actions {
  opacity: 1;
}

.layer-actions .el-button {
  padding: 3px;
  width: 20px;
  height: 20px;
  border: 1px solid #e4e7ed; /* üî• Ê∑ªÂä†ËæπÊ°ÜËÆ©ÊåâÈíÆÊõ¥ÊòéÊòæ */
  background: rgba(255, 255, 255, 0.8); /* üî• Ê∑ªÂä†ÂçäÈÄèÊòéËÉåÊôØ */
  color: #606266;
  transition: all 0.2s;
  border-radius: 4px; /* üî• Ê∑ªÂä†ÂúÜËßí */
  opacity: 1 !important; /* üî• Á°Æ‰øùÂßãÁªàÂèØËßÅ */
  visibility: visible !important; /* üî• Á°Æ‰øùÂßãÁªàÂèØËßÅ */
}

.layer-actions .zoom-btn:hover {
  color: #409eff;
  background: #ecf5ff;
}

.layer-actions .style-btn:hover {
  color: #67c23a;
  background: #f0f9ff;
}

.layer-actions .remove-btn:hover {
  color: #f56c6c;
  background: #fef0f0;
}

.layer-card-info {
  padding: var(--layer-info-spacing) 12px 8px;
  display: flex;
  gap: var(--layer-info-spacing);
  flex-wrap: wrap;
}

.tag {
  display: inline-block;
  padding: var(--tag-padding);
  font-size: 9px;
  border-radius: 8px;
  background: #f4f4f5;
  color: #909399;
  border: 1px solid transparent;
  line-height: 1.3;
}

/* ÊúçÂä°Á±ªÂûãÊ†∑Âºè */
.tag.service-martin {
  background: #f0f9ff;
  color: #67c23a;
  border-color: #b3e19d;
}

.tag.service-geoserver {
  background: #ecf5ff;
  color: #409eff;
  border-color: #b3d8ff;
}

/* Áä∂ÊÄÅÊ†∑Âºè */
.tag.status-published {
  background: #f0f9ff;
  color: #67c23a;
  border-color: #b3e19d;
}

.tag.status-unpublished {
  background: #fef0f0;
  color: #f56c6c;
  border-color: #fbc4c4;
}

.scene-selector {
  padding: 0 15px 12px;
}

.layer-count {
  font-size: 12px;
  color: #909399;
  margin-right: 10px;
}

.panel-body {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
  max-height: calc(100% - 120px); /* ÂáèÂéªÈù¢ÊùøÂ§¥ÈÉ®ÂíåÂú∫ÊôØÈÄâÊã©Âô®ÁöÑÈ´òÂ∫¶ */
}

.panel-content {
  height: 100%;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* üî• ÈÄèÊòéÂ∫¶ÊéßÂà∂Ê†∑Âºè - Á¥ßÂáëÂûã */
.layer-opacity-control {
  padding: 4px 12px 6px;
  background: #fafbfc;
  border-top: 1px solid #f0f0f0;
  margin: 0;
  border-radius: 0 0 6px 6px;
}

.opacity-row {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  color: #606266;
  min-height: 20px;
}

.opacity-icon {
  font-size: 11px;
  color: #909399;
  flex-shrink: 0;
}

.opacity-text {
  font-size: 9px;
  color: #606266;
  white-space: nowrap;
  flex-shrink: 0;
}

.opacity-value {
  font-weight: 500;
  color: #409eff;
  font-size: 9px;
  min-width: 28px;
  text-align: right;
  flex-shrink: 0;
}

.opacity-slider {
  flex: 1;
  margin: 0 6px;
}

.opacity-slider .el-slider__runway {
  height: 3px;
  background-color: #e4e7ed;
  margin: 8px 0;
}

.opacity-slider .el-slider__bar {
  height: 3px;
  background-color: #409eff;
}

.opacity-slider .el-slider__button {
  width: 10px;
  height: 10px;
  border: 2px solid #409eff;
  background-color: #fff;
}

.opacity-slider .el-slider__button:hover {
  transform: scale(1.1);
}

/* ÂΩìÂõæÂ±ÇÂç°ÁâáË¢´ÊãñÊãΩÊó∂ÈöêËóèÈÄèÊòéÂ∫¶ÊéßÂà∂ */
.layer-card.dragging .layer-opacity-control {
  opacity: 0.3;
  pointer-events: none;
}

/* ÈöêËóèÁä∂ÊÄÅÁöÑÂõæÂ±ÇÔºåÈÄèÊòéÂ∫¶ÊéßÂà∂‰πüÁõ∏Â∫îË∞ÉÊï¥ */
.layer-card.invisible .layer-opacity-control {
  opacity: 0.6;
}

/* üî• ÊâãÊú∫Á´Ø‰∏ìÁî®Ê†∑Âºè - Ê°åÈù¢Á´ØÈöêËóèÁßªÂä®Á´ØÁªÑ‰ª∂ */
.mobile-layer-fab,
.mobile-drawer-overlay {
  display: none;
}

/* Ê°åÈù¢Á´ØÊòæÁ§∫‰æßËæπÊ†èÔºåÊâãÊú∫Á´ØÈöêËóè */
.desktop-only {
  display: block;
}

/* üî• Ê°åÈù¢Á´ØÈù¢ÊùøÊî∂Áº©ÂäüËÉΩÊ†∑ÂºèÂä†Âº∫ */
@media (min-width: 769px) {
  .layer-panel {
    width: 350px !important;
    transition: width 0.3s cubic-bezier(0.25, 0.8, 0.25, 1) !important;
    background: #f8f9fa !important; /* Ë∞ÉËØïÁî®ËÉåÊôØËâ≤ */
  }
  
  .layer-panel.collapsed {
    width: 48px !important;
    min-width: 48px !important;
    max-width: 48px !important;
    background: #e8f4f8 !important; /* Êî∂Ëµ∑Áä∂ÊÄÅË∞ÉËØïÁî®ËÉåÊôØËâ≤ */
  }
  
  .map-container-wrapper {
    transition: margin-left 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
  }
  
  /* Á°Æ‰øùÊî∂Ëµ∑Áä∂ÊÄÅ‰∏ãÂÜÖÂÆπÊ≠£Á°ÆÊòæÁ§∫ */
  .layer-panel.collapsed .panel-content {
    display: none !important;
  }
  
  .layer-panel.collapsed .collapsed-content {
    display: flex !important;
    flex-direction: column;
    height: 100%;
  }
  
  /* üî• Á°Æ‰øùÊ°åÈù¢Á´ØÊìç‰ΩúÊåâÈíÆÂßãÁªàÂèØËßÅ */
  .layer-actions {
    opacity: 1 !important;
    display: flex !important;
  }
  
  .layer-actions .el-button {
    opacity: 1 !important;
    visibility: visible !important;
  }
}

/* üî• ÊâãÊú∫Á´ØÂ∫ïÈÉ®ÊµÆÂä®ÊåâÈíÆÂíåÊäΩÂ±âÊ†∑Âºè */
@media (max-width: 768px) {
  /* üî• Á°Æ‰øùÊâãÊú∫Á´ØÊ≤°ÊúâÁôΩËæπÂíåÈ´òÂ∫¶ÈóÆÈ¢ò */
  .map-view {
    height: 100% !important;
    width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
    overflow: hidden !important;
  }
  
  .map-content {
    height: 100% !important;
    width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
  }
  
  .map-container-wrapper {
    height: 100% !important;
    width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
  }
  
  /* ÈöêËóèÊ°åÈù¢Á´Ø‰æßËæπÊ†è */
  .desktop-only {
    display: none !important;
  }
  
  /* ÊòæÁ§∫ÊâãÊú∫Á´ØÁªÑ‰ª∂ */
  .mobile-layer-fab,
  .mobile-drawer-overlay {
    display: block;
  }
  
  /* üî• Á°Æ‰øùElement PlusÂØπËØùÊ°ÜÂú®ÊâãÊú∫Á´ØËÉΩÊ≠£Á°ÆÊòæÁ§∫Âú®ÊäΩÂ±âÂâçÈù¢ */
  :deep(.el-dialog__wrapper) {
    z-index: 2000 !important;
  }
  
  :deep(.el-overlay) {
    z-index: 2000 !important;
  }
  
  /* Âú∞ÂõæÂÆπÂô®Âç†Êª°ÂÖ®Â±è */
  .map-container-wrapper {
    width: 100% !important;
    margin-left: 0 !important;
  }
  
  /* Á°Æ‰øùÊâãÊú∫Á´Ø‰∏çÂèóÊ°åÈù¢Á´ØÈù¢ÊùøÊ†∑ÂºèÂΩ±Âìç */
  .layer-panel {
    display: none !important;
  }
  
  /* Â∫ïÈÉ®ÊµÆÂä®ÊåâÈíÆ */
  .mobile-layer-fab {
    position: fixed;
    bottom: 10px;
    left: 10px;
    z-index: 999; /* üî• ‰øùÊåÅËæÉ‰ΩéÁöÑz-indexÔºåÁ°Æ‰øùÂØπËØùÊ°ÜËÉΩÊòæÁ§∫Âú®ÂâçÈù¢ */
    background: linear-gradient(135deg, #409eff, #337ecc);
    border-radius: 50px;
    box-shadow: 0 4px 12px rgba(64, 158, 255, 0.4);
    cursor: pointer;
    transition: all 0.3s ease;
    user-select: none;
  }
  
  .mobile-layer-fab:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 16px rgba(64, 158, 255, 0.5);
  }
  
  .mobile-layer-fab:active {
    transform: scale(0.95);
  }
  
  .fab-content {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 14px 20px;
    color: white;
    font-weight: 500;
    position: relative;
  }
  
  .fab-content i {
    font-size: 18px;
  }
  
  .fab-text {
    font-size: 14px;
    font-weight: 600;
  }
  
  .fab-badge {
    position: absolute;
    top: -6px;
    right: -6px;
    background: #f56c6c;
    color: white;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: bold;
    border: 2px solid white;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }
  
  /* üî• ÊäΩÂ±âÈÅÆÁΩ©Â±Ç */
  .mobile-drawer-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0);
    z-index: 1500; /* üî• Èôç‰Ωéz-indexÔºåÁ°Æ‰øùElement PlusÂØπËØùÊ°ÜËÉΩÊòæÁ§∫Âú®ÂâçÈù¢ */
    transition: all 0.3s ease;
    pointer-events: none;
  }
  
  .mobile-drawer-overlay.show {
    background: rgba(0, 0, 0, 0.5);
    pointer-events: all;
    backdrop-filter: blur(4px);
  }
  
  /* üî• ÊäΩÂ±âÈù¢Êùø */
  .mobile-drawer {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    border-radius: 20px 20px 0 0;
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    max-height: 75vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.15);
    overflow: hidden;
    /* üî• ‰∏∫ÊãñÊãΩÂáÜÂ§áÁöÑÂèòÈáè */
    --drawer-opacity: 1;
    opacity: var(--drawer-opacity);
  }
  
  .mobile-drawer.show {
    transform: translateY(0);
  }
  
  /* ÊäΩÂ±âÂ§¥ÈÉ® */
  .mobile-drawer-header {
    padding: 15px 20px 10px;
    border-bottom: 1px solid #f0f0f0;
    flex-shrink: 0;
    background: white;
  }
  
  .drawer-handle {
    width: 50px; /* üî• ÊâãÊú∫Â∫îÁî®Â∏∏ËßÅÁöÑÁü≠Ê®™Á∫øÂÆΩÂ∫¶ */
    height: 4px; /* üî• ÈÄÇ‰∏≠ÁöÑÈ´òÂ∫¶ */
    background: #e4e7ed; /* üî• Êõ¥Ê∑°ÁöÑÈ¢úËâ≤Ôºå‰ΩéË∞É‰∏çÊòæÁúº */
    border-radius: 2px; /* üî• ÂúÜÊ∂¶ÁöÑÂúÜËßí */
    margin: 8px auto 16px; /* üî• ‰∏ä‰∏ãÈó¥Ë∑ùÔºåÂ±Ö‰∏≠ */
    cursor: grab; /* üî• ÊòæÁ§∫ÊãñÊãΩÂÖâÊ†á */
    transition: all 0.15s ease; /* üî• Êõ¥Âø´ÁöÑËøáÊ∏° */
    position: relative;
    user-select: none; /* üî• Èò≤Ê≠¢ÈÄâ‰∏≠ÊñáÊú¨ */
    opacity: 0.6; /* üî• Êõ¥ÈÄèÊòéÔºåÊõ¥‰ΩéË∞É */
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08); /* üî• ÂæÆÂ¶ôÁöÑÈò¥ÂΩ± */
  }

  /* üî• ‰∏∫‰∫ÜÂ¢ûÂä†ÁÇπÂáªÂå∫ÂüüÔºå‰ΩøÁî®‰º™ÂÖÉÁ¥† */
  .drawer-handle::before {
    content: '';
    position: absolute;
    top: -8px;
    left: -8px;
    right: -8px;
    bottom: -8px;
    cursor: grab;
  }
  
  .drawer-handle:hover {
    background: #d3d4d6; /* üî• ÊÇ¨ÂÅúÊó∂Á®çÂæÆÊ∑±‰∏ÄÁÇπÔºå‰ΩÜ‰ªçÁÑ∂‰ΩéË∞É */
    opacity: 1; /* üî• ÊÇ¨ÂÅúÊó∂‰∏çÈÄèÊòé */
    cursor: grab;
  }
  
  .drawer-handle:active,
  .drawer-handle.dragging {
    background: #c0c4cc; /* üî• ÊãñÊãΩÊó∂Á®çÂæÆÊ∑±‰∏ÄÁÇπ */
    opacity: 1; /* üî• ÊãñÊãΩÊó∂‰∏çÈÄèÊòé */
    cursor: grabbing; /* üî• ÊãñÊãΩÂÖâÊ†á */
  }

  .drawer-handle:active::before,
  .drawer-handle.dragging::before {
    cursor: grabbing; /* üî• ‰º™ÂÖÉÁ¥†‰πüË¶ÅÊîπÂèòÂÖâÊ†á */
  }
  
  .drawer-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .drawer-title h3 {
    margin: 0;
    font-size: 18px;
    color: #303133;
    font-weight: 600;
  }
  
  .drawer-actions {
    display: flex;
    gap: 8px;
  }
  
  .drawer-actions .el-button {
    border-radius: 8px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 4px; /* üî• ÂõæÊ†áÂíåÊñáÂ≠óÈó¥Ë∑ù */
    padding: 8px 12px; /* üî• Ë∞ÉÊï¥ÂÜÖËæπË∑ùÈÄÇÂ∫îÊñáÂ≠ó */
  }
  
  .drawer-actions .el-button i {
    font-size: 14px; /* üî• Á°Æ‰øùÂõæÊ†áÂ§ßÂ∞èÂêàÈÄÇ */
  }
  
  .drawer-actions .el-button span {
    font-size: 13px; /* üî• ÊñáÂ≠óÂ§ßÂ∞è */
    white-space: nowrap; /* üî• Èò≤Ê≠¢ÊñáÂ≠óÊç¢Ë°å */
  }
  
  /* ÊäΩÂ±âÂÜÖÂÆπ */
  .mobile-drawer-content {
    flex: 1;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    background: white;
  }
  
  /* üî• Ê†áÁ≠æÈ°µÂàáÊç¢ */
  .mobile-tabs {
    display: flex;
    background: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
    flex-shrink: 0;
  }
  
  .mobile-tab {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 15px 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: #606266;
    font-size: 14px;
    position: relative;
    font-weight: 500;
  }
  
  .mobile-tab.active {
    color: #409eff;
    background: white;
    font-weight: 600;
  }
  
  .mobile-tab.active::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: #409eff;
    border-radius: 3px 3px 0 0;
  }
  
  .mobile-tab i {
    font-size: 16px;
  }
  
  .tab-badge {
    position: absolute;
    top: 8px;
    right: 12px;
    background: #409eff;
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: bold;
  }
  
  /* Ê†áÁ≠æÈ°µÂÜÖÂÆπ */
  .mobile-tab-content {
    flex: 1;
    overflow-y: auto;
    background: white;
  }
  
  /* üî• ÊâãÊú∫Á´ØÂú∫ÊôØÂàóË°® */
  .mobile-scene-list {
    padding: 0;
  }
  
  .mobile-scene-item {
    padding: 18px 20px;
    border-bottom: 1px solid #f5f5f5;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
  }
  
  .mobile-scene-item:hover {
    background: #f8f9fa;
  }
  
  .mobile-scene-item.active {
    background: linear-gradient(135deg, #ecf5ff, #f0f9ff);
    border-left: 4px solid #409eff;
    border-bottom-color: #e1f0fe;
  }
  
  .mobile-scene-item .scene-info h4 {
    margin: 0 0 6px 0;
    font-size: 16px;
    color: #303133;
    font-weight: 600;
  }
  
  .mobile-scene-item .scene-info p {
    margin: 0;
    font-size: 13px;
    color: #909399;
    line-height: 1.4;
  }
  
  .mobile-scene-item.active .scene-info h4 {
    color: #409eff;
  }
  
  .mobile-scene-item .scene-meta {
    flex-shrink: 0;
  }
  
  /* üî• ÊâãÊú∫Á´ØÂõæÂ±ÇÂàóË°® */
  .mobile-layer-list {
    padding: 0;
  }
  
  .mobile-layer-item {
    padding: 16px 18px; /* üî• ‰ºòÂåñÂÜÖËæπË∑ù */
    border-bottom: 1px solid #f5f5f5;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    justify-content: space-between;
    align-items: stretch; /* üî• ËÆ©ÂÜÖÂÆπÂå∫ÂüüÂíåÊåâÈíÆÂå∫ÂüüÂêåÊ†∑È´òÂ∫¶ */
    gap: 12px; /* üî• ÂÜÖÂÆπÂíåÊåâÈíÆÈó¥Ë∑ù */
    background: white;
    min-height: 120px; /* üî• Á°Æ‰øùÊúâË∂≥Â§üÈ´òÂ∫¶ */
    position: relative; /* üî• ‰∏∫ÂêéÁª≠ÂæÆË∞ÉÊèê‰æõÂÆö‰Ωç‰∏ä‰∏ãÊñá */
  }
  
  .mobile-layer-item:hover {
    background: #f8f9fa;
  }
  
  .mobile-layer-item.active {
    background: linear-gradient(135deg, #ecf5ff, #f0f9ff);
    border-left: 4px solid #409eff;
    border-bottom-color: #e1f0fe;
  }
  
  .mobile-layer-item.invisible {
    opacity: 0.6;
  }
  
  .layer-main-info {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    justify-content: center; /* üî• ËÆ©ÂÜÖÂÆπÂú®ÂûÇÁõ¥ÊñπÂêë‰∏äÂ±Ö‰∏≠ */
    padding: 2px 0; /* üî• ÂæÆË∞ÉÂûÇÁõ¥Èó¥Ë∑ù */
  }
  
  .layer-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 10px;
  }
  
  .layer-header .layer-name {
    flex: 1;
    font-size: 16px;
    font-weight: 600;
    color: #303133;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .mobile-layer-item.active .layer-header .layer-name {
    color: #409eff;
  }
  
  .layer-header .active-indicator {
    color: #409eff;
    font-size: 16px;
  }
  
  .layer-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 12px;
  }
  
  .layer-tags .tag {
    font-size: 11px;
    padding: 3px 8px;
    border-radius: 12px;
    background: #f4f4f5;
    color: #909399;
    font-weight: 500;
  }
  
  .layer-tags .tag.service-martin {
    background: #f0f9ff;
    color: #67c23a;
    border: 1px solid #c9e9d0;
  }
  
  .layer-tags .tag.service-geoserver {
    background: #ecf5ff;
    color: #409eff;
    border: 1px solid #b3d8ff;
  }
  
  /* ÊâãÊú∫Á´ØÈÄèÊòéÂ∫¶ÊéßÂà∂ */
  .mobile-opacity-control {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 8px;
    padding: 8px 12px;
    background: #fafbfc;
    border-radius: 8px;
    border: 1px solid #f0f0f0;
  }
  
  .opacity-label {
    font-size: 12px;
    color: #606266;
    white-space: nowrap;
    font-weight: 500;
  }
  
  .mobile-opacity-slider {
    flex: 1;
    margin: 0 8px;
  }
  
  .mobile-opacity-slider .el-slider__runway {
    height: 6px;
    background-color: #e4e7ed;
    border-radius: 3px;
  }
  
  .mobile-opacity-slider .el-slider__bar {
    height: 6px;
    background: linear-gradient(90deg, #409eff, #36a3f7);
    border-radius: 3px;
  }
  
  .mobile-opacity-slider .el-slider__button {
    width: 18px;
    height: 18px;
    border: 3px solid #409eff;
    background-color: #fff;
    box-shadow: 0 2px 6px rgba(64, 158, 255, 0.3);
  }
  
  .mobile-opacity-control .opacity-value {
    font-size: 12px;
    color: #409eff;
    font-weight: 600;
    min-width: 35px;
    text-align: right;
  }
  
  .layer-actions {
    display: flex !important; /* üî• Âº∫Âà∂ÊòæÁ§∫ */
    flex-direction: column;
    justify-content: center; /* üî• ÂûÇÁõ¥Â±Ö‰∏≠ */
    align-items: stretch; /* üî• ËÆ©ÊâÄÊúâÊåâÈíÆÂÆΩÂ∫¶‰∏ÄËá¥ */
    gap: 6px; /* üî• Áªü‰∏ÄÈó¥Ë∑ù */
    flex-shrink: 0;
    opacity: 1 !important; /* üî• Á°Æ‰øùÂèØËßÅ */
    visibility: visible !important; /* üî• Á°Æ‰øùÂèØËßÅ */
    min-height: 120px; /* üî• Á°Æ‰øùÊúâË∂≥Â§üÈ´òÂ∫¶ËøõË°åÂ±Ö‰∏≠ */
    width: 32px; /* üî• Âõ∫ÂÆöÂÆπÂô®ÂÆΩÂ∫¶Á°Æ‰øùÂØπÈΩê */
    padding: 4px 1px; /* üî• ÂæÆË∞ÉÂÜÖËæπË∑ùÔºåÂ¢ûÂä†È°∂ÈÉ®Â∫ïÈÉ®Èó¥Ë∑ù */
    background: rgba(248, 249, 250, 0.3); /* üî• ÂæÆÂ¶ôËÉåÊôØËâ≤Á™ÅÂá∫ÊåâÈíÆÂå∫Âüü */
    border-radius: 8px; /* üî• ÂúÜËßíËÆ©ËßÜËßâÊõ¥ÊüîÂíå */
    border: 1px solid rgba(228, 231, 237, 0.4); /* üî• ÂæÆÂ¶ôËæπÊ°ÜÂÆö‰πâËæπÁïå */
  }
  
  .layer-actions .el-button {
    padding: 0; /* üî• Ê∏ÖÈô§ÂÜÖËæπË∑ù */
    width: 30px; /* üî• Âõ∫ÂÆöÂÆΩÂ∫¶ */
    height: 30px; /* üî• Âõ∫ÂÆöÈ´òÂ∫¶ */
    border-radius: 6px; /* üî• Ë∞ÉÊï¥ÂúÜËßí */
    font-size: 12px; /* üî• ÂáèÂ∞èÂ≠ó‰Ωì */
    border: 1px solid #e4e7ed;
    background: white;
    transition: all 0.2s ease;
    opacity: 1 !important; /* üî• Á°Æ‰øùÊåâÈíÆÂèØËßÅ */
    visibility: visible !important; /* üî• Á°Æ‰øùÊåâÈíÆÂèØËßÅ */
    display: flex !important; /* üî• Á°Æ‰øùflexÂ∏ÉÂ±Ä */
    align-items: center !important; /* üî• ÂõæÊ†áÂûÇÁõ¥Â±Ö‰∏≠ */
    justify-content: center !important; /* üî• ÂõæÊ†áÊ∞¥Âπ≥Â±Ö‰∏≠ */
    min-width: 30px !important; /* üî• Âº∫Âà∂ÊúÄÂ∞èÂÆΩÂ∫¶ */
    max-width: 30px !important; /* üî• Âº∫Âà∂ÊúÄÂ§ßÂÆΩÂ∫¶ */
    min-height: 30px !important; /* üî• Âº∫Âà∂ÊúÄÂ∞èÈ´òÂ∫¶ */
    max-height: 30px !important; /* üî• Âº∫Âà∂ÊúÄÂ§ßÈ´òÂ∫¶ */
    flex: none; /* üî• Èò≤Ê≠¢flexËá™Âä®Ë∞ÉÊï¥ */
    margin: 0; /* üî• Ê∏ÖÈô§Â§ñËæπË∑ù */
    box-sizing: border-box; /* üî• Á°Æ‰øùÁõíÊ®°Âûã‰∏ÄËá¥ */
  }
  
  /* üî• ÊâãÊú∫Á´ØÊåâÈíÆÁâπÂÆöÊ†∑Âºè */
  .layer-actions .action-btn.zoom-btn {
    border-color: #409eff;
    color: #409eff;
  }
  
  .layer-actions .action-btn.style-btn {
    border-color: #67c23a;
    color: #67c23a;
  }
  
  .layer-actions .action-btn.delete-btn {
    border-color: #f56c6c;
    color: #f56c6c;
  }
  
  /* üî• SVGÂõæÊ†áÊ†∑Âºè */
  .layer-actions .el-button svg {
    display: block !important;
    margin: 0 !important;
    flex-shrink: 0;
    width: 16px !important; /* üî• Âõ∫ÂÆöÂõæÊ†áÂÆΩÂ∫¶ */
    height: 16px !important; /* üî• Âõ∫ÂÆöÂõæÊ†áÈ´òÂ∫¶ */
    position: relative;
    left: 0;
    top: 0;
  }
  
  .layer-actions .el-button:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  
  /* üî• ÊâãÊú∫Á´ØÊåâÈíÆÊÇ¨ÂÅúÊïàÊûúÂ¢ûÂº∫ */
  .layer-actions .action-btn.zoom-btn:hover {
    background: #ecf5ff !important;
    border-color: #337ecc !important;
  }
  
  .layer-actions .action-btn.style-btn:hover {
    background: #f0f9ff !important;
    border-color: #5ca632 !important;
  }
  
  .layer-actions .action-btn.delete-btn:hover {
    background: #fef0f0 !important;
    border-color: #dd4a68 !important;
  }
  
  /* üî• ÊâãÊú∫Á´ØÊåâÈíÆÁÇπÂáªÂèçÈ¶à */
  .layer-actions .el-button:active {
    transform: scale(0.95);
    transition: transform 0.1s ease;
  }
  
  /* ÊâãÊú∫Á´ØÁ©∫Áä∂ÊÄÅ */
  .mobile-empty {
    padding: 60px 20px;
    text-align: center;
    color: #909399;
  }
  
  .mobile-empty i {
    font-size: 48px;
    margin-bottom: 16px;
    color: #c0c4cc;
  }
  
  .mobile-empty p {
    margin: 0 0 20px 0;
    font-size: 14px;
    color: #909399;
  }
  
  .mobile-empty .el-button {
    border-radius: 20px;
    padding: 10px 20px;
  }
}

/* üî• Êõ¥Â∞èÂ±èÂπïÔºàÊâãÊú∫Ôºâ‰ºòÂåñ */
@media (max-width: 480px) {
  .mobile-drawer {
    max-height: 80vh;
  }
  
  .fab-content {
    padding: 12px 18px;
  }
  
  .fab-text {
    font-size: 13px;
  }
  
  .mobile-layer-item,
  .mobile-scene-item {
    padding: 15px 18px;
  }
  
  .mobile-layer-item {
    gap: 10px; /* üî• Êõ¥Â∞èÂ±èÂπï‰∏äËøõ‰∏ÄÊ≠•ÂáèÂ∞èÈó¥Ë∑ù */
    min-height: 100px; /* üî• Êõ¥Â∞èÂ±èÂπï‰∏äÂáèÂ∞èÊúÄÂ∞èÈ´òÂ∫¶ */
    padding: 12px 14px; /* üî• Ëøõ‰∏ÄÊ≠•‰ºòÂåñÂÜÖËæπË∑ù */
    align-items: center !important; /* üî• Á°Æ‰øùÂú®Â∞èÂ±èÂπï‰∏ä‰πüÂ±Ö‰∏≠ÂØπÈΩê */
  }
  
  /* üî• Êõ¥Â∞èÂ±èÂπï‰∏äÁöÑÊìç‰ΩúÊåâÈíÆÂÆπÂô® */
  .layer-actions {
    min-height: 90px !important; /* üî• ÂáèÂ∞èÊìç‰ΩúÊåâÈíÆÂÆπÂô®È´òÂ∫¶ */
    gap: 4px !important; /* üî• Áªü‰∏ÄÊåâÈíÆÈó¥Ë∑ù */
    width: 30px !important; /* üî• Ë∞ÉÊï¥ÂÆπÂô®ÂÆΩÂ∫¶ */
    padding: 3px 1px !important; /* üî• Ë∞ÉÊï¥ÂÜÖËæπË∑ù */
  }
  
  .layer-actions .el-button {
    width: 28px !important; /* üî• Êõ¥Â∞èÂ±èÂπï‰∏äËøõ‰∏ÄÊ≠•ÂáèÂ∞è */
    height: 28px !important; /* üî• Êõ¥Â∞èÂ±èÂπï‰∏äËøõ‰∏ÄÊ≠•ÂáèÂ∞è */
    padding: 0 !important; /* üî• Ê∏ÖÈô§ÂÜÖËæπË∑ù */
    min-width: 28px !important;
    max-width: 28px !important;
    min-height: 28px !important;
    max-height: 28px !important;
    flex: none !important; /* üî• Èò≤Ê≠¢flexËá™Âä®Ë∞ÉÊï¥ */
  }
  
  /* üî• Êõ¥Â∞èÂ±èÂπï‰∏äÁöÑÂõæÊ†áÂ∞∫ÂØ∏ */
  .layer-actions .el-button svg {
    width: 14px !important;
    height: 14px !important;
  }
  
  .layer-header .layer-name {
    font-size: 15px;
  }
  
  .mobile-scene-item .scene-info h4 {
    font-size: 15px;
  }
}

/* üî• Ëß¶Êë∏ËÆæÂ§á‰ºòÂåñ */
@media (hover: none) and (pointer: coarse) {
  /* ÁßªÈô§hoverÊïàÊûúÔºå‰ºòÂåñËß¶Êë∏‰ΩìÈ™å */
  .mobile-layer-item:hover,
  .mobile-scene-item:hover {
    background: white;
  }
  
  .mobile-layer-item.active:hover,
  .mobile-scene-item.active:hover {
    background: linear-gradient(135deg, #ecf5ff, #f0f9ff);
  }
  
  .layer-actions .el-button:hover {
    transform: none;
    box-shadow: none;
  }
  
  .mobile-layer-fab:hover {
    transform: none;
    box-shadow: 0 4px 12px rgba(64, 158, 255, 0.4);
  }
  
  /* üî• Ëß¶Êë∏ËÆæÂ§á‰∏äÁöÑÊãñÊãΩÊâãÊüÑ‰ºòÂåñ */
  .drawer-handle:hover {
    background: #e4e7ed; /* üî• ‰øùÊåÅÂü∫Á°ÄÈ¢úËâ≤ */
    opacity: 0.6; /* üî• ‰øùÊåÅÂü∫Á°ÄÈÄèÊòéÂ∫¶ */
    cursor: grab;
  }
  
    .drawer-handle:hover::before {
    cursor: grab; /* üî• ‰º™ÂÖÉÁ¥†ÂÖâÊ†á */
  }
  
  /* üî• Á°Æ‰øùËß¶Êë∏ËÆæÂ§á‰∏äÊìç‰ΩúÊåâÈíÆÂßãÁªàÂèØËßÅÂíåÂØπÈΩê */
  .layer-actions {
    opacity: 1 !important;
    display: flex !important;
    align-items: stretch !important;
    justify-content: center !important;
  }
  
  .layer-actions .el-button {
    opacity: 1 !important;
    visibility: visible !important;
    flex: none !important; /* üî• Èò≤Ê≠¢Ëß¶Êë∏ËÆæÂ§á‰∏äÂ∞∫ÂØ∏ÂèòÂåñ */
  }
}
</style> 