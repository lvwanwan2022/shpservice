<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WMSå›¾å±‚æµ‹è¯•é¡µé¢</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        
        #map {
            width: 100%;
            height: 100vh;
        }
        
        .control-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            max-width: 300px;
        }
        
        .test-button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 8px 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .test-button:hover {
            background: #0056b3;
        }
        
        .test-button.success {
            background: #28a745;
        }
        
        .test-button.error {
            background: #dc3545;
        }
        
        .log-area {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 3px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
            font-family: monospace;
        }
        
        .log-entry {
            margin: 2px 0;
            padding: 2px 5px;
            border-radius: 2px;
        }
        
        .log-entry.success {
            background: #d4edda;
            color: #155724;
        }
        
        .log-entry.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .log-entry.info {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="control-panel">
        <h3>WMSæµ‹è¯•æ§åˆ¶é¢æ¿</h3>
        
        <button class="test-button" onclick="testGeoServerConnection()">
            æµ‹è¯•GeoServerè¿æ¥
        </button>
        
        <button class="test-button" onclick="testWMSCapabilities()">
            æµ‹è¯•WMS Capabilities
        </button>
        
        <button class="test-button" onclick="loadOpenStreetMap()">
            åŠ è½½OpenStreetMap
        </button>
        
        <button class="test-button" onclick="loadTestWMSLayer()">
            åŠ è½½æµ‹è¯•WMSå›¾å±‚
        </button>
        
        <button class="test-button" onclick="loadShpTestLayer()">
            åŠ è½½shpå‹ç¼©åŒ…æµ‹è¯•å›¾å±‚
        </button>
        
        <button class="test-button" onclick="clearAllLayers()">
            æ¸…é™¤æ‰€æœ‰å›¾å±‚
        </button>
        
        <div class="log-area" id="logArea"></div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        let map;
        let currentLayers = [];
        
        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            map = L.map('map', {
                center: [35.0, 105.0],
                zoom: 5,
                maxZoom: 22,
                minZoom: 1
            });
            
            log('åœ°å›¾åˆå§‹åŒ–å®Œæˆ', 'success');
        }
        
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logArea.appendChild(entry);
            logArea.scrollTop = logArea.scrollHeight;
            //console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        // æµ‹è¯•GeoServerè¿æ¥
        async function testGeoServerConnection() {
            log('å¼€å§‹æµ‹è¯•GeoServerè¿æ¥...', 'info');
            
            const endpoints = [
                'http://localhost:8083/geoserver/web/',
                '/geoserver/web/',
                'http://localhost:8080/geoserver/web/'
            ];
            
            for (const endpoint of endpoints) {
                try {
                    log(`æµ‹è¯•ç«¯ç‚¹: ${endpoint}`, 'info');
                    const response = await fetch(endpoint, { method: 'HEAD' });
                    
                    if (response.ok) {
                        log(`âœ… ${endpoint} è¿æ¥æˆåŠŸ (${response.status})`, 'success');
                        return;
                    } else {
                        log(`âŒ ${endpoint} è¿æ¥å¤±è´¥ (${response.status})`, 'error');
                    }
                } catch (error) {
                    log(`âŒ ${endpoint} è¿æ¥å¼‚å¸¸: ${error.message}`, 'error');
                }
            }
        }
        
        // æµ‹è¯•WMS Capabilities
        async function testWMSCapabilities() {
            log('å¼€å§‹æµ‹è¯•WMS Capabilities...', 'info');
            
            const endpoints = [
                '/geoserver/wms?service=WMS&version=1.1.1&request=GetCapabilities',
                'http://localhost:8083/geoserver/wms?service=WMS&version=1.1.1&request=GetCapabilities',
                'http://localhost:8080/geoserver/wms?service=WMS&version=1.1.1&request=GetCapabilities'
            ];
            
            for (const endpoint of endpoints) {
                try {
                    log(`æµ‹è¯•WMSç«¯ç‚¹: ${endpoint}`, 'info');
                    const response = await fetch(endpoint);
                    
                    if (response.ok) {
                        const capabilities = await response.text();
                        log(`âœ… WMS Capabilitiesè·å–æˆåŠŸ (é•¿åº¦: ${capabilities.length})`, 'success');
                        
                        // æ£€æŸ¥æ˜¯å¦åŒ…å«shpserviceå·¥ä½œç©ºé—´
                        if (capabilities.includes('shpservice:')) {
                            log('âœ… å‘ç°shpserviceå·¥ä½œç©ºé—´å›¾å±‚', 'success');
                            
                            // æå–å›¾å±‚åç§°
                            const layerMatches = capabilities.match(/shpservice:[a-f0-9_]+/g);
                            if (layerMatches) {
                                log(`å‘ç°å›¾å±‚: ${layerMatches.join(', ')}`, 'info');
                            }
                        } else {
                            log('âš ï¸ æœªå‘ç°shpserviceå·¥ä½œç©ºé—´å›¾å±‚', 'error');
                        }
                        return;
                    } else {
                        log(`âŒ WMSè¯·æ±‚å¤±è´¥ (${response.status})`, 'error');
                    }
                } catch (error) {
                    log(`âŒ WMSè¯·æ±‚å¼‚å¸¸: ${error.message}`, 'error');
                }
            }
        }
        
        // åŠ è½½OpenStreetMap
        function loadOpenStreetMap() {
            log('åŠ è½½OpenStreetMapåº•å›¾...', 'info');
            
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            });
            
            osmLayer.addTo(map);
            currentLayers.push({ name: 'OpenStreetMap', layer: osmLayer });
            
            osmLayer.on('load', () => {
                log('âœ… OpenStreetMapåŠ è½½æˆåŠŸ', 'success');
            });
            
            osmLayer.on('tileerror', (e) => {
                log('âŒ OpenStreetMapç“¦ç‰‡åŠ è½½å¤±è´¥', 'error');
            });
        }
        
        // åŠ è½½æµ‹è¯•WMSå›¾å±‚
        async function loadTestWMSLayer() {
            log('å¼€å§‹åŠ è½½æµ‹è¯•WMSå›¾å±‚...', 'info');
            
            // æµ‹è¯•ä¸åŒçš„WMSç«¯ç‚¹
            const wmsConfigs = [
                {
                    name: 'ä»£ç†ç«¯ç‚¹æµ‹è¯•',
                    url: '/geoserver/wms',
                    layers: 'topp:states'  // GeoServeré»˜è®¤ç¤ºä¾‹å›¾å±‚
                },
                {
                    name: 'ç›´è¿ç«¯ç‚¹æµ‹è¯•',
                    url: 'http://localhost:8083/geoserver/wms',
                    layers: 'topp:states'
                }
            ];
            
            for (const config of wmsConfigs) {
                try {
                    log(`æµ‹è¯•é…ç½®: ${config.name}`, 'info');
                    log(`URL: ${config.url}, å›¾å±‚: ${config.layers}`, 'info');
                    
                    const wmsLayer = L.tileLayer.wms(config.url, {
                        layers: config.layers,
                        format: 'image/png',
                        transparent: true,
                        version: '1.1.1',
                        attribution: `WMSæµ‹è¯• - ${config.name}`
                    });
                    
                    wmsLayer.on('loading', () => {
                        log(`ğŸ”„ ${config.name} å¼€å§‹åŠ è½½`, 'info');
                    });
                    
                    wmsLayer.on('load', () => {
                        log(`âœ… ${config.name} åŠ è½½æˆåŠŸ`, 'success');
                    });
                    
                    wmsLayer.on('tileerror', (e) => {
                        log(`âŒ ${config.name} ç“¦ç‰‡åŠ è½½å¤±è´¥`, 'error');
                        if (e.tile && e.tile.src) {
                            log(`å¤±è´¥URL: ${e.tile.src}`, 'error');
                        }
                    });
                    
                    wmsLayer.addTo(map);
                    currentLayers.push({ name: config.name, layer: wmsLayer });
                    
                    // ç­‰å¾…ä¸€ä¸‹å†æµ‹è¯•ä¸‹ä¸€ä¸ª
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                } catch (error) {
                    log(`âŒ ${config.name} åŠ è½½å¼‚å¸¸: ${error.message}`, 'error');
                }
            }
        }
        
        // åŠ è½½shpå‹ç¼©åŒ…æµ‹è¯•å›¾å±‚
        async function loadShpTestLayer() {
            log('å¼€å§‹åŠ è½½shpå‹ç¼©åŒ…æµ‹è¯•å›¾å±‚...', 'info');
            
            // ä½¿ç”¨æ‚¨é‡åˆ°é—®é¢˜çš„å…·ä½“å›¾å±‚
            const layerName = 'shpservice:61f8dae0a46744238ec43d96861024cf_store';
            
            const wmsConfigs = [
                {
                    name: 'ä»£ç†è·¯å¾„ - shpæµ‹è¯•å›¾å±‚',
                    url: '/geoserver/wms',
                    layers: layerName
                },
                {
                    name: 'ç›´è¿è·¯å¾„ - shpæµ‹è¯•å›¾å±‚',
                    url: 'http://localhost:8083/geoserver/wms',
                    layers: layerName
                }
            ];
            
            for (const config of wmsConfigs) {
                try {
                    log(`æµ‹è¯•é…ç½®: ${config.name}`, 'info');
                    log(`URL: ${config.url}`, 'info');
                    log(`å›¾å±‚: ${config.layers}`, 'info');
                    
                    // å…ˆæµ‹è¯•è¿™ä¸ªå›¾å±‚çš„GetMapè¯·æ±‚
                    const testUrl = `${config.url}?service=WMS&version=1.1.1&request=GetMap&layers=${encodeURIComponent(config.layers)}&styles=&format=image/png&transparent=true&width=256&height=256&srs=EPSG:3857&bbox=11810915.364,3503549.843,12691488.843,4384123.322`;
                    
                    log(`æµ‹è¯•å•ä¸ªç“¦ç‰‡è¯·æ±‚...`, 'info');
                    
                    try {
                        const testResponse = await fetch(testUrl);
                        log(`ç“¦ç‰‡æµ‹è¯•å“åº”: ${testResponse.status}`, testResponse.ok ? 'success' : 'error');
                        
                        if (!testResponse.ok) {
                            const errorText = await testResponse.text();
                            log(`ç“¦ç‰‡é”™è¯¯å†…å®¹: ${errorText.substring(0, 200)}...`, 'error');
                        } else {
                            log(`âœ… å•ä¸ªç“¦ç‰‡è¯·æ±‚æˆåŠŸ`, 'success');
                        }
                    } catch (testError) {
                        log(`âŒ ç“¦ç‰‡æµ‹è¯•å¤±è´¥: ${testError.message}`, 'error');
                    }
                    
                    // åˆ›å»ºWMSå›¾å±‚
                    const wmsLayer = L.tileLayer.wms(config.url, {
                        layers: config.layers,
                        format: 'image/png',
                        transparent: true,
                        version: '1.1.1',
                        attribution: config.name,
                        // æ·»åŠ ä¸€äº›è°ƒè¯•é€‰é¡¹
                        maxZoom: 18,
                        detectRetina: false
                    });
                    
                    wmsLayer.on('loading', () => {
                        log(`ğŸ”„ ${config.name} å¼€å§‹åŠ è½½`, 'info');
                    });
                    
                    wmsLayer.on('load', () => {
                        log(`âœ… ${config.name} åŠ è½½æˆåŠŸ`, 'success');
                    });
                    
                    wmsLayer.on('tileerror', (e) => {
                        log(`âŒ ${config.name} ç“¦ç‰‡åŠ è½½å¤±è´¥`, 'error');
                        if (e.tile && e.tile.src) {
                            log(`å¤±è´¥çš„ç“¦ç‰‡URL: ${e.tile.src}`, 'error');
                            
                            // åˆ†æURLé—®é¢˜
                            const url = e.tile.src;
                            if (url.includes('GetCapabilities') && url.includes('GetMap')) {
                                log('ğŸ” æ£€æµ‹åˆ°URLåŒ…å«å†²çªçš„requestå‚æ•°', 'error');
                            }
                            if ((url.match(/service=WMS/g) || []).length > 1) {
                                log('ğŸ” æ£€æµ‹åˆ°é‡å¤çš„serviceå‚æ•°', 'error');
                            }
                        }
                    });
                    
                    wmsLayer.addTo(map);
                    currentLayers.push({ name: config.name, layer: wmsLayer });
                    
                    // ç­‰å¾…ä¸€ä¸‹å†æµ‹è¯•ä¸‹ä¸€ä¸ª
                    await new Promise(resolve => setTimeout(resolve, 3000));
                    
                } catch (error) {
                    log(`âŒ ${config.name} åŠ è½½å¼‚å¸¸: ${error.message}`, 'error');
                }
            }
            
            // å°è¯•ç¼©æ”¾åˆ°ä¸­å›½èŒƒå›´
            map.setView([35.0, 105.0], 6);
        }
        
        // æ¸…é™¤æ‰€æœ‰å›¾å±‚
        function clearAllLayers() {
            log('æ¸…é™¤æ‰€æœ‰å›¾å±‚...', 'info');
            
            currentLayers.forEach(layerInfo => {
                map.removeLayer(layerInfo.layer);
                log(`ç§»é™¤å›¾å±‚: ${layerInfo.name}`, 'info');
            });
            
            currentLayers = [];
            log('âœ… æ‰€æœ‰å›¾å±‚å·²æ¸…é™¤', 'success');
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            log('WMSæµ‹è¯•é¡µé¢å‡†å¤‡å°±ç»ª', 'success');
            log('è¯·æŒ‰é¡ºåºç‚¹å‡»æµ‹è¯•æŒ‰é’®è¿›è¡Œè°ƒè¯•', 'info');
        });
    </script>
</body>
</html> 