<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WMSè¯¦ç»†è°ƒè¯•å·¥å…·</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: Arial, sans-serif; margin: 0; }
        .container { display: flex; height: 100vh; }
        .sidebar { width: 400px; padding: 20px; overflow-y: auto; background: #f5f5f5; }
        .map-area { flex: 1; position: relative; }
        #map { width: 100%; height: 100%; }
        .section { margin: 15px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: white; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        .info { color: blue; }
        button { margin: 5px 0; padding: 5px 10px; cursor: pointer; }
        .log-entry { font-size: 12px; margin: 2px 0; padding: 2px 5px; border-radius: 2px; }
        pre { font-size: 11px; background: #eee; padding: 5px; margin: 5px 0; max-height: 100px; overflow-y: auto; }
        input[type="text"] { width: 100%; padding: 5px; margin: 5px 0; }
        .tile-url { word-break: break-all; font-size: 10px; background: #fff3cd; padding: 5px; margin: 2px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h2>WMSè¯¦ç»†è°ƒè¯•</h2>
            
            <div class="section">
                <h3>æµ‹è¯•é…ç½®</h3>
                <label>å›¾å±‚åç§°:</label>
                <input type="text" id="layerInput" value="shpservice:61f8dae0a46744238ec43d96861024cf_store">
                <label>WMS URL:</label>
                <select id="wmsUrlSelect">
                    <option value="/geoserver/wms">ä»£ç†è·¯å¾„</option>
                    <option value="http://localhost:8083/geoserver/wms">ç›´è¿è·¯å¾„</option>
                </select>
                <button onclick="testLayerWithLeaflet()">ä½¿ç”¨Leafletæµ‹è¯•å›¾å±‚</button>
                <button onclick="testDirectWMSRequest()">ç›´æ¥æµ‹è¯•WMSè¯·æ±‚</button>
                <button onclick="clearMap()">æ¸…é™¤åœ°å›¾</button>
            </div>
            
            <div class="section">
                <h3>å¿«é€Ÿæµ‹è¯•</h3>
                <button onclick="testWithOriginalName()">æµ‹è¯•åŸå§‹åç§°(å¸¦store)</button>
                <button onclick="testWithoutStore()">æµ‹è¯•å»æ‰storeåç¼€</button>
                <button onclick="testBothVersions()">åŒæ—¶æµ‹è¯•ä¸¤ä¸ªç‰ˆæœ¬</button>
            </div>
            
            <div class="section">
                <h3>æ—¥å¿—</h3>
                <div id="logArea" style="max-height: 300px; overflow-y: auto; font-size: 12px;"></div>
                <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
            </div>
        </div>
        
        <div class="map-area">
            <div id="map"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        let currentLayers = [];
        
        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            map = L.map('map', {
                center: [35.0, 105.0],
                zoom: 6,
                maxZoom: 22,
                minZoom: 1
            });
            
            // æ·»åŠ åŸºç¡€åº•å›¾
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap',
                opacity: 0.7
            }).addTo(map);
            
            log('åœ°å›¾åˆå§‹åŒ–å®Œæˆ', 'success');
        }
        
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logArea.appendChild(entry);
            logArea.scrollTop = logArea.scrollHeight;
            //console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function clearLog() {
            document.getElementById('logArea').innerHTML = '';
        }
        
        function clearMap() {
            currentLayers.forEach(layer => {
                map.removeLayer(layer);
            });
            currentLayers = [];
            log('åœ°å›¾å·²æ¸…é™¤', 'info');
        }
        
        // ä½¿ç”¨Leafletæµ‹è¯•å›¾å±‚
        async function testLayerWithLeaflet() {
            const layerName = document.getElementById('layerInput').value.trim();
            const wmsUrl = document.getElementById('wmsUrlSelect').value;
            
            if (!layerName) {
                log('è¯·è¾“å…¥å›¾å±‚åç§°', 'warning');
                return;
            }
            
            log(`å¼€å§‹ä½¿ç”¨Leafletæµ‹è¯•å›¾å±‚: ${layerName}`, 'info');
            log(`WMS URL: ${wmsUrl}`, 'info');
            
            try {
                // åˆ›å»ºWMSå›¾å±‚
                const wmsLayer = L.tileLayer.wms(wmsUrl, {
                    layers: layerName,
                    format: 'image/png',
                    transparent: true,
                    version: '1.1.1',
                    attribution: `æµ‹è¯•å›¾å±‚: ${layerName}`,
                    // æ·»åŠ è°ƒè¯•é€‰é¡¹
                    maxZoom: 18,
                    detectRetina: false
                });
                
                // ç›‘å¬äº‹ä»¶
                wmsLayer.on('loading', () => {
                    log(`ğŸ”„ å›¾å±‚å¼€å§‹åŠ è½½: ${layerName}`, 'info');
                });
                
                wmsLayer.on('load', () => {
                    log(`âœ… å›¾å±‚åŠ è½½æˆåŠŸ: ${layerName}`, 'success');
                });
                
                wmsLayer.on('tileerror', (e) => {
                    log(`âŒ ç“¦ç‰‡åŠ è½½å¤±è´¥: ${layerName}`, 'error');
                    if (e.tile && e.tile.src) {
                        log(`å¤±è´¥çš„ç“¦ç‰‡URL:`, 'error');
                        const urlDiv = document.createElement('div');
                        urlDiv.className = 'tile-url';
                        urlDiv.textContent = e.tile.src;
                        document.getElementById('logArea').appendChild(urlDiv);
                        
                        // åˆ†æURL
                        analyzeFailedURL(e.tile.src);
                    }
                });
                
                wmsLayer.addTo(map);
                currentLayers.push(wmsLayer);
                
                log(`å›¾å±‚å·²æ·»åŠ åˆ°åœ°å›¾`, 'info');
                
            } catch (error) {
                log(`åˆ›å»ºå›¾å±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // åˆ†æå¤±è´¥çš„URL
        function analyzeFailedURL(url) {
            try {
                const urlObj = new URL(url);
                const params = Object.fromEntries(urlObj.searchParams);
                
                log('URLå‚æ•°åˆ†æ:', 'info');
                log(`- service: ${params.service || 'æ— '}`, 'info');
                log(`- version: ${params.version || 'æ— '}`, 'info');
                log(`- request: ${params.request || 'æ— '}`, 'info');
                log(`- layers: ${params.layers || 'æ— '}`, 'info');
                log(`- format: ${params.format || 'æ— '}`, 'info');
                log(`- bbox: ${params.bbox || 'æ— '}`, 'info');
                
                // æ£€æŸ¥å¸¸è§é—®é¢˜
                if (!params.layers) {
                    log('âš ï¸ ç¼ºå°‘layerså‚æ•°', 'warning');
                }
                if (!params.bbox) {
                    log('âš ï¸ ç¼ºå°‘bboxå‚æ•°', 'warning');
                }
                if (params.layers && !params.layers.includes(':')) {
                    log('âš ï¸ å›¾å±‚åç§°å¯èƒ½ç¼ºå°‘å·¥ä½œç©ºé—´å‰ç¼€', 'warning');
                }
                
            } catch (e) {
                log(`URLåˆ†æå¤±è´¥: ${e.message}`, 'error');
            }
        }
        
        // ç›´æ¥æµ‹è¯•WMSè¯·æ±‚
        async function testDirectWMSRequest() {
            const layerName = document.getElementById('layerInput').value.trim();
            const wmsUrl = document.getElementById('wmsUrlSelect').value;
            
            if (!layerName) {
                log('è¯·è¾“å…¥å›¾å±‚åç§°', 'warning');
                return;
            }
            
            // æ„å»ºæµ‹è¯•URL
            const testUrl = `${wmsUrl}?service=WMS&version=1.1.1&request=GetMap&layers=${encodeURIComponent(layerName)}&styles=&format=image/png&transparent=true&width=256&height=256&srs=EPSG:3857&bbox=11810915.364,3503549.843,12691488.843,4384123.322`;
            
            log(`ç›´æ¥æµ‹è¯•WMSè¯·æ±‚...`, 'info');
            log(`æµ‹è¯•URL: ${testUrl}`, 'info');
            
            try {
                const response = await fetch(testUrl);
                
                if (response.ok) {
                    log(`âœ… WMSè¯·æ±‚æˆåŠŸ: ${response.status}`, 'success');
                    log(`Content-Type: ${response.headers.get('content-type')}`, 'info');
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯å›¾ç‰‡
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('image')) {
                        log(`âœ… è¿”å›äº†å›¾ç‰‡å†…å®¹`, 'success');
                        
                        // å°è¯•æ˜¾ç¤ºå›¾ç‰‡ä¿¡æ¯
                        const blob = await response.blob();
                        log(`å›¾ç‰‡å¤§å°: ${blob.size} bytes`, 'info');
                    } else {
                        log(`âš ï¸ è¿”å›çš„ä¸æ˜¯å›¾ç‰‡å†…å®¹`, 'warning');
                        const text = await response.text();
                        log(`å“åº”å†…å®¹é¢„è§ˆ:`, 'warning');
                        const preDiv = document.createElement('pre');
                        preDiv.textContent = text.substring(0, 500) + (text.length > 500 ? '...' : '');
                        document.getElementById('logArea').appendChild(preDiv);
                    }
                } else {
                    log(`âŒ WMSè¯·æ±‚å¤±è´¥: ${response.status}`, 'error');
                    const errorText = await response.text();
                    log(`é”™è¯¯å†…å®¹:`, 'error');
                    const preDiv = document.createElement('pre');
                    preDiv.textContent = errorText.substring(0, 500) + (errorText.length > 500 ? '...' : '');
                    document.getElementById('logArea').appendChild(preDiv);
                }
                
            } catch (error) {
                log(`è¯·æ±‚å¼‚å¸¸: ${error.message}`, 'error');
            }
        }
        
        // æµ‹è¯•åŸå§‹åç§°
        function testWithOriginalName() {
            document.getElementById('layerInput').value = 'shpservice:61f8dae0a46744238ec43d96861024cf_store';
            testLayerWithLeaflet();
        }
        
        // æµ‹è¯•å»æ‰storeåç¼€
        function testWithoutStore() {
            document.getElementById('layerInput').value = 'shpservice:61f8dae0a46744238ec43d96861024cf_';
            testLayerWithLeaflet();
        }
        
        // åŒæ—¶æµ‹è¯•ä¸¤ä¸ªç‰ˆæœ¬
        async function testBothVersions() {
            log('=== å¼€å§‹åŒæ—¶æµ‹è¯•ä¸¤ä¸ªç‰ˆæœ¬çš„å›¾å±‚åç§° ===', 'info');
            
            // æ¸…é™¤ç°æœ‰å›¾å±‚
            clearMap();
            
            // æµ‹è¯•å¸¦storeåç¼€çš„ç‰ˆæœ¬
            log('--- æµ‹è¯•1: å¸¦storeåç¼€ ---', 'info');
            document.getElementById('layerInput').value = 'shpservice:61f8dae0a46744238ec43d96861024cf_store';
            await testDirectWMSRequest();
            
            // ç­‰å¾…ä¸€ä¸‹
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // æµ‹è¯•ä¸å¸¦storeåç¼€çš„ç‰ˆæœ¬  
            log('--- æµ‹è¯•2: ä¸å¸¦storeåç¼€ ---', 'info');
            document.getElementById('layerInput').value = 'shpservice:61f8dae0a46744238ec43d96861024cf_';
            await testDirectWMSRequest();
            
            log('=== æµ‹è¯•å®Œæˆ ===', 'info');
        }
        
        // é¡µé¢åˆå§‹åŒ–
        window.addEventListener('load', function() {
            initMap();
        });
    </script>
</body>
</html> 