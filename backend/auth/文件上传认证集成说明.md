# æ–‡ä»¶ä¸Šä¼ è®¤è¯é›†æˆè¯´æ˜

## âœ… å®Œæˆçš„ä¿®æ”¹

### 1. **ä¸€è¡Œä»£ç å®ç°æ–‡ä»¶ä¸Šä¼ æ¥å£ç™»å½•éªŒè¯**

æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ ç›¸å…³æ¥å£éƒ½å·²æ·»åŠ è®¤è¯è£…é¥°å™¨ï¼š

```python
# åœ¨ backend/routes/file_routes.py ä¸­
from auth.auth_service import require_auth, get_current_user

@file_bp.route('/upload', methods=['POST'])
@require_auth  # ä¸€è¡Œä»£ç å®ç°ç™»å½•éªŒè¯
def upload_file():
    # ...

@file_bp.route('/upload/chunked/init', methods=['POST'])
@require_auth  # ä¸€è¡Œä»£ç å®ç°ç™»å½•éªŒè¯
def init_chunked_upload():
    # ...

@file_bp.route('/upload/chunked/chunk', methods=['POST'])
@require_auth  # ä¸€è¡Œä»£ç å®ç°ç™»å½•éªŒè¯
def upload_chunk():
    # ...

@file_bp.route('/upload/chunked/complete', methods=['POST'])
@require_auth  # ä¸€è¡Œä»£ç å®ç°ç™»å½•éªŒè¯
def complete_chunked_upload():
    # ...
```

### 2. **ä½¿ç”¨å½“å‰ç™»å½•ç”¨æˆ·IDæ›¿ä»£ç¡¬ç¼–ç ID**

ä¿®æ”¹å‰ï¼ˆä¼šå¯¼è‡´å¤–é”®çº¦æŸé”™è¯¯ï¼‰ï¼š
```python
'user_id': request.form.get('user_id', 1),  # ç¡¬ç¼–ç ID=1
```

ä¿®æ”¹åï¼ˆä½¿ç”¨å½“å‰ç™»å½•ç”¨æˆ·çš„çœŸå®IDï¼‰ï¼š
```python
# è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
current_user = get_current_user()
user_id = current_user.get('id', current_user.get('username', 'unknown'))
metadata['user_id'] = user_id  # ä½¿ç”¨å½“å‰ç™»å½•ç”¨æˆ·ID
```

### 3. **æ•°æ®åº“ç”¨æˆ·è®¤è¯é›†æˆ**

è®¤è¯æœåŠ¡ç°åœ¨ä¼˜å…ˆä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·ï¼š

```python
def authenticate(self, username, password):
    # ä¼˜å…ˆä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·
    from models.db import execute_query
    sql = "SELECT id, username, password, email FROM users WHERE username = %s"
    result = execute_query(sql, (username,))
    
    if result:
        user = result[0]
        if user['password'] == self._hash_password(password):
            user_info = {
                'id': user['id'],           # æ•°æ®åº“é›ªèŠ±ç®—æ³•ID
                'username': user['username'],
                'email': user['email'],
                'name': user['username'],
                'role': 'admin' if username == 'admin' else 'user'
            }
            return True, user_info, "ç™»å½•æˆåŠŸ"
```

### 4. **é›ªèŠ±ç®—æ³•IDè‡ªåŠ¨åˆ›å»º**

- æ•°æ®åº“åˆå§‹åŒ–æ—¶è‡ªåŠ¨åˆ›å»ºadminç”¨æˆ·ï¼ˆä½¿ç”¨é›ªèŠ±ç®—æ³•IDï¼‰
- æ–‡ä»¶ä¿å­˜æ—¶ä½¿ç”¨`insert_with_snowflake_id`å‡½æ•°
- å®Œå…¨è§£å†³å¤–é”®çº¦æŸé—®é¢˜

## ğŸ”§ è§£å†³çš„é—®é¢˜

### âŒ ä¿®æ”¹å‰çš„é”™è¯¯ï¼š
```
é”™è¯¯: æ’å…¥æˆ–æ›´æ–°è¡¨ "files" è¿åå¤–é”®çº¦æŸ "files_user_id_fkey"
DETAIL: é”®å€¼å¯¹(user_id)=(1)æ²¡æœ‰åœ¨è¡¨"users"ä¸­å‡ºç°.
```

### âœ… ä¿®æ”¹åçš„æ•ˆæœï¼š
- æ–‡ä»¶ä¸Šä¼ éœ€è¦ç™»å½•
- è‡ªåŠ¨ä½¿ç”¨å½“å‰ç”¨æˆ·çš„çœŸå®ID
- æ”¯æŒé›ªèŠ±ç®—æ³•ID
- æ”¯æŒæ•°æ®åº“ç”¨æˆ·éªŒè¯

## ğŸš€ ä½¿ç”¨æ–¹å¼

### 1. **å‰ç«¯è°ƒç”¨**
å‰ç«¯éœ€è¦å…ˆç™»å½•ï¼Œç„¶åä½¿ç”¨å¸¦è®¤è¯çš„axioså®ä¾‹ï¼š

```javascript
import { authHttp } from '@/auth/authService'

// ä¸Šä¼ æ–‡ä»¶ï¼ˆè‡ªåŠ¨æºå¸¦è®¤è¯tokenï¼‰
const formData = new FormData()
formData.append('file', file)
formData.append('file_name', fileName)
// ... å…¶ä»–å­—æ®µ

const response = await authHttp.post('/api/files/upload', formData, {
  headers: { 'Content-Type': 'multipart/form-data' }
})
```

### 2. **åç«¯æ¥å£**
å…¶ä»–éœ€è¦è®¤è¯çš„æ¥å£ä¹Ÿå¯ä»¥ä¸€è¡Œä»£ç æ·»åŠ ç™»å½•éªŒè¯ï¼š

```python
@file_bp.route('/my-files', methods=['GET'])
@require_auth  # ä¸€è¡Œä»£ç å®ç°ç™»å½•éªŒè¯
def get_my_files():
    current_user = get_current_user()
    user_id = current_user.get('id')
    # åªè¿”å›å½“å‰ç”¨æˆ·çš„æ–‡ä»¶
    return get_files_by_user(user_id)
```

## ğŸ’¡ æ‰©å±•å»ºè®®

### 1. **è§’è‰²æƒé™æ§åˆ¶**
```python
from auth.auth_service import require_auth, get_current_user

@file_bp.route('/admin-only-upload', methods=['POST'])
@require_auth
def admin_upload():
    user = get_current_user()
    if user.get('role') != 'admin':
        return jsonify({'error': 'æƒé™ä¸è¶³'}), 403
    # ç®¡ç†å‘˜ä¸“ç”¨ä¸Šä¼ é€»è¾‘
```

### 2. **æ–‡ä»¶è®¿é—®æ§åˆ¶**
```python
@file_bp.route('/<string:file_id>/download', methods=['GET'])
@require_auth
def download_file(file_id):
    user = get_current_user()
    file_info = get_file_info(file_id)
    
    # æ£€æŸ¥æƒé™ï¼šæ–‡ä»¶æ‰€æœ‰è€…æˆ–å…¬å¼€æ–‡ä»¶
    if file_info['user_id'] != user['id'] and not file_info['is_public']:
        return jsonify({'error': 'æ— æƒè®¿é—®æ­¤æ–‡ä»¶'}), 403
    
    return send_file(file_info['file_path'])
```

## ğŸ”’ å®‰å…¨ç‰¹æ€§

1. **JWT Tokenè®¤è¯** - æ— çŠ¶æ€ã€å®‰å…¨
2. **å¯†ç å“ˆå¸Œå­˜å‚¨** - SHA256åŠ å¯†
3. **ç”¨æˆ·æƒé™éš”ç¦»** - æ¯ä¸ªç”¨æˆ·åªèƒ½æ“ä½œè‡ªå·±çš„æ–‡ä»¶
4. **æ•°æ®åº“å¤–é”®çº¦æŸ** - ç¡®ä¿æ•°æ®å®Œæ•´æ€§
5. **é›ªèŠ±ç®—æ³•ID** - åˆ†å¸ƒå¼å”¯ä¸€IDï¼Œé˜²å†²çª

## ğŸ“ æµ‹è¯•è´¦å·

- **ç®¡ç†å‘˜**: `admin` / `admin123`
- **æ™®é€šç”¨æˆ·**: `user` / `user123`

æ•°æ®åº“åˆå§‹åŒ–æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºadminç”¨æˆ·ã€‚ 