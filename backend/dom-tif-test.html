<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOM.tifæ–‡ä»¶å‘å¸ƒæµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1890ff;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        .section h2 {
            margin-top: 0;
            color: #333;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #1890ff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #40a9ff;
        }
        button.secondary {
            background-color: #52c41a;
        }
        button.secondary:hover {
            background-color: #73d13d;
        }
        button.warning {
            background-color: #ff4d4f;
        }
        button.warning:hover {
            background-color: #ff7875;
        }
        .file-list {
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        .file-item {
            padding: 8px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .file-item:hover {
            background-color: #f0f0f0;
        }
        .file-item.selected {
            background-color: #e6f7ff;
        }
        #result {
            background-color: #fafafa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .coordinate-types {
            display: flex;
            margin-bottom: 15px;
        }
        .coordinate-type {
            background-color: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 4px;
            padding: 8px 12px;
            margin-right: 10px;
            cursor: pointer;
        }
        .coordinate-type:hover {
            background-color: #bae7ff;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .action-button {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            color: white;
        }
        .action-button.primary {
            background-color: #1890ff;
        }
        .action-button.success {
            background-color: #52c41a;
        }
        .action-button.warning {
            background-color: #fa8c16;
        }
        .action-button.danger {
            background-color: #f5222d;
        }
        .tab-container {
            margin-bottom: 20px;
        }
        .tab-header {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 4px 4px 0 0;
        }
        .tab.active {
            background-color: #fff;
            border-color: #ddd;
            border-bottom: 1px solid #fff;
            margin-bottom: -1px;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>DOM.tifæ–‡ä»¶å‘å¸ƒæµ‹è¯•</h1>
        
        <div class="tab-container">
            <div class="tab-header">
                <div class="tab active" data-tab="file-list">æ–‡ä»¶åˆ—è¡¨</div>
                <div class="tab" data-tab="publish-test">å‘å¸ƒæµ‹è¯•</div>
                <div class="tab" data-tab="gdal-test">GDALå¤„ç†æµ‹è¯•</div>
            </div>
            
            <div id="file-list" class="tab-content active">
                <div class="section">
                    <h2>æ–‡ä»¶åˆ—è¡¨</h2>
                    <p>æŸ¥è¯¢ç³»ç»Ÿä¸­çš„TIF/DOMæ–‡ä»¶ï¼Œç‚¹å‡»é€‰æ‹©è¦å‘å¸ƒçš„æ–‡ä»¶</p>
                    
                    <button id="load-files">åŠ è½½TIFæ–‡ä»¶åˆ—è¡¨</button>
                    
                    <div class="file-list" id="files-container">
                        <div class="file-item">è¯·ç‚¹å‡»"åŠ è½½TIFæ–‡ä»¶åˆ—è¡¨"æŒ‰é’®</div>
                    </div>
                    
                    <div id="selected-file-info" style="display: none;">
                        <h3>å·²é€‰æ‹©æ–‡ä»¶</h3>
                        <p><strong>ID:</strong> <span id="selected-file-id"></span></p>
                        <p><strong>åç§°:</strong> <span id="selected-file-name"></span></p>
                        <p><strong>ç±»å‹:</strong> <span id="selected-file-type"></span></p>
                        <p><strong>è·¯å¾„:</strong> <span id="selected-file-path"></span></p>
                    </div>
                </div>
            </div>
            
            <div id="publish-test" class="tab-content">
                <div class="section">
                    <h2>DOM.tifå‘å¸ƒæµ‹è¯•</h2>
                    <p>ä½¿ç”¨ä¸“é—¨çš„DOM.tifå‘å¸ƒæ¥å£ï¼Œè‡ªåŠ¨å¤„ç†åæ ‡ç³»å’Œé€æ˜åº¦</p>
                    
                    <div>
                        <label for="file-id">æ–‡ä»¶ID:</label>
                        <input type="number" id="file-id" placeholder="è¯·è¾“å…¥æ–‡ä»¶IDæˆ–ä»åˆ—è¡¨ä¸­é€‰æ‹©">
                    </div>
                    
                    <div>
                        <label for="force-epsg">å¼ºåˆ¶åæ ‡ç³» (å¯é€‰):</label>
                        <input type="text" id="force-epsg" placeholder="ä¾‹å¦‚: EPSG:2343">
                    </div>
                    
                    <div>
                        <label>
                            <input type="checkbox" id="force-republish"> å¼ºåˆ¶é‡æ–°å‘å¸ƒ (å¦‚æœå·²å­˜åœ¨)
                        </label>
                    </div>
                    
                    <div class="action-buttons">
                        <div class="action-button primary" id="publish-dom">
                            ğŸŒ å‘å¸ƒDOM.tif
                        </div>
                        <div class="action-button success" id="publish-dom-2343">
                            ğŸ¯ ç›´æ¥ä¸Šä¼ +è®¾ç½®EPSG:2343
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="gdal-test" class="tab-content">
                <div class="section">
                    <h2>GDALå¤„ç†æµ‹è¯•</h2>
                    <p>æµ‹è¯•GDALåæ ‡ç³»æ£€æŸ¥å’Œå¤„ç†åŠŸèƒ½</p>
                    
                    <div>
                        <label for="test-file-path">æ–‡ä»¶è·¯å¾„:</label>
                        <input type="text" id="test-file-path" placeholder="ä¾‹å¦‚: G:/code/shpservice/FilesData/58cc01040e69460eb9fc8d96311d2e30.tif">
                    </div>
                    
                    <div>
                        <label for="target-epsg">ç›®æ ‡EPSGåæ ‡ç³»:</label>
                        <input type="text" id="target-epsg" value="EPSG:2343" placeholder="ä¾‹å¦‚: EPSG:2343">
                    </div>
                    
                    <div class="action-buttons">
                        <div class="action-button primary" id="check-coordinate">
                            ğŸ” æ£€æŸ¥åæ ‡ç³»
                        </div>
                        <div class="action-button warning" id="process-gdal">
                            ğŸ”§ GDALå¤„ç†
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>ç»“æœè¾“å‡º</h2>
            <div id="result">// ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const baseUrl = '';  // æ ¹æ®å®é™…æƒ…å†µè®¾ç½®APIåŸºç¡€URL
            let selectedFile = null;
            
            // æ ‡ç­¾é¡µåˆ‡æ¢
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // ç§»é™¤æ‰€æœ‰æ ‡ç­¾é¡µçš„activeç±»
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // æ·»åŠ å½“å‰æ ‡ç­¾é¡µçš„activeç±»
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // åŠ è½½æ–‡ä»¶åˆ—è¡¨
            document.getElementById('load-files').addEventListener('click', async function() {
                try {
                    showResult('æ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨...');
                    const response = await fetch(`${baseUrl}/file/list?filter=tif,dom`);
                    const data = await response.json();
                    
                    if (data.files && data.files.length > 0) {
                        const filesContainer = document.getElementById('files-container');
                        filesContainer.innerHTML = '';
                        
                        data.files.forEach(file => {
                            const fileItem = document.createElement('div');
                            fileItem.className = 'file-item';
                            fileItem.setAttribute('data-id', file.id);
                            fileItem.innerHTML = `
                                <strong>${file.file_name}</strong> (ID: ${file.id})<br>
                                <small>${file.file_type} - ${formatSize(file.file_size)}</small>
                            `;
                            
                            fileItem.addEventListener('click', function() {
                                // ç§»é™¤æ‰€æœ‰é€‰ä¸­é¡¹çš„æ ·å¼
                                document.querySelectorAll('.file-item').forEach(item => {
                                    item.classList.remove('selected');
                                });
                                
                                // æ·»åŠ å½“å‰é€‰ä¸­é¡¹çš„æ ·å¼
                                this.classList.add('selected');
                                
                                // è®¾ç½®é€‰ä¸­çš„æ–‡ä»¶
                                selectedFile = file;
                                document.getElementById('file-id').value = file.id;
                                
                                // æ˜¾ç¤ºé€‰ä¸­æ–‡ä»¶çš„ä¿¡æ¯
                                document.getElementById('selected-file-info').style.display = 'block';
                                document.getElementById('selected-file-id').textContent = file.id;
                                document.getElementById('selected-file-name').textContent = file.file_name;
                                document.getElementById('selected-file-type').textContent = file.file_type;
                                document.getElementById('selected-file-path').textContent = file.file_path || 'æœªçŸ¥';
                                
                                // é¢„å¡«å……æµ‹è¯•è·¯å¾„
                                document.getElementById('test-file-path').value = file.file_path || '';
                            });
                            
                            filesContainer.appendChild(fileItem);
                        });
                        
                        showResult(`æˆåŠŸåŠ è½½ ${data.files.length} ä¸ªæ–‡ä»¶`);
                    } else {
                        showResult('æœªæ‰¾åˆ°æ–‡ä»¶ï¼Œæˆ–è¿”å›æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                    }
                } catch (error) {
                    showResult(`åŠ è½½æ–‡ä»¶åˆ—è¡¨å‡ºé”™: ${error.message}`);
                }
            });
            
            // å‘å¸ƒDOM.tif
            document.getElementById('publish-dom').addEventListener('click', async function() {
                const fileId = document.getElementById('file-id').value;
                if (!fileId) {
                    return showResult('è¯·è¾“å…¥æˆ–é€‰æ‹©æ–‡ä»¶ID');
                }
                
                const forceEpsg = document.getElementById('force-epsg').value;
                const forceRepublish = document.getElementById('force-republish').checked;
                
                try {
                    showResult('æ­£åœ¨å‘å¸ƒDOM.tifæ–‡ä»¶...');
                    
                    const params = {};
                    if (forceEpsg) params.force_epsg = forceEpsg;
                    if (forceRepublish) params.force = true;
                    
                    const response = await fetch(`${baseUrl}/file/${fileId}/publish/dom`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(params)
                    });
                    
                    const data = await response.json();
                    showResult(JSON.stringify(data, null, 2));
                } catch (error) {
                    showResult(`å‘å¸ƒDOM.tifå‡ºé”™: ${error.message}`);
                }
            });
            
            // ç›´æ¥ä¸Šä¼ +è®¾ç½®EPSG:2343
            document.getElementById('publish-dom-2343').addEventListener('click', async function() {
                const fileId = document.getElementById('file-id').value;
                if (!fileId) {
                    return showResult('è¯·è¾“å…¥æˆ–é€‰æ‹©æ–‡ä»¶ID');
                }
                
                try {
                    showResult('æ­£åœ¨å‘å¸ƒDOM.tifæ–‡ä»¶å¹¶å¼ºåˆ¶è®¾ç½®EPSG:2343...');
                    
                    const response = await fetch(`${baseUrl}/file/${fileId}/publish/dom`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            force_epsg: 'EPSG:2343',
                            force: true
                        })
                    });
                    
                    const data = await response.json();
                    showResult(JSON.stringify(data, null, 2));
                } catch (error) {
                    showResult(`å‘å¸ƒDOM.tifå‡ºé”™: ${error.message}`);
                }
            });
            
            // æ£€æŸ¥åæ ‡ç³»
            document.getElementById('check-coordinate').addEventListener('click', async function() {
                const filePath = document.getElementById('test-file-path').value;
                if (!filePath) {
                    return showResult('è¯·è¾“å…¥æ–‡ä»¶è·¯å¾„');
                }
                
                try {
                    showResult('æ­£åœ¨æ£€æŸ¥æ–‡ä»¶åæ ‡ç³»...');
                    
                    const response = await fetch(`${baseUrl}/file/check-coordinate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            file_path: filePath
                        })
                    });
                    
                    const data = await response.json();
                    showResult(JSON.stringify(data, null, 2));
                } catch (error) {
                    showResult(`æ£€æŸ¥åæ ‡ç³»å‡ºé”™: ${error.message}\n\næ³¨æ„ï¼šè¿™ä¸ªAPIå¯èƒ½éœ€è¦æ‚¨è‡ªå·±å®ç°ï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨DOM.tifå‘å¸ƒAPI`);
                }
            });
            
            // GDALå¤„ç†
            document.getElementById('process-gdal').addEventListener('click', async function() {
                const filePath = document.getElementById('test-file-path').value;
                const targetEpsg = document.getElementById('target-epsg').value;
                
                if (!filePath) {
                    return showResult('è¯·è¾“å…¥æ–‡ä»¶è·¯å¾„');
                }
                
                if (!targetEpsg) {
                    return showResult('è¯·è¾“å…¥ç›®æ ‡EPSGåæ ‡ç³»');
                }
                
                try {
                    showResult('æ­£åœ¨ä½¿ç”¨GDALå¤„ç†æ–‡ä»¶...');
                    
                    const response = await fetch(`${baseUrl}/file/process-gdal`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            file_path: filePath,
                            target_epsg: targetEpsg
                        })
                    });
                    
                    const data = await response.json();
                    showResult(JSON.stringify(data, null, 2));
                } catch (error) {
                    showResult(`GDALå¤„ç†å‡ºé”™: ${error.message}\n\næ³¨æ„ï¼šè¿™ä¸ªAPIå¯èƒ½éœ€è¦æ‚¨è‡ªå·±å®ç°ï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨DOM.tifå‘å¸ƒAPI`);
                }
            });
            
            // è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºç»“æœ
            function showResult(content) {
                document.getElementById('result').textContent = content;
            }
            
            // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ–‡ä»¶å¤§å°
            function formatSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
        });
    </script>
</body>
</html> 