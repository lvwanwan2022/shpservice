<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WMS å›¾å±‚æ¼”ç¤º - Leaflet</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #409EFF;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }
        
        .controls {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .control-group label {
            font-weight: bold;
            min-width: 80px;
        }
        
        button {
            background: #409EFF;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background: #337ab7;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        input[type="range"] {
            flex: 1;
            max-width: 200px;
        }
        
        #map {
            height: 600px;
            width: 100%;
        }
        
        .info-panel {
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }
        
        .info-panel h3 {
            margin-top: 0;
            color: #333;
        }
        
        .info-item {
            margin-bottom: 8px;
            padding: 5px 0;
        }
        
        .info-label {
            font-weight: bold;
            color: #666;
            display: inline-block;
            width: 120px;
        }
        
        .wms-url {
            word-break: break-all;
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin-top: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ—ºï¸ WMS å›¾å±‚æ¼”ç¤º</h1>
            <p>ä½¿ç”¨ Leaflet åŠ è½½ GeoServer WMS æœåŠ¡</p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label>é€æ˜åº¦:</label>
                <input type="range" id="opacitySlider" min="0" max="100" value="100">
                <span id="opacityValue">100%</span>
            </div>
            <div class="control-group">
                <button id="toggleLayer">éšè—å›¾å±‚</button>
                <button id="fitBounds">ç¼©æ”¾åˆ°å›¾å±‚</button>
                <button id="refreshLayer">åˆ·æ–°å›¾å±‚</button>
                <button id="getFeatureInfo">å¯ç”¨è¦ç´ æŸ¥è¯¢</button>
                <button id="debugMode">è°ƒè¯•æ¨¡å¼</button>
            </div>
        </div>
        
        <div id="statusMessage"></div>
        
        <div id="map"></div>
        
        <div class="info-panel">
            <h3>ğŸ“‹ æœåŠ¡ä¿¡æ¯</h3>
            <div class="info-item">
                <span class="info-label">æœåŠ¡ç±»å‹:</span>
                <span>WMS (Web Map Service)</span>
            </div>
            <div class="info-item">
                <span class="info-label">æœåŠ¡ç‰ˆæœ¬:</span>
                <span id="serviceVersion">1.1.1</span>
            </div>
            <div class="info-item">
                <span class="info-label">å›¾å±‚åç§°:</span>
                <span id="layerName">shpservice:4f72bfc3469b49d6975f54ce5a5de310_store</span>
            </div>
            <div class="info-item">
                <span class="info-label">æœåŠ¡åœ°å€:</span>
                <span id="serviceUrl">http://localhost:8083/geoserver/shpservice/wms</span>
            </div>
            <div class="info-item">
                <span class="info-label">åæ ‡ç³»ç»Ÿ:</span>
                <span id="crsInfo">EPSG:3857 (Web Mercator)</span>
            </div>
            <div class="info-item">
                <span class="info-label">å½“å‰ç¼©æ”¾:</span>
                <span id="zoomLevel">-</span>
            </div>
            <div class="info-item">
                <span class="info-label">åœ°å›¾ä¸­å¿ƒ:</span>
                <span id="mapCenter">-</span>
            </div>
            
            <div class="wms-url">
                <strong>GetCapabilities URL:</strong><br>
                <span id="capabilitiesUrl">http://localhost:8083/geoserver/shpservice/wms?service=WMS&version=1.1.1&request=GetCapabilities</span>
            </div>

            <div id="debugInfo" class="debug-info" style="display: none;">
                <strong>è°ƒè¯•ä¿¡æ¯:</strong><br>
                <div id="debugLog"></div>
            </div>
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <script>
        // è°ƒè¯•æ¨¡å¼æ ‡å¿—
        let debugMode = false;
        let debugLog = [];

        // æ·»åŠ è°ƒè¯•æ—¥å¿—å‡½æ•°
        function addDebugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            debugLog.push(logMessage);
            console.log(logMessage);
            
            if (debugMode) {
                const debugElement = document.getElementById('debugLog');
                if (debugElement) {
                    debugElement.innerHTML = debugLog.slice(-10).join('<br>'); // åªæ˜¾ç¤ºæœ€æ–°10æ¡
                }
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type = 'info') {
            const statusElement = document.getElementById('statusMessage');
            statusElement.innerHTML = `<div class="${type}">${message}</div>`;
            
            // 3ç§’åæ¸…é™¤æ¶ˆæ¯
            setTimeout(() => {
                statusElement.innerHTML = '';
            }, 3000);
        }

        addDebugLog('ğŸš€ å¼€å§‹åˆå§‹åŒ– Leaflet åœ°å›¾');
        
        // åˆå§‹åŒ–åœ°å›¾ - ä½¿ç”¨åŒ—äº¬åæ ‡ä½œä¸ºé»˜è®¤ä¸­å¿ƒç‚¹
        const map = L.map('map', {
            crs: L.CRS.EPSG3857, // æ˜ç¡®æŒ‡å®šåæ ‡ç³»
            zoomControl: true
        }).setView([39.9042, 116.4074], 6); // é™ä½åˆå§‹ç¼©æ”¾çº§åˆ«
        
        addDebugLog('âœ… åœ°å›¾å®¹å™¨åˆå§‹åŒ–å®Œæˆ');

        // æ·»åŠ é«˜å¾·åœ°å›¾åº•å›¾
        const baseLayer = L.tileLayer('https://webrd{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
            attribution: 'Â© é«˜å¾·åœ°å›¾',
            subdomains: ['01', '02', '03', '04'],
            maxZoom: 18
        }).addTo(map);
        
        addDebugLog('âœ… åº•å›¾åŠ è½½å®Œæˆ');

        // WMS å›¾å±‚é…ç½®
        const wmsUrl = 'http://localhost:8083/geoserver/shpservice/wms';
        const layerName = 'shpservice:1ffacf547ad3412294922d8758a89c2c_store';
        
        addDebugLog(`ğŸŒ WMS URL: ${wmsUrl}`);
        addDebugLog(`ğŸ“Œ å›¾å±‚åç§°: ${layerName}`);
        
        // åˆ›å»º WMS å›¾å±‚ - ä½¿ç”¨æ›´å…¼å®¹çš„é…ç½®
        let wmsLayer = L.tileLayer.wms(wmsUrl, {
            layers: layerName,
            format: 'image/png',
            transparent: true,
            version: '1.1.1', // ä½¿ç”¨æ›´å¸¸è§çš„ç‰ˆæœ¬
             crs: L.CRS.EPSG2379,
             srs: 'EPSG:2379', // ä¸ºäº†å…¼å®¹æ€§åŒæ—¶è®¾ç½®srs
            opacity: 1.0,
            attribution: 'GeoServer WMS',
            // æ·»åŠ é”™è¯¯å¤„ç†å‚æ•°
            tileSize: 256,
            // // ç¦ç”¨ç“¦ç‰‡ç¼“å­˜ä»¥ä¾¿è°ƒè¯•
            // noCache: false
        });
        
        addDebugLog('ğŸ”§ WMS å›¾å±‚é…ç½®å®Œæˆ');
        
        // æ·»åŠ å›¾å±‚åˆ°åœ°å›¾å‰å…ˆæµ‹è¯•è¿æ¥
        function testWMSConnection() {
            const testUrl = `${wmsUrl}?service=WMS&version=1.1.1&request=GetCapabilities`;
            addDebugLog(`ğŸ” æµ‹è¯• WMS è¿æ¥: ${testUrl}`);
            
            fetch(testUrl)
                .then(response => {
                    if (response.ok) {
                        addDebugLog('âœ… WMS æœåŠ¡è¿æ¥æˆåŠŸ');
                        showStatus('WMS æœåŠ¡è¿æ¥æˆåŠŸï¼', 'success');
                        // è¿æ¥æˆåŠŸåæ·»åŠ å›¾å±‚
                        wmsLayer.addTo(map);
                        addDebugLog('âœ… WMS å›¾å±‚å·²æ·»åŠ åˆ°åœ°å›¾');
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                })
                .catch(error => {
                    addDebugLog(`âŒ WMS è¿æ¥å¤±è´¥: ${error.message}`);
                    showStatus(`WMS è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                    
                    // è¿æ¥å¤±è´¥æ—¶ä»ç„¶å°è¯•æ·»åŠ å›¾å±‚ï¼ˆå¯èƒ½æ˜¯CORSé—®é¢˜ï¼‰
                    addDebugLog('ğŸ”„ å°è¯•ç›´æ¥æ·»åŠ  WMS å›¾å±‚...');
                    wmsLayer.addTo(map);
                });
        }

        // æµ‹è¯•è¿æ¥
        testWMSConnection();
        
        // å›¾å±‚æ§åˆ¶
        const baseMaps = {
            "é«˜å¾·åœ°å›¾": baseLayer
        };
        
        const overlayMaps = {
            "WMS å›¾å±‚": wmsLayer
        };
        
        L.control.layers(baseMaps, overlayMaps).addTo(map);
        
        // æ§åˆ¶å…ƒç´ 
        const opacitySlider = document.getElementById('opacitySlider');
        const opacityValue = document.getElementById('opacityValue');
        const toggleButton = document.getElementById('toggleLayer');
        const fitBoundsButton = document.getElementById('fitBounds');
        const refreshButton = document.getElementById('refreshLayer');
        const featureInfoButton = document.getElementById('getFeatureInfo');
        const debugButton = document.getElementById('debugMode');
        
        // çŠ¶æ€å˜é‡
        let layerVisible = true;
        let featureInfoEnabled = false;
        
        // é€æ˜åº¦æ§åˆ¶
        opacitySlider.addEventListener('input', function() {
            const opacity = this.value / 100;
            wmsLayer.setOpacity(opacity);
            opacityValue.textContent = this.value + '%';
            addDebugLog(`ğŸšï¸ é€æ˜åº¦è®¾ç½®ä¸º: ${this.value}%`);
        });
        
        // å›¾å±‚æ˜¾ç¤º/éšè—
        toggleButton.addEventListener('click', function() {
            if (layerVisible) {
                map.removeLayer(wmsLayer);
                this.textContent = 'æ˜¾ç¤ºå›¾å±‚';
                layerVisible = false;
                addDebugLog('ğŸ‘ï¸ å›¾å±‚å·²éšè—');
            } else {
                wmsLayer.addTo(map);
                this.textContent = 'éšè—å›¾å±‚';
                layerVisible = true;
                addDebugLog('ğŸ‘ï¸ å›¾å±‚å·²æ˜¾ç¤º');
            }
        });
        
        // ç¼©æ”¾åˆ°å›¾å±‚èŒƒå›´
        fitBoundsButton.addEventListener('click', function() {
            // è®¾ç½®ä¸€ä¸ªä¸­å›½çš„å¤§è‡´èŒƒå›´
            const chinaBounds = [
                [18.16, 73.50],  // è¥¿å—è§’
                [53.55, 134.77]  // ä¸œåŒ—è§’
            ];
            map.fitBounds(chinaBounds);
            addDebugLog('ğŸ” ç¼©æ”¾åˆ°ä¸­å›½èŒƒå›´');
        });
        
        // åˆ·æ–°å›¾å±‚
        refreshButton.addEventListener('click', function() {
            addDebugLog('ğŸ”„ å¼€å§‹åˆ·æ–°å›¾å±‚...');
            if (layerVisible) {
                map.removeLayer(wmsLayer);
                
                // é‡æ–°åˆ›å»ºå›¾å±‚
                wmsLayer = L.tileLayer.wms(wmsUrl, {
                    layers: layerName,
                    format: 'image/png',
                    transparent: true,
                    version: '1.1.1',
                    crs: L.CRS.EPSG3857,
                    srs: 'EPSG:3857',
                    opacity: opacitySlider.value / 100,
                    attribution: 'GeoServer WMS',
                    tileSize: 256
                });
                
                wmsLayer.addTo(map);
                addDebugLog('âœ… å›¾å±‚åˆ·æ–°å®Œæˆ');
                showStatus('å›¾å±‚å·²åˆ·æ–°', 'success');
            }
        });
        
        // è°ƒè¯•æ¨¡å¼åˆ‡æ¢
        debugButton.addEventListener('click', function() {
            debugMode = !debugMode;
            const debugInfo = document.getElementById('debugInfo');
            
            if (debugMode) {
                this.textContent = 'å…³é—­è°ƒè¯•';
                this.style.background = '#28a745';
                debugInfo.style.display = 'block';
                document.getElementById('debugLog').innerHTML = debugLog.slice(-20).join('<br>');
                addDebugLog('ğŸ› è°ƒè¯•æ¨¡å¼å·²å¼€å¯');
            } else {
                this.textContent = 'è°ƒè¯•æ¨¡å¼';
                this.style.background = '#409EFF';
                debugInfo.style.display = 'none';
                addDebugLog('ğŸ› è°ƒè¯•æ¨¡å¼å·²å…³é—­');
            }
        });
        
        // è¦ç´ ä¿¡æ¯æŸ¥è¯¢
        featureInfoButton.addEventListener('click', function() {
            featureInfoEnabled = !featureInfoEnabled;
            if (featureInfoEnabled) {
                this.textContent = 'ç¦ç”¨è¦ç´ æŸ¥è¯¢';
                this.style.background = '#28a745';
                map.getContainer().style.cursor = 'crosshair';
                addDebugLog('ğŸ” è¦ç´ æŸ¥è¯¢å·²å¯ç”¨');
            } else {
                this.textContent = 'å¯ç”¨è¦ç´ æŸ¥è¯¢';
                this.style.background = '#409EFF';
                map.getContainer().style.cursor = '';
                addDebugLog('ğŸ” è¦ç´ æŸ¥è¯¢å·²ç¦ç”¨');
            }
        });
        
        // åœ°å›¾ç‚¹å‡»äº‹ä»¶ - GetFeatureInfo
        map.on('click', function(e) {
            if (!featureInfoEnabled || !layerVisible) return;
            
            const latlng = e.latlng;
            const point = map.latLngToContainerPoint(latlng);
            const size = map.getSize();
            const bounds = map.getBounds();
            
            addDebugLog(`ğŸ–±ï¸ ç‚¹å‡»ä½ç½®: ${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}`);
            
            // æ„å»º GetFeatureInfo è¯·æ±‚ - ä½¿ç”¨1.1.1ç‰ˆæœ¬çš„å‚æ•°
            const featureInfoUrl = wmsUrl + 
                '?SERVICE=WMS' +
                '&VERSION=1.1.1' +
                '&REQUEST=GetFeatureInfo' +
                '&LAYERS=' + encodeURIComponent(layerName) +
                '&QUERY_LAYERS=' + encodeURIComponent(layerName) +
                '&STYLES=' +
                '&BBOX=' + bounds.toBBoxString() +
                '&FEATURE_COUNT=5' +
                '&HEIGHT=' + size.y +
                '&WIDTH=' + size.x +
                '&FORMAT=image/png' +
                '&INFO_FORMAT=application/json' +
                '&SRS=EPSG:4326' +
                '&X=' + Math.round(point.x) +
                '&Y=' + Math.round(point.y);
            
            addDebugLog(`ğŸŒ GetFeatureInfo URL: ${featureInfoUrl}`);
            
            // å‘èµ·è¯·æ±‚
            fetch(featureInfoUrl)
                .then(response => {
                    addDebugLog(`ğŸ“¡ å“åº”çŠ¶æ€: ${response.status}`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    addDebugLog(`ğŸ“„ è¦ç´ ä¿¡æ¯å“åº”: ${JSON.stringify(data)}`);
                    if (data.features && data.features.length > 0) {
                        let popupContent = '<div><strong>è¦ç´ ä¿¡æ¯:</strong><br>';
                        data.features.forEach((feature, index) => {
                            popupContent += `<br><strong>è¦ç´  ${index + 1}:</strong><br>`;
                            Object.entries(feature.properties).forEach(([key, value]) => {
                                popupContent += `${key}: ${value}<br>`;
                            });
                        });
                        popupContent += '</div>';
                        
                        L.popup()
                            .setLatLng(latlng)
                            .setContent(popupContent)
                            .openOn(map);
                        
                        addDebugLog(`âœ… æ‰¾åˆ° ${data.features.length} ä¸ªè¦ç´ `);
                    } else {
                        L.popup()
                            .setLatLng(latlng)
                            .setContent('æ­¤ä½ç½®æ²¡æœ‰è¦ç´ ä¿¡æ¯')
                            .openOn(map);
                        addDebugLog('âš ï¸ æ²¡æœ‰æ‰¾åˆ°è¦ç´ ä¿¡æ¯');
                    }
                })
                .catch(error => {
                    addDebugLog(`âŒ GetFeatureInfo å¤±è´¥: ${error.message}`);
                    L.popup()
                        .setLatLng(latlng)
                        .setContent(`è·å–è¦ç´ ä¿¡æ¯å¤±è´¥: ${error.message}`)
                        .openOn(map);
                });
        });
        
        // æ›´æ–°åœ°å›¾ä¿¡æ¯
        function updateMapInfo() {
            document.getElementById('zoomLevel').textContent = map.getZoom();
            const center = map.getCenter();
            document.getElementById('mapCenter').textContent = 
                `${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`;
        }
        
        // ç›‘å¬åœ°å›¾äº‹ä»¶
        map.on('zoomend moveend', updateMapInfo);
        map.on('zoomend', function() {
            addDebugLog(`ğŸ” ç¼©æ”¾çº§åˆ«: ${map.getZoom()}`);
        });
        
        // ç›‘å¬ WMS å›¾å±‚äº‹ä»¶
        wmsLayer.on('tileerror', function(error) {
            addDebugLog(`âŒ WMS ç“¦ç‰‡åŠ è½½é”™è¯¯: ${JSON.stringify(error)}`);
            showStatus('âš ï¸ WMS å›¾å±‚åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ', 'error');
        });

        wmsLayer.on('tileload', function(e) {
            addDebugLog(`âœ… WMS ç“¦ç‰‡åŠ è½½æˆåŠŸ: ${e.url || 'æœªçŸ¥URL'}`);
        });

        wmsLayer.on('loading', function() {
            addDebugLog('â³ WMS å›¾å±‚å¼€å§‹åŠ è½½');
        });

        wmsLayer.on('load', function() {
            addDebugLog('âœ… WMS å›¾å±‚åŠ è½½å®Œæˆ');
            showStatus('WMS å›¾å±‚åŠ è½½æˆåŠŸï¼', 'success');
        });
        
        // åˆå§‹åŒ–ä¿¡æ¯æ˜¾ç¤º
        updateMapInfo();
        
        addDebugLog('ğŸ‰ é¡µé¢åˆå§‹åŒ–å®Œæˆ');
        
        // åœ¨é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥æœåŠ¡çŠ¶æ€
        setTimeout(() => {
            const capabilitiesUrl = `${wmsUrl}?service=WMS&version=1.1.1&request=GetCapabilities`;
            addDebugLog(`ğŸ” æ£€æŸ¥æœåŠ¡èƒ½åŠ›æ–‡æ¡£: ${capabilitiesUrl}`);
            document.getElementById('capabilitiesUrl').textContent = capabilitiesUrl;
        }, 1000);
    </script>
</body>
</html> 