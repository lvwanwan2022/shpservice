# 用户服务管理功能说明

## 概述

本功能允许每个用户在系统中管理自己的Geoserver和Martin服务实例，提供了完整的服务生命周期管理，包括创建、配置、启动、停止、监控和删除等操作。

## 主要特性

### 1. 用户独立性
- 每个用户拥有独立的服务配置空间
- 用户只能查看和管理自己的服务
- 服务间互不影响，安全隔离

### 2. 资源配额管理
- 基于用户类型的差异化配额（基础版/标准版/高级版）
- 动态端口分配，避免冲突
- 内存和存储空间限制
- 并发请求数控制

### 3. 服务类型支持
- **GeoServer服务**: 传统的地图服务发布
- **Martin服务**: 现代化的MVT瓦片服务

### 4. 完整的生命周期管理
- 服务创建和配置
- 启动/停止/重启控制
- 实时状态监控
- 操作日志记录
- 资源使用统计

## 系统架构

### 数据库设计

#### 核心表结构

1. **user_service_configs** - 用户服务配置表
   - 存储服务名称、类型、配置参数
   - 记录服务状态和运行信息
   - 支持自动启动和默认服务设置

2. **service_logs** - 服务操作日志表
   - 记录所有服务操作历史
   - 包含执行时间和错误详情
   - 支持按时间和操作类型查询

3. **system_resource_quotas** - 系统资源配额表
   - 定义用户资源使用限制
   - 支持配额类型和有效期管理
   - 动态配额调整

4. **service_port_allocations** - 服务端口分配表
   - 管理端口的分配和释放
   - 避免端口冲突
   - 支持端口预留

### API接口设计

#### 服务管理接口

```http
# 获取用户服务列表
GET /api/user-services?service_type=geoserver&status=running

# 创建新服务
POST /api/user-services
{
  "service_name": "my-geoserver",
  "service_type": "geoserver",
  "description": "我的地图服务",
  "config_data": {...}
}

# 启动服务
POST /api/user-services/{service_id}/start

# 停止服务
POST /api/user-services/{service_id}/stop

# 重启服务
POST /api/user-services/{service_id}/restart

# 获取服务状态
GET /api/user-services/{service_id}/status

# 获取服务日志
GET /api/user-services/{service_id}/logs?start_time=2024-01-01T00:00:00Z

# 获取资源使用情况
GET /api/user-services/resource-usage
```

## 前端功能

### 1. 服务管理主页面
- **资源使用概览**: 直观显示配额使用情况
- **服务列表**: 卡片式展示所有服务
- **过滤和搜索**: 按类型、状态筛选服务
- **批量操作**: 支持批量启动/停止

### 2. 服务创建向导
- **表单验证**: 实时验证服务名称和配置
- **模板选择**: 预设服务配置模板
- **配额检查**: 创建前检查资源限制

### 3. 服务监控面板
- **实时状态**: WebSocket实时更新服务状态
- **资源监控**: CPU、内存使用情况
- **日志查看**: 分页加载和实时日志流

### 4. 配置管理
- **可视化编辑**: 表单化的配置编辑界面
- **配置验证**: 保存前验证配置正确性
- **版本管理**: 配置变更历史记录

## 部署和配置

### 1. 数据库迁移

执行SQL脚本创建所需的表结构：

```bash
# 在PostgreSQL中执行
psql -U username -d database_name -f docs/用户服务管理_数据库操作.sql
```

或者通过Python脚本自动初始化：

```bash
cd backend
python models/db.py
```

### 2. 后端配置

确保后端已注册用户服务管理路由：

```python
# 在 backend/app.py 中已自动注册
from routes.user_service_routes import user_service_bp
app.register_blueprint(user_service_bp)
```

### 3. 前端配置

前端路由已自动配置：

```javascript
// 在 frontend/src/router/index.js 中
{
  path: '/service-manager',
  name: 'ServiceManager',
  component: () => import('@/views/ServiceManagerView.vue'),
  meta: { requiresAuth: true }
}
```

## 使用指南

### 1. 访问服务管理

登录系统后，点击导航栏中的"服务管理"即可进入服务管理页面。

### 2. 创建服务

1. 点击页面右上角的"新建服务"按钮
2. 填写服务名称和描述
3. 选择服务类型（GeoServer或Martin）
4. 配置服务参数
5. 点击"创建"完成服务创建

### 3. 管理服务

- **启动服务**: 点击服务卡片中的"启动"按钮
- **停止服务**: 点击服务卡片中的"停止"按钮
- **查看状态**: 点击"状态"按钮查看详细信息
- **查看日志**: 通过右上角菜单选择"查看日志"

### 4. 监控资源

页面顶部的"资源使用概览"卡片显示：
- 当前使用的服务数量
- 配额使用百分比
- 运行中的服务数量
- 用户配额类型

## 配额管理

### 配额类型

1. **基础版**:
   - GeoServer服务: 3个
   - Martin服务: 5个
   - 内存限制: 2GB
   - 存储限制: 10GB

2. **标准版**:
   - GeoServer服务: 3个
   - Martin服务: 5个
   - 内存限制: 2GB
   - 存储限制: 10GB

3. **高级版** (管理员):
   - GeoServer服务: 10个
   - Martin服务: 20个
   - 内存限制: 8GB
   - 存储限制: 50GB

### 配额调整

管理员可以通过直接修改数据库中的 `system_resource_quotas` 表来调整用户配额：

```sql
-- 升级用户到高级版
UPDATE system_resource_quotas 
SET quota_type = 'premium',
    max_geoserver_services = 10,
    max_martin_services = 20,
    max_memory_mb = 8192,
    max_storage_mb = 51200
WHERE user_id = {user_id} AND is_active = TRUE;
```

## 安全考虑

### 1. 用户隔离
- 每个用户只能访问自己的服务
- API接口包含用户权限验证
- 数据库层面的用户ID过滤

### 2. 端口管理
- 自动端口分配，避免冲突
- 端口回收机制
- 系统端口预留保护

### 3. 资源限制
- 严格的配额检查
- 并发请求限制
- 内存和存储监控

## 扩展和定制

### 1. 添加新的服务类型

1. 在数据库约束中添加新的服务类型：
   ```sql
   ALTER TABLE user_service_configs 
   DROP CONSTRAINT user_service_configs_service_type_check;
   
   ALTER TABLE user_service_configs 
   ADD CONSTRAINT user_service_configs_service_type_check 
   CHECK (service_type IN ('geoserver', 'martin', 'new_service_type'));
   ```

2. 在后端路由中添加相应的启动/停止逻辑

3. 在前端添加对应的UI支持

### 2. 自定义配额策略

可以通过修改 `system_resource_quotas` 表结构来支持更复杂的配额策略：

```sql
-- 添加新的配额字段
ALTER TABLE system_resource_quotas 
ADD COLUMN max_disk_iops INTEGER DEFAULT 1000,
ADD COLUMN max_network_bandwidth_mbps INTEGER DEFAULT 100;
```

### 3. 监控集成

可以集成Prometheus、Grafana等监控工具：

1. 在服务启动时注册监控端点
2. 收集服务运行指标
3. 配置告警规则

## 故障排除

### 1. 服务启动失败

**症状**: 服务状态显示为"错误"
**排查步骤**:
1. 检查服务日志中的错误信息
2. 确认端口是否被占用
3. 验证服务配置是否正确
4. 检查系统资源是否充足

### 2. 端口分配失败

**症状**: 创建服务时提示"端口分配失败"
**解决方案**:
1. 检查可用端口范围 (8081-65535)
2. 清理已释放但未回收的端口记录
3. 重启端口分配服务

### 3. 权限问题

**症状**: 用户无法查看或操作服务
**排查步骤**:
1. 确认用户已正确登录
2. 检查JWT token是否有效
3. 验证用户ID是否正确传递

## 性能优化

### 1. 数据库优化
- 定期清理旧的日志记录
- 优化查询索引
- 使用连接池

### 2. 缓存策略
- 服务状态缓存
- 用户配额信息缓存
- API响应缓存

### 3. 异步处理
- 服务启动/停止异步化
- 日志写入异步化
- 监控数据收集异步化

## 总结

用户服务管理功能为系统提供了完整的多租户服务管理能力，支持用户独立管理自己的GIS服务实例。通过合理的资源配额和安全机制，确保了系统的稳定性和安全性。

该功能具有良好的扩展性，可以方便地添加新的服务类型和监控功能，为构建企业级GIS服务平台提供了坚实的基础。 