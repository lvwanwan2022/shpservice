# 分布式服务连接系统

## 系统概述

分布式服务连接系统允许用户在本系统中添加和管理自己的外部Geoserver和Martin服务连接信息。用户可以通过这些连接将GIS数据发布到自己的服务器上，而不需要在系统服务器上创建服务实例，实现真正的分布式服务发布。

## 核心功能

### 🔗 服务连接管理
- **添加连接**：用户可以添加自己的Geoserver和Martin服务连接
- **连接测试**：自动测试服务连接的可用性和认证信息
- **连接编辑**：更新连接配置、认证信息等
- **连接状态**：实时显示连接状态和最后测试时间
- **默认连接**：为每种服务类型设置默认连接

### 🛠️ 支持的服务类型

#### GeoServer 连接
- **服务地址**：完整的GeoServer访问URL
- **管理员认证**：用户名和密码
- **默认工作空间**：用于发布数据的工作空间
- **连接测试**：通过REST API验证连接状态

#### Martin 连接
- **服务地址**：Martin MVT服务的访问URL
- **API认证**：可选的API密钥
- **数据库连接**：可选的PostGIS数据库URL
- **健康检查**：自动检测服务可用性

## 数据库结构

### 用户服务连接表 (user_service_connections)

```sql
CREATE TABLE user_service_connections (
    id BIGINT PRIMARY KEY,                          -- 连接ID
    user_id BIGINT NOT NULL,                        -- 用户ID
    service_name VARCHAR(100) NOT NULL,             -- 连接名称
    service_type VARCHAR(20) NOT NULL,              -- 服务类型 (geoserver/martin)
    server_url VARCHAR(500) NOT NULL,               -- 服务地址
    connection_config JSONB NOT NULL,               -- 连接配置 (认证信息等)
    description TEXT,                               -- 连接描述
    is_default BOOLEAN DEFAULT FALSE,               -- 是否为默认连接
    is_active BOOLEAN DEFAULT TRUE,                 -- 是否启用
    last_tested_at TIMESTAMP,                       -- 最后测试时间
    test_status VARCHAR(20) DEFAULT 'unknown',      -- 测试状态
    test_message TEXT,                              -- 测试结果信息
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, service_name, service_type)     -- 用户内连接名唯一
);
```

### 连接配置示例

#### GeoServer 连接配置
```json
{
    "server_url": "http://your-server:8080/geoserver",
    "username": "admin",
    "password": "your_password",
    "workspace": "your_workspace"
}
```

#### Martin 连接配置
```json
{
    "server_url": "http://your-server:3000",
    "api_key": "your_api_key",
    "database_url": "postgresql://user:password@host:5432/database"
}
```

## API 接口

### 连接管理接口

| 接口 | 方法 | 描述 |
|------|------|------|
| `/api/service-connections` | GET | 获取用户连接列表 |
| `/api/service-connections` | POST | 创建新连接 |
| `/api/service-connections/{id}` | PUT | 更新连接 |
| `/api/service-connections/{id}` | DELETE | 删除连接 |

### 连接测试接口

| 接口 | 方法 | 描述 |
|------|------|------|
| `/api/service-connections/test` | POST | 测试连接（表单中） |
| `/api/service-connections/{id}/test` | POST | 测试现有连接 |

### 工具接口

| 接口 | 方法 | 描述 |
|------|------|------|
| `/api/service-connections/defaults` | GET | 获取默认连接 |

## 前端页面功能

### 🎯 连接列表页面
- 显示所有用户连接
- 支持按服务类型过滤
- 显示连接状态和最后测试时间
- 提供快速操作按钮（测试、编辑、删除）

### ➕ 添加/编辑连接
- 动态表单：根据服务类型显示相应配置字段
- 实时连接测试：在保存前验证连接
- 表单验证：确保必填字段完整
- 敏感信息保护：密码和API密钥不回显

### 🔧 连接测试功能
- **GeoServer测试**：通过REST API获取工作空间列表
- **Martin测试**：通过健康检查或目录接口验证
- **结果显示**：实时反馈测试状态和详细信息
- **状态保存**：将测试结果保存到数据库

## 使用流程

### 1. 添加Geoserver连接
1. 点击"添加连接"按钮
2. 选择服务类型为"GeoServer"
3. 填写服务地址、管理员账号密码
4. 设置默认工作空间
5. 点击"测试连接"验证配置
6. 保存连接配置

### 2. 添加Martin连接
1. 点击"添加连接"按钮
2. 选择服务类型为"Martin"
3. 填写服务地址
4. 可选填写API密钥和数据库连接
5. 点击"测试连接"验证配置
6. 保存连接配置

### 3. 使用连接发布数据
1. 在数据发布页面选择目标服务
2. 系统自动使用对应的默认连接
3. 或手动选择特定的服务连接
4. 发布数据到用户自己的服务器

## 安全考虑

### 🔐 敏感信息保护
- 密码和API密钥在前端不显示明文
- 连接配置在数据库中加密存储
- API响应中敏感字段用***替代

### 🛡️ 访问控制
- 所有接口需要JWT认证
- 用户只能管理自己的连接
- 连接测试有超时和频率限制

### 🔍 安全审计
- 记录所有连接操作日志
- 跟踪连接测试频率
- 监控异常连接尝试

## 系统优势

### 🌍 分布式架构
- 用户数据发布到自己的服务器
- 减轻系统服务器负载
- 提供更好的数据隔离

### 🚀 性能优化
- 减少系统资源消耗
- 避免端口冲突问题
- 支持水平扩展

### 🛠️ 灵活配置
- 支持多个服务连接
- 可设置默认连接
- 动态启用/禁用连接

### 📊 实时监控
- 连接状态实时显示
- 自动健康检查
- 详细的测试反馈

## 扩展性

### 🔌 新服务类型支持
系统设计支持轻松添加新的服务类型：
1. 在数据库枚举中添加新类型
2. 实现对应的连接测试函数
3. 在前端添加相应的配置表单

### 🔗 集成能力
- 可与现有的数据管理模块集成
- 支持批量数据发布功能
- 提供API供第三方系统调用

## 故障排除

### 常见问题

#### 连接测试失败
1. 检查服务地址是否正确
2. 验证网络连通性
3. 确认认证信息无误
4. 检查服务是否正常运行

#### 保存连接失败
1. 检查连接名称是否重复
2. 验证必填字段是否完整
3. 确认用户权限正常

#### 发布数据失败
1. 确认目标连接状态正常
2. 检查工作空间是否存在
3. 验证数据格式兼容性

## 总结

分布式服务连接系统提供了一个简洁而强大的解决方案，让用户能够轻松管理自己的GIS服务连接，实现真正的分布式数据发布。系统专注于连接管理的核心功能，避免了复杂的服务生命周期管理，为用户提供了更大的灵活性和控制权。 