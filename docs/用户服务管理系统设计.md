# 用户服务管理系统设计文档

## 1. 概述

本文档描述了如何为每个用户提供独立的Geoserver和Martin服务管理功能。系统允许用户创建、配置和管理自己专属的GIS服务实例。

## 2. 系统架构

### 2.1 设计原则
- **用户隔离**：每个用户拥有独立的服务配置空间
- **资源管理**：系统级别管理服务器资源分配
- **安全控制**：用户只能管理自己的服务
- **可扩展性**：支持后续增加更多服务类型

### 2.2 核心功能
1. 用户服务配置管理
2. 服务实例状态监控
3. 资源配额控制
4. 服务日志查看
5. 批量操作支持

## 3. 数据库设计

### 3.1 新增表结构

#### 3.1.1 用户服务配置表 (user_service_configs)
存储每个用户的服务配置信息：

```sql
CREATE TABLE user_service_configs (
    id BIGINT PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id),
    service_name VARCHAR(100) NOT NULL,           -- 服务名称
    service_type VARCHAR(20) NOT NULL,            -- 'geoserver' 或 'martin'
    service_status VARCHAR(20) DEFAULT 'stopped', -- 'running', 'stopped', 'error'
    config_data JSONB NOT NULL,                   -- 服务配置参数
    port_number INTEGER,                          -- 分配的端口号
    resource_quota JSONB,                         -- 资源配额信息
    description TEXT,                             -- 服务描述
    is_default BOOLEAN DEFAULT FALSE,             -- 是否为默认服务
    auto_start BOOLEAN DEFAULT FALSE,             -- 是否自动启动
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_started_at TIMESTAMP,                    -- 最后启动时间
    last_stopped_at TIMESTAMP,                    -- 最后停止时间
    UNIQUE(user_id, service_name, service_type)   -- 用户内服务名唯一
);
```

#### 3.1.2 服务运行日志表 (service_logs)
记录服务运行状态和操作日志：

```sql
CREATE TABLE service_logs (
    id BIGINT PRIMARY KEY,
    service_config_id BIGINT NOT NULL REFERENCES user_service_configs(id),
    user_id BIGINT NOT NULL REFERENCES users(id),
    operation_type VARCHAR(50) NOT NULL,          -- 'start', 'stop', 'restart', 'config_update'
    operation_status VARCHAR(20) NOT NULL,        -- 'success', 'failed', 'pending'
    log_message TEXT,                             -- 日志详细信息
    error_details JSONB,                          -- 错误详情
    execution_time_ms INTEGER,                    -- 操作执行时间(毫秒)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.1.3 系统资源配额表 (system_resource_quotas)
管理系统级别的资源分配：

```sql
CREATE TABLE system_resource_quotas (
    id BIGINT PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id),
    max_geoserver_services INTEGER DEFAULT 3,     -- 最大Geoserver服务数
    max_martin_services INTEGER DEFAULT 5,        -- 最大Martin服务数
    max_memory_mb INTEGER DEFAULT 2048,           -- 最大内存(MB)
    max_storage_mb INTEGER DEFAULT 10240,         -- 最大存储(MB)
    concurrent_requests INTEGER DEFAULT 100,      -- 并发请求数
    quota_type VARCHAR(20) DEFAULT 'standard',    -- 'basic', 'standard', 'premium'
    effective_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expiry_date TIMESTAMP,                        -- 配额过期时间
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.2 索引设计

```sql
-- 用户服务配置表索引
CREATE INDEX idx_user_service_configs_user_id ON user_service_configs(user_id);
CREATE INDEX idx_user_service_configs_type_status ON user_service_configs(service_type, service_status);
CREATE INDEX idx_user_service_configs_port ON user_service_configs(port_number);

-- 服务日志表索引
CREATE INDEX idx_service_logs_service_config_id ON service_logs(service_config_id);
CREATE INDEX idx_service_logs_user_id ON service_logs(user_id);
CREATE INDEX idx_service_logs_created_at ON service_logs(created_at);
CREATE INDEX idx_service_logs_operation_type ON service_logs(operation_type);

-- 资源配额表索引
CREATE INDEX idx_system_resource_quotas_user_id ON system_resource_quotas(user_id);
CREATE INDEX idx_system_resource_quotas_active ON system_resource_quotas(is_active);
```

## 4. API接口设计

### 4.1 服务配置管理接口

#### 4.1.1 获取用户服务列表
```
GET /api/user-services
参数：
- service_type: 可选，过滤服务类型
- status: 可选，过滤状态
返回：用户的所有服务配置列表
```

#### 4.1.2 创建服务配置
```
POST /api/user-services
请求体：
{
    "service_name": "my-geoserver",
    "service_type": "geoserver",
    "config_data": {...},
    "description": "我的地图服务"
}
```

#### 4.1.3 更新服务配置
```
PUT /api/user-services/{service_id}
请求体：配置更新数据
```

#### 4.1.4 删除服务配置
```
DELETE /api/user-services/{service_id}
```

### 4.2 服务控制接口

#### 4.2.1 启动服务
```
POST /api/user-services/{service_id}/start
返回：启动结果和服务信息
```

#### 4.2.2 停止服务
```
POST /api/user-services/{service_id}/stop
```

#### 4.2.3 重启服务
```
POST /api/user-services/{service_id}/restart
```

#### 4.2.4 获取服务状态
```
GET /api/user-services/{service_id}/status
返回：实时服务状态信息
```

### 4.3 日志和监控接口

#### 4.3.1 获取服务日志
```
GET /api/user-services/{service_id}/logs
参数：
- start_time: 开始时间
- end_time: 结束时间
- operation_type: 操作类型
- limit: 返回数量限制
```

#### 4.3.2 获取资源使用情况
```
GET /api/user-services/resource-usage
返回：用户当前资源使用统计
```

## 5. 前端页面设计

### 5.1 服务管理主页面
- 服务列表展示（卡片或表格形式）
- 服务状态实时显示
- 快捷操作按钮（启动/停止/重启）
- 新建服务向导

### 5.2 服务配置页面
- 表单化配置界面
- 配置预览和验证
- 模板选择功能
- 配置导入/导出

### 5.3 监控和日志页面
- 资源使用图表
- 操作日志时间线
- 错误信息展示
- 性能指标监控

## 6. 实施步骤

### 阶段1：数据库准备
1. 执行数据库迁移SQL
2. 初始化默认配额
3. 数据迁移和验证

### 阶段2：后端开发
1. 实现服务配置API
2. 添加服务控制逻辑
3. 集成日志记录
4. 权限验证

### 阶段3：前端开发
1. 创建服务管理页面
2. 实现配置表单
3. 添加监控界面
4. 用户体验优化

### 阶段4：测试和部署
1. 功能测试
2. 性能测试
3. 安全测试
4. 生产部署

## 7. 注意事项

### 7.1 安全考虑
- 用户只能操作自己的服务
- 服务端口分配避免冲突
- 配置数据加密存储
- API访问频率限制

### 7.2 性能优化
- 服务状态缓存机制
- 异步操作处理
- 资源池管理
- 日志定期清理

### 7.3 容错处理
- 服务启动失败恢复
- 端口冲突自动处理
- 配置错误回滚机制
- 资源不足提示 