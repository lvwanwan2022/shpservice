# 底图切换图层顺序问题解决方案

## 问题描述

在 Leaflet 地图页面中，切换底图后，其他图层（如WMS图层、MVT图层等业务图层）显示顺序不正确，有时会被底图遮挡，需要手动刷新才能正常显示。

## 问题原因分析

### 根本原因
1. **图层z-index管理缺失**：切换底图时，新底图的z-index可能比业务图层高
2. **图层重新排序机制缺失**：没有在底图切换后重新整理图层显示顺序
3. **图层渲染时机问题**：底图加载完成后，业务图层没有及时更新显示状态

### 技术细节
- Leaflet中图层的显示顺序由z-index控制
- 默认情况下，后添加的图层会覆盖先添加的图层
- 底图切换时会移除旧底图并添加新底图，可能影响整体图层顺序

## 解决方案

### 1. 图层z-index分层管理

建立清晰的z-index分层体系：

```javascript
// z-index 分层规则
const Z_INDEX_LAYERS = {
  BASE_MAP: 0,           // 底图层：0
  MVT_LAYERS: 100,       // MVT图层：100-199
  WMS_LAYERS: 200,       // WMS图层：200-299
  UI_CONTROLS: 1000      // UI控件：1000+
}
```

### 2. 底图切换优化

在 `BaseMapSwitcherLF.vue` 中：

```javascript
const switchBaseMap = (command) => {
  // 1. 创建新底图并设置z-index为0
  const newLayer = createBaseMapLayer(command)
  newLayer.setZIndex(0)
  
  // 2. 添加到地图
  newLayer.addTo(props.map)
  
  // 3. 延迟刷新图层顺序
  setTimeout(() => {
    refreshLayerOrder()
  }, 200)
}
```

### 3. 业务图层z-index设置

#### MVT图层（Martin服务）
```javascript
// 在 addMartinLayer 中
if (rawLayer.setZIndex) {
  const zIndex = 100 + Object.keys(mvtLayers.value).length
  rawLayer.setZIndex(zIndex)
}
```

#### WMS图层（GeoServer服务）
```javascript
// 在 addGeoServerLayer 中
if (rawLayer.setZIndex) {
  const zIndex = 200 + Object.keys(mapLayers.value).length
  rawLayer.setZIndex(zIndex)
}
```

### 4. 图层顺序刷新机制

```javascript
const refreshLayersOrder = () => {
  // 重新设置所有图层的z-index
  let mvtIndex = 0
  let wmsIndex = 0
  
  // MVT图层：100-199
  Object.values(mvtLayers.value).forEach(mvtLayer => {
    if (mvtLayer && mvtLayer.setZIndex) {
      mvtLayer.setZIndex(100 + mvtIndex++)
    }
  })
  
  // WMS图层：200-299
  Object.values(mapLayers.value).forEach(wmsLayer => {
    if (wmsLayer && wmsLayer.setZIndex) {
      wmsLayer.setZIndex(200 + wmsIndex++)
    }
  })
  
  // 强制重新渲染
  map.value.invalidateSize()
}
```

### 5. 底图切换事件处理

```javascript
const onBaseMapChanged = (baseMapType) => {
  updateBaseMapAttribution(baseMapType)
  
  // 延迟刷新图层顺序，确保底图完全加载
  setTimeout(() => {
    refreshLayersOrder()
  }, 100)
}
```

## 实施细节

### 修改的文件

1. **BaseMapSwitcherLF.vue**
   - 添加底图z-index设置
   - 添加图层顺序刷新逻辑
   - 初始化底图时设置z-index

2. **MapViewerLF.vue**
   - 修改底图切换事件处理
   - 添加refreshLayersOrder函数
   - 优化addMartinLayer和addGeoServerLayer
   - 修改toggleLayerVisibility确保正确z-index

### z-index分配规则

| 图层类型 | z-index范围 | 说明 |
|---------|------------|------|
| 底图 | 0 | 始终在最底层 |
| MVT图层 | 100-199 | 矢量瓦片图层 |
| WMS图层 | 200-299 | 栅格WMS图层 |
| UI控件 | 1000+ | 地图控件和弹窗 |

### 时序控制

1. **底图切换**：立即设置新底图z-index为0
2. **延迟刷新**：200ms后刷新其他图层顺序
3. **图层添加**：新图层立即设置合适的z-index
4. **图层切换**：重新显示时重新计算z-index

## 性能优化

### 1. 避免频繁重排
- 使用setTimeout延迟执行，避免在底图切换过程中频繁操作
- 批量更新z-index，而不是逐个图层操作

### 2. 智能刷新
- 只在底图切换后刷新，平时不进行不必要的重排
- 仅对可见图层进行z-index设置

### 3. 错误处理
```javascript
try {
  if (rawLayer.setZIndex) {
    rawLayer.setZIndex(zIndex)
  }
} catch (error) {
  console.warn('设置图层z-index失败:', error)
}
```

## 测试验证

### 1. 功能测试
- [ ] 切换不同底图，检查业务图层是否始终可见
- [ ] 添加新图层后切换底图，验证图层顺序
- [ ] 切换图层显示/隐藏状态，确认顺序正确

### 2. 性能测试  
- [ ] 多图层场景下的底图切换流畅度
- [ ] 控制台无图层相关错误信息
- [ ] 内存使用稳定，无泄漏现象

### 3. 兼容性测试
- [ ] 不同底图类型（高德、OSM、Esri）的切换
- [ ] MVT和WMS图层的混合显示
- [ ] 移动端设备的显示效果

## 常见问题排查

### 1. 图层仍被遮挡
**检查项目**：
- 确认图层是否正确添加到地图
- 检查z-index是否正确设置
- 验证refreshLayersOrder是否被调用

### 2. 性能问题
**解决方案**：
- 减少setTimeout的使用频率
- 优化图层数量和复杂度
- 使用图层缓存机制

### 3. 控制台错误
**常见错误**：
- `Cannot read property 'setZIndex' of undefined`
- 解决：添加空值检查

## 总结

通过系统性的z-index分层管理和智能的图层顺序刷新机制，成功解决了底图切换后图层显示顺序混乱的问题。该方案具有以下特点：

1. **自动化**：无需用户手动刷新
2. **健壮性**：包含完整的错误处理
3. **高效性**：最小化性能影响
4. **可维护性**：清晰的分层规则和代码结构

实施后，用户在切换底图时将获得流畅、一致的图层显示体验。 